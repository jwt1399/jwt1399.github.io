<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Java-JVM, 简简,简简博客,网络安全,计算机,Java开发">
    <meta name="description" content="Java虚拟机（Java Virtual Machine 简称JVM）是运行所有Java程序的抽象计算机，是Java语言的运行环境，它是Java 最具吸引力的特性之一。">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Type" content="text/html;charset=gb2312" />
    <meta name="sogou_site_verification" content="VTcD33rrfd" />
    <meta name="google-site-verification" content="mHsYpjV9Rl0e0UzjioJFLg8RMtOhxw8HB3D21dIWvmc" />
	<meta name="referrer" content="unsafe-url">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="/assets/algolia/algoliasearchLite.min.js" async></script>
    <meta property="algolia:search" data-application-id="E9ZV23QUNX" data-api-key="091fe3a39a7bcb639aebaab3ed078165" data-index-name="hexo_search">
    <title>Java-JVM | 简言之</title>
    <link rel="icon" type="image/png" href="/favicon.png">
	<!--变灰-->
	<!-- <link href="http://static.isenyu.cn/file/css/MemorialDay.css"; rel="stylesheet" type="text/css" /> -->
    <!-- <style type="text/css">
     html{ filter: grayscale(100%); /* 标准写法 just for IE6-9 */ 
        -webkit-filter: grayscale(100%); /* webkit 内核支持程度较好 */ 
        -moz-filter: grayscale(100%); /* 其他内核现在并不支持，为了将来兼容性书写 */ 
        -ms-filter: grayscale(100%); 
        -o-filter: grayscale(100%); filter:progid:DXImageTransform.Microsoft.BasicImage(grayscale=1);
        filter: url("data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\'><filter id=\'grayscale\'><feColorMatrix type=\'matrix\' values=\'0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0\'/></filter></svg>#grayscale"); /* Firefox 3.5+ */ }
     </style> -->
     
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.staticfile.org/font-awesome/6.0.0/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.staticfile.org/aos/0.1.0/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>


    <script src="https://upcdn.b0.upaiyun.com/libs/jquery/jquery-2.0.3.min.js"></script>
	<!--valine_人机验证-->
	<script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
	<script src="/js/Valine-RJyanzheng.js"></script>

    
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="简言之" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img no-lazy src="/medias/logo.png" class="logo-img" alt="">
                    
                    <span class="logo-span">简言之</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>Home</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-user-secret" style="zoom: 0.6;"></i>
      
      <span>Sec</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/categories/Web/">
          
          <i class="fab fa-internet-explorer" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Web</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/CTF/">
          
          <i class="fas fa-flag" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>CTF</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/Data/">
          
          <i class="fa-solid fa-shield" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Data</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fa-solid fa-mug-hot" style="zoom: 0.6;"></i>
      
      <span>Java</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/categories/JavaSE/">
          
          <i class="fa-solid fa-mug-saucer" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>JavaSE</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/JavaWeb/">
          
          <i class="fa-solid fa-earth-americas" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>JavaWeb</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/Spring/">
          
          <i class="fa-solid fa-leaf" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Spring</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/Q-A/">
          
          <i class="fa-solid fa-bell" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Q&A</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fa-solid fa-desktop" style="zoom: 0.6;"></i>
      
      <span>CS</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/categories/CS%E5%9F%BA%E7%A1%80/">
          
          <i class="fa-solid fa-server" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>CS基础</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/SQL/">
          
          <i class="fas fa-database" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>数据库</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/%E7%BB%93%E6%9E%84-%E7%AE%97%E6%B3%95/">
          
          <i class="fa-solid fa-bezier-curve" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>结构-算法</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories/Share/" class="waves-effect waves-light">
      
      <i class="fa-solid fa-star" style="zoom: 0.6;"></i>
      
      <span>Share</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-layer-group" style="zoom: 0.6;"></i>
      
      <span>Others</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/categories/Python/">
          
          <i class="fab fa-python" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Python</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/Course/">
          
          <i class="fa-solid fa-graduation-cap" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Course</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/Tools/">
          
          <i class="fas fa-tools" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>Tools~</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fa-solid fa-paper-plane" style="zoom: 0.6;"></i>
      
      <span>交流</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/friends/">
          
          <i class="fas fa-venus-mars" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>友链</span>
        </a>
      </li>
      
      <li>
        <a href="/contact/">
          
          <i class="fas fa-envelope" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>留言</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about/" class="waves-effect waves-light">
      
      <i class="fas fa-id-card-alt" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
    <!-- <div id="docsearch"></div> -->
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img no-lazy src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">简言之</div>
        <div class="logo-desc">
            
            悄无声息地变坚强，安静地变优秀！
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			Home
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-user-secret"></i>
			
			Sec
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="/categories/Web/ " style="margin-left:50px";>
				  
				   <i class="fab fa-internet-explorer" style="position: absolute;left:28px" ></i>
			      
		          <span>Web</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/CTF/ " style="margin-left:50px";>
				  
				   <i class="fas fa-flag" style="position: absolute;left:28px" ></i>
			      
		          <span>CTF</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Data/ " style="margin-left:50px";>
				  
				   <i class="fa-solid fa-shield" style="position: absolute;left:28px" ></i>
			      
		          <span>Data</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fa-solid fa-mug-hot"></i>
			
			Java
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="/categories/JavaSE/ " style="margin-left:50px";>
				  
				   <i class="fa-solid fa-mug-saucer" style="position: absolute;left:28px" ></i>
			      
		          <span>JavaSE</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/JavaWeb/ " style="margin-left:50px";>
				  
				   <i class="fa-solid fa-earth-americas" style="position: absolute;left:28px" ></i>
			      
		          <span>JavaWeb</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Spring/ " style="margin-left:50px";>
				  
				   <i class="fa-solid fa-leaf" style="position: absolute;left:28px" ></i>
			      
		          <span>Spring</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Q-A/ " style="margin-left:50px";>
				  
				   <i class="fa-solid fa-bell" style="position: absolute;left:28px" ></i>
			      
		          <span>Q&A</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fa-solid fa-desktop"></i>
			
			CS
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="/categories/CS%E5%9F%BA%E7%A1%80/ " style="margin-left:50px";>
				  
				   <i class="fa-solid fa-server" style="position: absolute;left:28px" ></i>
			      
		          <span>CS基础</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/SQL/ " style="margin-left:50px";>
				  
				   <i class="fas fa-database" style="position: absolute;left:28px" ></i>
			      
		          <span>数据库</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/%E7%BB%93%E6%9E%84-%E7%AE%97%E6%B3%95/ " style="margin-left:50px";>
				  
				   <i class="fa-solid fa-bezier-curve" style="position: absolute;left:28px" ></i>
			      
		          <span>结构-算法</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/Share/" class="waves-effect waves-light">
			
			    <i class="fa-fw fa-solid fa-star"></i>
			
			Share
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-layer-group"></i>
			
			Others
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="/categories/Python/ " style="margin-left:50px";>
				  
				   <i class="fab fa-python" style="position: absolute;left:28px" ></i>
			      
		          <span>Python</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Course/ " style="margin-left:50px";>
				  
				   <i class="fa-solid fa-graduation-cap" style="position: absolute;left:28px" ></i>
			      
		          <span>Course</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/categories/Tools/ " style="margin-left:50px";>
				  
				   <i class="fas fa-tools" style="position: absolute;left:28px" ></i>
			      
		          <span>Tools~</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fa-solid fa-paper-plane"></i>
			
			交流
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>   
				
                  <a href="/friends/ " style="margin-left:50px";>
				  
				   <i class="fas fa-venus-mars" style="position: absolute;left:28px" ></i>
			      
		          <span>友链</span>
                  </a>
                </li>
              
                <li>   
				
                  <a href="/contact/ " style="margin-left:50px";>
				  
				   <i class="fas fa-envelope" style="position: absolute;left:28px" ></i>
			      
		          <span>留言</span>
                  </a>
                </li>
               
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-id-card-alt"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('猜猜密码是什么呢ヾﾉ≧∀≦)o')).toString(CryptoJS.enc.Hex)) {
                alert('哎呦！密码好像不对哟，将返回主页！');
                location.href = '/';	
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://img.jwt1399.top/img/202212022124200.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Java-JVM</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    /*.toc-widget {
        width: 345px;
        padding-left: 20px;
    }*/
    .toc-widget {
        width: 345px;
        padding-left: 20px;
        /* 毛玻璃 */
        /*background-color: rgba(162,101,228, 0.08);*/
        /*backdrop-filter: saturate(180%) blur(20px);*/
        /*目录样式修改*/
        background-color: rgb(255, 255, 255,0.7);
        border-radius: 10px;
        box-shadow: 0 10px 35px 2px rgba(0, 0, 0, .15), 0 5px 15px rgba(0, 0, 0, .07), 0 2px 5px -5px rgba(0, 0, 0, .1) !important;
    }
    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/JVM/">
                                <span class="chip bg-color">JVM</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/JavaSE/" class="post-category">
                                JavaSE
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-12-02
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-01-20
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    52.2k
                </div>
                

                
				
                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
            
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="①JVM概述"><a href="#①JVM概述" class="headerlink" title="①JVM概述"></a>①JVM概述</h1><h2 id="❶基本介绍"><a href="#❶基本介绍" class="headerlink" title="❶基本介绍"></a>❶基本介绍</h2><p>JVM：全称 Java Virtual Machine，一个虚拟计算机，Java 程序的运行环境（Java二进制字节码的运行环境）</p>
<p>特点：</p>
<ul>
<li>Java 虚拟机基于<strong>二进制字节码</strong>执行，由一套字节码指令集、一组寄存器、一个栈、一个垃圾回收堆、一个方法区等组成</li>
<li>JVM 屏蔽了与操作系统平台相关的信息，从而能够让 Java 程序只需要生成能够在 JVM 上运行的字节码文件，通过该机制实现的<strong>跨平台性</strong>。即一次编译，处处执行</li>
<li>自动的内存管理，垃圾回收机制</li>
</ul>
<p>JVM 结构：</p>
<p><img src="https://img.jwt1399.top/img/202212031705537.png"></p>
<img src="https://img.jwt1399.top/img/202212202200355.png" alt="image-20221220215946131" style="zoom: 50%;" />

<p>Java 代码执行流程：<code>Java 程序(.java) --（编译）--&gt; 字节码文件(.class)--（解释执行/JIT）--&gt; 操作系统（Win，Linux）</code></p>
<table>
<thead>
<tr>
<th><img src="https://img.jwt1399.top/img/202212031714323.png"></th>
<th><img src="https://img.jwt1399.top/img/202212031714094"></th>
</tr>
</thead>
</table>
<p>JVM、JRE、JDK 对比：</p>
<ul>
<li>JDK(Java SE Development Kit)：Java 标准开发包，提供了编译、运行 Java 程序所需的各种工具和资源</li>
<li>JRE( Java Runtime Environment)：Java 运行环境，用于解释执行 Java 的字节码文件</li>
</ul>
<img src="https://img.jwt1399.top/img/202212031706253.png" />

<hr>
<h2 id="❷架构模型"><a href="#❷架构模型" class="headerlink" title="❷架构模型"></a>❷架构模型</h2><p>Java 编译器输入的指令流是一种基于栈的指令集架构。因为跨平台的设计，Java 的指令都是根据栈来设计的，不同平台 CPU 架构不同，所以不能设计为基于寄存器架构</p>
<ul>
<li>基于栈式架构的特点：<ul>
<li>设计和实现简单，适用于资源受限的系统</li>
<li>使用零地址指令方式分配，执行过程依赖操作栈，指令集更小，编译器容易实现<ul>
<li>零地址指令：机器指令的一种，是指令系统中的一种不设地址字段的指令，只有操作码而没有地址码。这种指令有两种情况：一是无需操作数，另一种是操作数为默认的（隐含的），默认为操作数在寄存器（ACC）中，指令可直接访问寄存器</li>
<li>一地址指令：一个操作码对应一个地址码，通过地址码寻找操作数</li>
</ul>
</li>
<li>不需要硬件的支持，可移植性更好，更好实现跨平台</li>
</ul>
</li>
<li>基于寄存器架构的特点：<ul>
<li>需要硬件的支持，可移植性差</li>
<li>性能更好，执行更高效，寄存器比内存快</li>
<li>以一地址指令、二地址指令、三地址指令为主，而基于栈式架构的指令集却是以零地址指令为主</li>
</ul>
</li>
</ul>
<hr>
<h2 id="❸生命周期"><a href="#❸生命周期" class="headerlink" title="❸生命周期"></a>❸生命周期</h2><p>JVM 的生命周期分为三个阶段，分别为：启动、运行、死亡</p>
<ul>
<li><p><strong>启动</strong>：当启动一个 Java 程序时，通过引导类加载器（bootstrap class loader）创建一个初始类（initial class），对于拥有 main 函数的类就是 JVM 实例运行的起点</p>
</li>
<li><p><strong>运行</strong>：</p>
<ul>
<li><p>main() 方法是一个程序的初始起点，任何线程均可由在此处启动</p>
</li>
<li><p>在 JVM 内部有两种线程类型，分别为：用户线程和守护线程，<strong>JVM 使用的是守护线程，main() 和其他线程使用的是用户线程</strong>，守护线程会随着用户线程的结束而结束</p>
</li>
<li><p>执行一个 Java 程序时，真真正正在执行的是一个 <strong>Java 虚拟机的进程</strong></p>
</li>
<li><p>JVM 有两种运行模式 Server 与 Client，两种模式的区别在于：Client 模式启动速度较快，Server 模式启动较慢；但是启动进入稳定期长期运行之后 Server 模式的程序运行速度比 Client 要快很多</p>
<p>Server 模式启动的 JVM 采用的是重量级的虚拟机，对程序采用了更多的优化；Client 模式启动的 JVM 采用的是轻量级的虚拟机</p>
</li>
</ul>
</li>
<li><p><strong>死亡</strong>：</p>
<ul>
<li>当程序中的用户线程都中止，JVM 才会退出</li>
<li>程序正常执行结束、程序异常或错误而异常终止、操作系统错误导致终止</li>
<li>线程调用 Runtime 类 halt 方法或 System 类 exit 方法，并且 Java 安全管理器允许这次 exit 或 halt 操作</li>
</ul>
</li>
</ul>
<h1 id="②内存结构"><a href="#②内存结构" class="headerlink" title="②内存结构"></a>②内存结构</h1><h2 id="❶JVM内存"><a href="#❶JVM内存" class="headerlink" title="❶JVM内存"></a>❶JVM内存</h2><h3 id="0-内存概述"><a href="#0-内存概述" class="headerlink" title="0.内存概述"></a>0.内存概述</h3><p><strong>内存结构</strong>是 JVM 中非常重要的一部分，是非常重要的系统资源，是硬盘和 CPU 的桥梁，承载着操作系统和应用程序的实时运行，又叫<strong>运行时数据区</strong>。</p>
<p>JVM 内存结构规定了 Java 在运行过程中内存申请、分配、管理的策略，保证了 JVM 的高效稳定运行</p>
<ul>
<li>Java1.8 以前的内存结构图：</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212051655611.png"></p>
<ul>
<li>Java1.8 之后的内存结果图：</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212042053847.png"></p>
<h3 id="1-程序计数器"><a href="#1-程序计数器" class="headerlink" title="1.程序计数器"></a>1.程序计数器</h3><blockquote>
<p>Program Counter Register 程序计数器（寄存器）</p>
</blockquote>
<p>作用：内部保存字节码的行号，用于记录正在执行的字节码指令地址（如果正在执行的是本地方法则为空）</p>
<p>原理：</p>
<ul>
<li>JVM 对于多线程是通过线程轮流切换并且分配线程执行时间，一个处理器只会处理执行一个线程</li>
<li>切换线程需要从程序计数器中来回切换到当前的线程上一次执行的行号</li>
</ul>
<p>特点：</p>
<ul>
<li>是线程私有的</li>
<li><strong>不会存在内存溢出</strong>，是 JVM 规范中唯一一个不出现 OOM 的区域，所以这个空间不会进行 GC</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212051416292.png"></p>
<h3 id="2-虚拟机栈"><a href="#2-虚拟机栈" class="headerlink" title="2.虚拟机栈"></a>2.虚拟机栈</h3><blockquote>
<p>Java 虚拟机栈：Java Virtual Machine Stacks，<strong>每个线程</strong>运行时所需要的<strong>内存</strong></p>
<p>异常：<code>java.lang.StackOverflowError</code></p>
</blockquote>
<p><img src="https://img.jwt1399.top/img/202212042241637.png"></p>
<ul>
<li><p>每个方法被执行时，都会在虚拟机栈中创建一个栈帧 stack frame（<strong>一个方法一个栈帧</strong>）</p>
</li>
<li><p>Java 虚拟机规范允许 <strong>Java 栈的大小是动态的或者是固定不变的</strong></p>
</li>
<li><p>虚拟机栈是<strong>每个线程私有的</strong>，每个线程只能有一个活动栈帧，对应方法调用到执行完成的整个过程</p>
</li>
<li><p><strong>每个栈由多个栈帧（Frame）组成</strong>，对应着每次方法调用时所占用的内存，每个栈帧中存储着：</p>
<ul>
<li>局部变量表：存储方法里的 Java 基本数据类型以及对象的引用（reference 类型）</li>
<li>动态链接：也叫指向运行时常量池的方法引用</li>
<li>方法返回地址：方法正常退出或者异常退出的定义</li>
<li>操作数栈或表达式栈和其他一些附加信息</li>
</ul>
</li>
</ul>
<p>设置栈内存大小：<code>-Xss size</code>   <code>-Xss 1024k</code>（在 VM options 中设置）</p>
<ul>
<li>在 JDK 1.4 中默认为 256K，而在 JDK 1.5+ 默认为 1M</li>
</ul>
<p>虚拟机栈特点：</p>
<ul>
<li><p>栈内存<strong>不需要进行GC</strong>，方法开始执行的时候会进栈，方法调用后自动弹栈，相当于清空了数据</p>
</li>
<li><p>栈内存分配越大，可用的线程数越少（内存越大，每个线程拥有的内存越大）</p>
</li>
<li><p>方法内的局部变量是否<strong>线程安全</strong>：</p>
<ul>
<li>如果方法内局部变量没有逃离方法的作用访问，它是线程安全的（逃逸分析）</li>
<li>如果是局部变量引用了对象，并逃离方法的作用范围，需要考虑线程安全</li>
</ul>
</li>
</ul>
<p>异常：</p>
<ul>
<li>栈帧过多导致栈内存溢出 （超过了栈的容量），会抛出 OutOfMemoryError 异常</li>
<li>当线程请求的栈深度超过虚拟机允许的最大深度时，会抛出 StackOverflowError 异常</li>
</ul>
<p>线程运行诊断：</p>
<ul>
<li>定位：<ul>
<li>jps 定位进程 ID</li>
<li>top定位哪个进程对cpu的占用过高</li>
<li>ps  -eo pid,%cpu | grep 进程id （用ps命令进一步定位是哪个线程引起的cpu占用过高）</li>
</ul>
</li>
<li>jstack 进程 ID：用于打印出给定的 Java 进程 ID 或 core file 或远程调试服务的 Java 堆栈信息</li>
</ul>
<h3 id="3-本地方法栈"><a href="#3-本地方法栈" class="headerlink" title="3.本地方法栈"></a>3.本地方法栈</h3><blockquote>
<p>本地方法栈：Native Method Stacks， 为虚拟机执行本地方法（native方法）时提供服务的</p>
</blockquote>
<ul>
<li>本地方法一般是由其他语言编写（C&#x2F;C++），并且被编译为基于本机硬件和操作系统的程序</li>
<li>与虚拟机栈类似，不需要进行 GC，也是线程私有的，有 StackOverFlowError 和 OutOfMemoryError 异常</li>
<li>本地方法用 <code>native</code> 关键字修饰，例如：Object类中的wait()、clone()、hashCode等</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token keyword">native</span> Object <span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>当某个线程调用一个本地方法时，就进入了不再受虚拟机限制的世界，和虚拟机拥有同样的权限</p>
<ul>
<li>本地方法可以通过本地方法接口（JNI：Java Native Interface）来<strong>访问虚拟机内部的运行时数据区</strong></li>
<li>直接从本地内存的堆中分配任意数量的内存</li>
<li>可以直接使用本地处理器中的寄存器</li>
</ul>
<h3 id="4-堆"><a href="#4-堆" class="headerlink" title="4.堆"></a>4.堆</h3><h4 id="堆概述"><a href="#堆概述" class="headerlink" title="堆概述"></a>堆概述</h4><blockquote>
<p>堆：Heap ，是 JVM 内存中最大的一块，由所有<strong>线程共享</strong>，由<strong>垃圾回收器</strong>管理的主要区域，堆中对象大部分都需要考虑<strong>线程安全</strong>的问题</p>
<p>异常：java.lang.OutOfMemoryError：java heap space</p>
</blockquote>
<p><img src="https://img.jwt1399.top/img/202212051449758.png"></p>
<p>存放哪些资源：</p>
<ul>
<li><strong>对象实例</strong>：new 创建的对象，类初始化生成的对象，<strong>基本数据类型的数组也是对象实例</strong>(new 创建)</li>
<li><strong>字符串常量池</strong> StringTable&#x2F;String Pool： JVM 为了提升性能和减少内存消耗针对字符串（String 类）专门开辟的一块区域，主要目的是为了避免字符串的重复创建。<ul>
<li>字符串常量池原本存放于方法区，JDK7 开始放置于堆中</li>
<li>字符串常量池<strong>存储的是 String 对象的直接引用或者对象</strong>，是一张 <strong>stringTable</strong></li>
<li>在jdk 7之后，原先位于方法区里的字符串常量池已被移动到了java堆中。</li>
</ul>
</li>
<li><strong>静态变量</strong>：静态变量是有 static 修饰的变量，JDK8 时从方法区迁移至堆中</li>
<li><strong>线程分配缓冲区</strong> Thread Local Allocation Buffer：线程私有但不影响堆的共性，可以提升对象分配的效率</li>
</ul>
<p>内存溢出：new 出对象，循环添加字符数据，当堆中没有内存空间可分配给实例，也无法再扩展时，就会抛出 OutOfMemoryError 异常</p>
<p>设置堆内存指令：<code>-Xmx Size</code></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 演示堆内存溢出 java.lang.OutOfMemoryError: Java heap space
 * -Xmx8m
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_5</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            List<span class="token operator">&lt;</span>String<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String a <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// hello, hellohello, hellohellohellohello ...</span>
                a <span class="token operator">=</span> a <span class="token operator">+</span> a<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// hellohellohellohello</span>
                i<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="堆内存诊断工具"><a href="#堆内存诊断工具" class="headerlink" title="堆内存诊断工具"></a>堆内存诊断工具</h4><ol>
<li>jps：查看当前系统中有哪些 Java 进程</li>
<li>jmap：查看某一时刻堆内存占用情况  <code>jhsdb jmap --heap --pid 进程id</code></li>
<li>jconsole：图形界面的，多功能的监测工具，可以连续监测</li>
<li>jvisualvm：图形界面的，多功能的监测工具，可以连续监测</li>
</ol>
<h4 id="Java7-x2F-8堆变化"><a href="#Java7-x2F-8堆变化" class="headerlink" title="Java7&#x2F;8堆变化"></a>Java7&#x2F;8堆变化</h4><img src="https://img.jwt1399.top/img/202212051751417.png" style="zoom:50%;" />

<p>在 Java7 中堆内会存在<strong>年轻代、老年代和方法区（永久代）</strong>，Java8 永久代被<strong>元空间</strong>代替了</p>
<ul>
<li>Young 区被划分为三部分，Eden 区和两个大小严格相同的 Survivor 区。Survivor 区某一时刻只有其中一个是被使用的，另外一个留做垃圾回收时复制对象。在 Eden 区变满的时候，GC 就会将存活的对象移到空闲的 Survivor 区间中，根据 JVM 的策略，在经过几次垃圾回收后，仍然存活于 Survivor 的对象将被移动到 Tenured 区间</li>
<li>Old 区主要保存生命周期长的对象，一般是一些老的对象，当一些对象在 Young 复制转移一定的次数以后，对象就会被转移到 Tenured 区</li>
<li>Perm 代主要保存 Class、ClassLoader、静态变量、常量、编译后的代码，在 Java7 中堆内方法区会受到 GC 的管理</li>
</ul>
<p>分代原因：不同对象的生命周期不同，70%-99% 的对象都是临时对象，优化 GC 性能</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 返回Java虚拟机中的堆内存总量</span>
    <span class="token keyword">long</span> initialMemory <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">totalMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 返回Java虚拟机使用的最大堆内存量</span>
    <span class="token keyword">long</span> maxMemory <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">maxMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-Xms : "</span> <span class="token operator">+</span> initialMemory <span class="token operator">+</span> <span class="token string">"M"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//-Xms : 245M</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-Xmx : "</span> <span class="token operator">+</span> maxMemory <span class="token operator">+</span> <span class="token string">"M"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//-Xmx : 3641M</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="StringTable-x2F-String-Pool"><a href="#StringTable-x2F-String-Pool" class="headerlink" title="StringTable&#x2F;String Pool"></a>StringTable&#x2F;String Pool</h4><blockquote>
<p>字符串常量池（String Pool &#x2F; StringTable &#x2F; 串池）存储的是 String 对象的直接引用或者对象，即保存着所有字符串字面量（literal strings），这些字面量在编译时期就确定，字符串常量池类似于 Java 系统级别提供的<strong>缓存</strong>，存放对象和引用</p>
<p>StringTable，类似 HashTable 结构，通过 <code>-XX:StringTableSize</code> 设置大小，JDK 1.8 中默认 60013</p>
</blockquote>
<h5 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h5><ul>
<li>常量池中的字符串仅是符号，第一次使用时才变为对象(加入到运行时常量池),可以避免重复创建字符串对象</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 字符串常量池(StringTable): [ "a", "b" ,"ab" ]  hashtable 结构，不能扩容</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  String s1 <span class="token operator">=</span> <span class="token string">"a"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 懒惰的</span>
  String s2 <span class="token operator">=</span> <span class="token string">"b"</span><span class="token punctuation">;</span>
  String s3 <span class="token operator">=</span> <span class="token string">"ab"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>字节码：Java 反编译指令<code>javap -v 文件名.class</code></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//常量池</span>
<span class="token comment" spellcheck="true">// 常量池中的信息，都会被加载到运行时常量池中， </span>
<span class="token comment" spellcheck="true">// 这时 a b ab 都是常量池中的符号，还没有变为 java 字符串对象，是懒惰的</span>
Constant pool<span class="token operator">:</span> 
   #<span class="token number">1</span> <span class="token operator">=</span> Methodref          #<span class="token number">12</span><span class="token punctuation">.</span>#<span class="token number">36</span>        <span class="token comment" spellcheck="true">// java/lang/Object."&lt;init>":()V</span>
   #<span class="token number">2</span> <span class="token operator">=</span> String             #<span class="token number">37</span>            <span class="token comment" spellcheck="true">// a</span>
   #<span class="token number">3</span> <span class="token operator">=</span> String             #<span class="token number">38</span>            <span class="token comment" spellcheck="true">// b</span>
   #<span class="token number">4</span> <span class="token operator">=</span> String             #<span class="token number">39</span>            <span class="token comment" spellcheck="true">// ab</span>


<span class="token comment" spellcheck="true">//运行代码       </span>
 <span class="token number">0</span><span class="token operator">:</span> ldc           #<span class="token number">2</span>                  <span class="token comment" spellcheck="true">// String a</span>
 <span class="token number">2</span><span class="token operator">:</span> astore_1 <span class="token comment" spellcheck="true">//存入局部变量表slot 1号位</span>
 <span class="token number">3</span><span class="token operator">:</span> ldc           #<span class="token number">3</span>                  <span class="token comment" spellcheck="true">// String b</span>
 <span class="token number">5</span><span class="token operator">:</span> astore_2
 <span class="token number">6</span><span class="token operator">:</span> ldc           #<span class="token number">4</span>                  <span class="token comment" spellcheck="true">// String ab</span>
 <span class="token number">8</span><span class="token operator">:</span> astore_3
   
<span class="token comment" spellcheck="true">// ldc #2 会把 a 符号变为 "a" 字符串对象，StringTable: ["a"] </span>
<span class="token comment" spellcheck="true">// ldc #3 会把 b 符号变为 "b" 字符串对象，StringTable: ["a", "b"] </span>
<span class="token comment" spellcheck="true">// ldc #4 会把 ab 符号变为 "ab" 字符串对象，StringTable: ["a", "b" ,"ab"]    </span>
   
       
<span class="token comment" spellcheck="true">//局部变量表(栈)  </span>
LocalVariableTable<span class="token operator">:</span>  
        Start  Length  Slot  Name   Signature
            <span class="token number">0</span>      <span class="token number">51</span>     <span class="token number">0</span>  args   <span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span>
            <span class="token number">3</span>      <span class="token number">48</span>     <span class="token number">1</span>    s1   Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span>
            <span class="token number">6</span>      <span class="token number">45</span>     <span class="token number">2</span>    s2   Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span>
            <span class="token number">9</span>      <span class="token number">42</span>     <span class="token number">3</span>    s3   Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>字符串<strong>变量</strong>的拼接的原理是 StringBuilder#append，append 方法比字符串拼接效率高（JDK 1.8）</li>
<li>字符串<strong>常量</strong>拼接的原理是编译期优化，拼接结果放入常量池</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 字符串常量池(StringTable): [ "a", "b" ,"ab" ]  hashtable 结构，不能扩容</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  String s1 <span class="token operator">=</span> <span class="token string">"a"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 懒惰的</span>
  String s2 <span class="token operator">=</span> <span class="token string">"b"</span><span class="token punctuation">;</span>
  String s3 <span class="token operator">=</span> <span class="token string">"ab"</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// new StringBuilder().append("a").append("b").toString() -->  new String("ab")  堆中</span>
  String s4 <span class="token operator">=</span> s1 <span class="token operator">+</span> s2<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//字符串变量   // 返回的是堆内地址</span>
  <span class="token comment" spellcheck="true">// javac 在编译期间的优化，结果已经在编译期确定为ab</span>
  String s5 <span class="token operator">=</span> <span class="token string">"a"</span> <span class="token operator">+</span> <span class="token string">"b"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//字符串常量</span>
  
  System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s3 <span class="token operator">==</span> s4<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// F</span>
  System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s3 <span class="token operator">==</span> s5<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// T</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="intern"><a href="#intern" class="headerlink" title="intern()"></a>intern()</h5><p>JDK 1.8：将这个字符串对象尝试放入串池，如果 String Pool 中：</p>
<ul>
<li>存在一个字符串和该字符串值相等，就会返回 String Pool 中字符串的引用（需要变量接收）</li>
<li>不存在，会把对象的<strong>引用地址</strong>复制一份放入串池，并返回串池中的引用地址，前提是堆内存有该对象，因为 Pool 在堆中，为了节省内存不再创建新对象</li>
</ul>
<p>JDK 1.6：将这个字符串对象尝试放入串池，如果 String Pool 中：</p>
<ul>
<li>如果有就不放入，返回已有的串池中的对象的引用；</li>
<li>如果没有会把此对象复制一份，放入串池，把串池中的对象返回</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// StringTable: ["ab", "a", "b"]</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  String x <span class="token operator">=</span> <span class="token string">"ab"</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// StringTable: ["ab"]</span>
  
  <span class="token comment" spellcheck="true">// 堆  new String("a")   new String("b")  new StringBuilder()  new String("ab")</span>
  <span class="token comment" spellcheck="true">// StringTable: ["ab", "a", "b"]</span>
  String s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// s只存在堆中，不存在StringTable</span>

  <span class="token comment" spellcheck="true">// 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</span>
  String s2 <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

  System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// F</span>
  System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s2 <span class="token operator">==</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// T</span>
  
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>&#x3D;&#x3D; 比较基本数据类型：比较的是具体的值</li>
<li>&#x3D;&#x3D; 比较引用数据类型：比较的是对象地址值</li>
</ul>
<p>结论：</p>
<pre class="line-numbers language-java"><code class="language-java">String s1 <span class="token operator">=</span> <span class="token string">"ab"</span><span class="token punctuation">;</span>								<span class="token comment" spellcheck="true">// ab仅放入串池  StringTable: ["ab"]</span>

String s2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">// ab仅放入堆  StringTable: ["a","b"]</span>

String s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"ab"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ab串池和堆都存在 StringTable: ["ab"]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr>
<h5 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h5><p>问题一：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    String s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//new String("ab")</span>
    <span class="token comment" spellcheck="true">//在上一行代码执行完以后，字符串常量池中并没有"ab"</span>

    String s2 <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//jdk6：串池中创建一个字符串"ab"，把此对象复制一份</span>
    <span class="token comment" spellcheck="true">//jdk8：串池中没有创建字符串"ab",而是创建一个引用指向 new String("ab")，将此引用返回</span>

    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s2 <span class="token operator">==</span> <span class="token string">"ab"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//jdk6:true  jdk8:true</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token string">"ab"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//jdk6:false  jdk8:true</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>问题二：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    String str1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">"58"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"tongcheng"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str1 <span class="token operator">==</span> str1<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//true，字符串池中不存在，把堆中的引用复制一份放入串池</span>

    String str2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token string">"ja"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"va"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str2 <span class="token operator">==</span> str2<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//false，字符串池中存在，直接返回已经存在的引用</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>原因：</p>
<ul>
<li><p>System 类当调用 Version 的静态方法，导致 Version 初始化：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initializeSystemClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>Version<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>Version 类初始化时需要对静态常量字段初始化，被 launcher_name 静态常量字段所引用的 <code>&quot;java&quot;</code> 字符串字面量就被放入的字符串常量池：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> sun<span class="token punctuation">.</span>misc<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Version</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String launcher_name <span class="token operator">=</span> <span class="token string">"java"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String java_version <span class="token operator">=</span> <span class="token string">"1.8.0_221"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String java_runtime_name <span class="token operator">=</span> <span class="token string">"Java(TM) SE Runtime Environment"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String java_profile_name <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String java_runtime_version <span class="token operator">=</span> <span class="token string">"1.8.0_221-b11"</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">//...</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<h5 id="内存位置"><a href="#内存位置" class="headerlink" title="内存位置"></a>内存位置</h5><p>Java 7 之前，String Pool 被放在运行时常量池中，属于永久代；Java 7 以后，String Pool 被移到堆中，这是因为永久代的空间有限，在大量使用字符串的场景下会导致 OutOfMemoryError 错误</p>
<p>演示 StringTable 位置：</p>
<ul>
<li><p><code>-Xmx10m</code> 设置堆内存 10m</p>
</li>
<li><p>在 JDK8 下设置： <code>-Xmx10m -XX:-UseGCOverheadLimit</code></p>
</li>
<li><p>在 JDK6 下设置： <code>-XX:MaxPermSize=10m</code></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>
    List<span class="token operator">&lt;</span>String<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">260000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212061628844.png"></p>
<hr>
<h5 id="优化常量池"><a href="#优化常量池" class="headerlink" title="优化常量池"></a>优化常量池</h5><p>两种方式：</p>
<ul>
<li><p>调整 <code>-XX:StringTableSize=桶个数</code>，数量越少，性能越差</p>
</li>
<li><p>intern 将字符串对象放入常量池，通过复用字符串的引用，减少内存占用</p>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 演示 intern 减少内存占用
 * -XX:StringTableSize=200000 -XX:+PrintStringTableStatistics
 * -Xsx500m -Xmx500m -XX:+PrintStringTableStatistics -XX:StringTableSize=200000
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_25</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">></span> address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//很多数据</span>
            <span class="token keyword">try</span> <span class="token punctuation">(</span>BufferedReader reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"linux.words"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String line <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    line <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span>line <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    address<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">intern</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"cost:"</span> <span class="token operator">+</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        System<span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="不可变好处"><a href="#不可变好处" class="headerlink" title="不可变好处"></a>不可变好处</h5><ul>
<li>可以缓存 hash 值，例如 String 用做 HashMap 的 key，不可变的特性可以使得 hash 值也不可变，只要进行一次计算</li>
<li>String Pool 的需要，如果一个 String 对象已经被创建过了，就会从 String Pool 中取得引用，只有 String 是不可变的，才可能使用 String Pool</li>
<li>安全性，String 经常作为参数，String 不可变性可以保证参数不可变。例如在作为网络连接参数的情况下如果 String 是可变的，那么在网络连接过程中，String 被改变，改变 String 的那一方以为现在连接的是其它主机，而实际情况却不一定是</li>
<li>String 不可变性天生具备线程安全，可以在多个线程中安全地使用</li>
<li>防止子类继承，破坏 String 的 API 的使用</li>
</ul>
<h3 id="5-方法区"><a href="#5-方法区" class="headerlink" title="5.方法区"></a>5.方法区</h3><blockquote>
<p>方法区 Method Area：是各个<strong>线程共享</strong>的内存区域，用于存储已被虚拟机加载的类信息、常量、即时编译器编译后的代码等数据，虽然 Java 虚拟机规范把方法区描述为堆的一个逻辑部分，但是也叫 Non-Heap（非堆）</p>
<p>Java 1.8 以前：方法区由<strong>永久代</strong>实现</p>
<p>Java 1.8 之后：方法区由<strong>元空间</strong>实现</p>
<p>异常：java.lang.OutOfMemoryError：Metaspace</p>
</blockquote>
<img src="https://img.jwt1399.top/img/202212051651947.png" style="zoom:50%;" />

<p>方法区构成：</p>
<ul>
<li><p><strong>类元信息</strong>：在类编译期间放入方法区，存放了类的基本信息，包括类的方法、参数、接口以及常量池表</p>
</li>
<li><p><strong>常量池表</strong>（Constant Pool Table）是 Class 文件的一部分，存储了<strong>类在编译期间生成的字面量、符号引用</strong>，JVM 为每个已加载的类维护一个常量池</p>
<ul>
<li><p>字面量：基本数据类型、字符串类型常量、声明为 final 的常量值等</p>
<ul>
<li><p>java 代码在编译过程中是无法构建引用的，字面量就是在编译时对于数据的一种表示</p>
</li>
<li><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>				<span class="token comment" spellcheck="true">//这个1便是字面量</span>
String b <span class="token operator">=</span> <span class="token string">"jwt"</span><span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">//jwt便是字面量</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>符号引用：类、字段、方法、接口等的符号引用</p>
<ul>
<li>在编译过程中并不知道每个类的地址，因为可能这个类还没有加载，如果在一个类中引用了另一个类，无法知道它的内存地址，只能用它的类名作为符号引用，在类加载完后用这个符号引用去获取内存地址</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>运行时常量池</strong></p>
<ul>
<li><p>常量池（编译器生成的字面量和符号引用）中的数据会在类加载的加载阶段放入运行时常量池</p>
</li>
<li><p>类在解析阶段将这些符号引用替换成直接引用</p>
</li>
<li><p>除了在编译期生成的常量，还允许动态生成，例如 String 类的 intern()</p>
</li>
</ul>
</li>
</ul>
<p>特点：</p>
<ul>
<li><p>方法区是一个 JVM 规范，<strong>永久代与元空间都是其一种实现方式</strong></p>
</li>
<li><p>方法区的大小不必是固定的，可以动态扩展，加载的类太多，可能导致永久代内存溢出 (OutOfMemoryError)</p>
</li>
<li><p>方法区的 GC：针对常量池的回收及对类型的卸载，比较难实现</p>
</li>
<li><p>为了<strong>避免方法区出现 OOM</strong>，在 JDK8 中将堆内的方法区（永久代）移动到了本地内存上，重新开辟了一块空间，叫做元空间，元空间存储类的元信息，<strong>静态变量和字符串常量池等放入堆中</strong></p>
</li>
<li><p>Java 1.8 以前：永久代内存溢出 java.lang.OutOfMemoryError: PermGen space</p>
</li>
<li><p>Java 1.8 之后：元空间内存溢出 java.lang.OutOfMemoryError: Metaspace</p>
</li>
</ul>
<h2 id="❷本地内存"><a href="#❷本地内存" class="headerlink" title="❷本地内存"></a>❷本地内存</h2><img src="https://img.jwt1399.top/img/202212051652808.png" style="zoom:50%;" />

<p>JVM内存：Java 虚拟机在执行的时候会把管理的内存分配成不同的区域，受虚拟机内存大小的参数控制，当大小超过参数设置的大小时就会报 OOM</p>
<p>本地内存：又叫做<strong>堆外内存</strong>，线程共享的区域，本地内存这块区域是不会受到 JVM 的控制的，不会发生 GC；因此对于整个 Java 的执行效率是提升非常大，但是如果内存的占用超出物理内存的大小，同样也会报 OOM</p>
<h3 id="1-方法区-x2F-元空间"><a href="#1-方法区-x2F-元空间" class="headerlink" title="1.方法区&#x2F;元空间"></a>1.方法区&#x2F;元空间</h3><p>Java8 开始 PermGen 被元空间代替，永久代的<strong>类信息、方法、常量池</strong>等都移动到元空间区</p>
<p>元空间与永久代区别：元空间不在虚拟机中，使用的本地内存，默认情况下，元空间的大小仅受本地内存限制</p>
<p>方法区内存溢出：</p>
<ul>
<li><p>JDK1.8 以前会导致<strong>永久代</strong>内存溢出：java.lang.OutOfMemoryError: PerGen space</p>
<pre class="line-numbers language-sh"><code class="language-sh"> -XX:MaxPermSize=8m		#参数设置
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>JDK1.8 以后会导致<strong>元空间</strong>内存溢出：java.lang.OutOfMemoryError: Metaspace</p>
<pre class="line-numbers language-sh"><code class="language-sh">-XX:MaxMetaspaceSize=8m	#参数设置	
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>元空间内存溢出演示：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 演示元空间内存溢出 java.lang.OutOfMemoryError: Metaspace
 * -XX:MaxMetaspaceSize=8m
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo1_8</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 可以用来加载类的二进制字节码</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Demo1_8 test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Demo1_8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ClassWriter 作用是生成类的二进制字节码</span>
                ClassWriter cw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 版本号， public， 类名, 包名, 父类， 接口</span>
                cw<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span>Opcodes<span class="token punctuation">.</span>V1_8<span class="token punctuation">,</span> Opcodes<span class="token punctuation">.</span>ACC_PUBLIC<span class="token punctuation">,</span> <span class="token string">"Class"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token string">"java/lang/Object"</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 返回 byte[]</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> cw<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 执行了类的加载</span>
                test<span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token string">"Class"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> code<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Class 对象</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-直接内存"><a href="#2-直接内存" class="headerlink" title="2.直接内存"></a>2.直接内存</h3><p>直接内存是 Java 堆外、直接向系统申请的内存区间，不是虚拟机运行时数据区的一部分，也不是《Java 虚拟机规范》中定义的内存区域，但是这部分内存也被频繁地使用。而且也可能导致 OutOfMemoryError 错误出现。</p>
<h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>Direct Memory 优点：</p>
<ul>
<li>Java 的 NIO 库允许 Java 程序使用直接内存，使用 native 函数直接分配堆外内存</li>
<li><strong>读写性能高</strong>，读写频繁的场合可能会考虑使用直接内存</li>
<li>大大提高 IO 性能，避免了在 Java 堆和 native 堆来回复制数据</li>
</ul>
<p>直接内存缺点：</p>
<ul>
<li>不能使用内核缓冲区 Page Cache 的缓存优势，无法缓存最近被访问的数据和使用预读功能</li>
<li>分配回收成本较高，不受 JVM 内存回收管理</li>
<li>可能导致 OutOfMemoryError 异常：OutOfMemoryError: Direct buffer memory</li>
<li>回收依赖 System.gc() 的调用，但这个调用 JVM 不保证执行、也不保证何时执行，行为是不可控的。程序一般需要自行管理，成对去调用 malloc、free</li>
</ul>
<p>应用场景：</p>
<ul>
<li>传输很大的数据文件，数据的生命周期很长，导致 Page Cache 没有起到缓存的作用，一般采用直接 IO 的方式</li>
<li>适合频繁的 IO 操作，比如网络并发场景</li>
</ul>
<p>数据流的角度：</p>
<ul>
<li>非直接内存的作用链：本地 IO → 内核缓冲区→ 用户（JVM）缓冲区 →内核缓冲区 → 本地 IO</li>
<li>直接内存的作用链：本地 IO → 直接内存 → 本地 IO</li>
</ul>
<table>
<thead>
<tr>
<th>直接内存</th>
<th><img src="https://img.jwt1399.top/img/202212071545546.png"></th>
</tr>
</thead>
<tbody><tr>
<td><strong>非直 接内存</strong></td>
<td><img src="https://img.jwt1399.top/img/202212071545613.png"></td>
</tr>
</tbody></table>
<h4 id="ByteBuffer"><a href="#ByteBuffer" class="headerlink" title="ByteBuffer"></a>ByteBuffer</h4><img src="https://img.jwt1399.top/img/202212071605453.png" style="zoom: 50%;" />

<p>ByteBuffer 有两种类型：</p>
<ul>
<li>一种是基于直接内存（非堆内存）：DirectByteBuffer</li>
<li>一种是非直接内存（堆内存）：HeapByteBuffer</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>描述</th>
<th>优点</th>
</tr>
</thead>
<tbody><tr>
<td>HeapByteBuffer</td>
<td>在jvm堆上面的一个buffer，底层的本质是一个数组</td>
<td>由于内容维护在jvm里，所以把内容写进buffer里速度会快些；并且，可以更容易回收</td>
</tr>
<tr>
<td>DirectByteBuffer</td>
<td>底层的数据其实是维护在操作系统的内存中，而不是jvm里，DirectByteBuffer里维护了一个引用address指向了数据，从而操作数据</td>
<td>跟外设（IO设备）打交道时会快很多，因为外设读取jvm堆里的数据时，不是直接读取的，而是把jvm里的数据读到一个内存块里，再在这个块里读取的，如果使用DirectByteBuffer，则可以省去这一步，实现zero copy</td>
</tr>
</tbody></table>
<h4 id="分配回收"><a href="#分配回收" class="headerlink" title="分配回收"></a>分配回收</h4><p>直接内存 DirectByteBuffer 源码分析：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token function">DirectByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> cap<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment" spellcheck="true">//....</span>
    <span class="token keyword">long</span> base <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 分配直接内存</span>
        base <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">allocateMemory</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 内存赋值</span>
    unsafe<span class="token punctuation">.</span><span class="token function">setMemory</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pa <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>base <span class="token operator">%</span> ps <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        address <span class="token operator">=</span> base <span class="token operator">+</span> ps <span class="token operator">-</span> <span class="token punctuation">(</span>base <span class="token operator">&amp;</span> <span class="token punctuation">(</span>ps <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        address <span class="token operator">=</span> base<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 创建回收函数</span>
    cleaner <span class="token operator">=</span> Cleaner<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Deallocator</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> size<span class="token punctuation">,</span> cap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Deallocator</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        unsafe<span class="token punctuation">.</span><span class="token function">freeMemory</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 释放内存</span>
        <span class="token comment" spellcheck="true">//...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>分配和回收原理</strong>：</p>
<ul>
<li>使用了 <code>Unsafe</code> 对象的 <code>allocateMemory</code> 方法完成<strong>直接内存的分配</strong>，setMemory 方法完成赋值</li>
<li>ByteBuffer 的实现类内部，使用了 Cleaner（虚引用）来监测 ByteBuffer 对象，一旦 ByteBuffer 对象被垃圾回收，那么 ReferenceHandler 线程通过 Cleaner 的 clean 方法调用 Deallocator 的 run方法，最后通过 <code>freeMemory</code> 来<strong>释放直接内存</strong></li>
</ul>
<h2 id="❸JVM运行原理"><a href="#❸JVM运行原理" class="headerlink" title="❸JVM运行原理"></a>❸JVM运行原理</h2><img src="https://img.jwt1399.top/img/202212230857858.png" style="zoom:50%;" />

<p>接下来，我们通过一个案例来了解下代码和对象是如何分配存储的，Java 代码又是如何在 JVM 中运行的。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JVMCase</span> <span class="token punctuation">{</span>

  <span class="token comment" spellcheck="true">// 常量</span>
  <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> String MAN_SEX_TYPE <span class="token operator">=</span> <span class="token string">"man"</span><span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">// 静态变量</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> String WOMAN_SEX_TYPE <span class="token operator">=</span> <span class="token string">"woman"</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// 静态方法</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span>Student stu<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"name: "</span> <span class="token operator">+</span> stu<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"; sex:"</span> <span class="token operator">+</span> stu<span class="token punctuation">.</span><span class="token function">getSexType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"; age:"</span> <span class="token operator">+</span> stu<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">// 非静态方法</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sayHello</span><span class="token punctuation">(</span>Student stu<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stu<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"say: hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Student stu <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stu<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"nick"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stu<span class="token punctuation">.</span><span class="token function">setSexType</span><span class="token punctuation">(</span>MAN_SEX_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    stu<span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    JVMCase jvmcase <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JVMCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 调用静态方法</span>
    <span class="token function">print</span><span class="token punctuation">(</span>stu<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 调用非静态方法</span>
    jvmcase<span class="token punctuation">.</span><span class="token function">sayHello</span><span class="token punctuation">(</span>stu<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">class</span> <span class="token class-name">Student</span><span class="token punctuation">{</span>
  String name<span class="token punctuation">;</span>
  String sexType<span class="token punctuation">;</span>
  <span class="token keyword">int</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行上面代码时，JVM的整个处理过程如下：</p>
<ul>
<li>1.JVM 向操作系统<strong>申请内存</strong>，JVM 首先通过配置参数或者默认配置参数向操作系统申请内存空间，根据内存大小找到具体的内存分配表，然后把内存段的起始地址和终止地址分配给 JVM。</li>
<li>2.JVM 获得内存空间后，就<strong>进行内部分配</strong>。JVM 根据配置参数分配堆、栈以及方法区的内存大小。</li>
<li>3.<strong>class 文件加载、验证、准备以及解析</strong>，其中准备阶段会为类的静态变量分配内存，初始化为系统的初始值</li>
</ul>
<img src="https://img.jwt1399.top/img/202212061913505.jpg" style="zoom:50%;" />

<ul>
<li><p>4.完成上一个步骤后，将会进行最后一个初始化阶段。在这个阶段中，JVM 首先会执行构造器<code>&lt;clinit&gt;()</code>方法，编译器会在.java 文件被编译成.class 文件时，收集所有类的初始化代码，包括静态变量赋值语句、静态代码块、静态方法，收集在一起成为<code>&lt;clinit&gt;()</code>方法。</p>
<img src="https://img.jwt1399.top/img/202212061913531.jpg" style="zoom:50%;" />
</li>
<li><p>5.执行方法。启动 main 线程，执行 main 方法，开始执行第一行代码。此时堆内存中会创建一个 student 对象，对象引用 student 就存放在栈中。<img src="https://img.jwt1399.top/img/202212061923027.jpg" style="zoom:50%;" /></p>
</li>
<li><p>6.创建一个 JVMCase 对象，调用 sayHello 非静态方法，sayHello 方法属于对象 JVMCase，此时 sayHello 方法入栈，并通过栈中的 student 引用调用堆中的 Student 对象；之后，调用静态方法 print，print 静态方法属于 JVMCase 类，是从静态方法中获取，之后放入到栈中，也通过 student 引用调用堆中的 student 对象。</p>
</li>
</ul>
<img src="https://img.jwt1399.top/img/202212061923172.jpg" style="zoom:50%;" />



<h2 id="❹总结"><a href="#❹总结" class="headerlink" title="❹总结"></a>❹总结</h2><h3 id="1-异常"><a href="#1-异常" class="headerlink" title="1.异常"></a>1.异常</h3><p>常见 Out Of Memory（OOM） 错误：</p>
<ul>
<li><p>java.lang.StackOverflowError</p>
<ul>
<li>栈溢出</li>
<li>设置栈内存大小：<code>-Xss size</code></li>
</ul>
</li>
<li><p>java.lang.OutOfMemoryError：java heap space</p>
<ul>
<li>堆溢出</li>
<li>设置堆内存指令：<code>-Xmx Size</code></li>
</ul>
</li>
<li><p>java.lang.OutOfMemoryError：GC overhead limit exceeded  </p>
<ul>
<li>当 JVM 花太多时间执行垃圾回收并且只能回收很少的堆空间时，就会发生此错误。</li>
<li>即程序基本上耗尽了所有的可用内存, GC也清理不了。</li>
</ul>
</li>
<li><p>java.lang.OutOfMemoryError：Direct buffer memory</p>
<ul>
<li>直接内存溢出</li>
</ul>
</li>
<li><p>java.lang.OutOfMemoryError：unable to create new native thread</p>
<ul>
<li>系统内存耗尽，无法为新线程分配内存或者创建线程数超过了操作系统的限制</li>
</ul>
</li>
<li><p>java.lang.OutOfMemoryError: PermGen space</p>
<ul>
<li>Java 1.8 以前：永久代内存溢出 </li>
<li><code>-XX:MaxPermSize=8m</code></li>
</ul>
<p>	</p>
</li>
<li><p>java.lang.OutOfMemoryError：Metaspace</p>
<ul>
<li>Java 1.8 之后：元空间内存溢出</li>
<li><code>-XX:MaxMetaspaceSize=8m</code></li>
</ul>
</li>
</ul>
<p>	</p>
<p>Java 编译指令：<code>javac -g 文件名.java</code>  -g 可以生成所有相关信息</p>
<p>Java 反编译指令：<code>javap -v 文件名.class</code> -v 输出附加信息</p>
<p>后台运行：<code>nohup java 全路径名</code></p>
<h3 id="2-三种常量池"><a href="#2-三种常量池" class="headerlink" title="2.三种常量池"></a>2.三种常量池</h3><p><strong>常量池</strong>：主要存放编译期生成的各种**字面量(Literal)和符号引用(Symbolic References)**。</p>
<ul>
<li>字面量：例如文本字符串、fina修饰的常量。</li>
<li>符号引用：例如类和接口的全限定名、字段的名称和描述符、方法的名称和描述符</li>
</ul>
<p><strong>运行时常量池</strong>：运行时常量池里面存储的主要是<strong>编译期间生成的字面量、符号引用</strong>等等。</p>
<ul>
<li>当类加载到内存中后，JVM就会将<strong>常量池</strong>中的内容存放到运行时常量池中；</li>
<li>类加载在链接环节的解析过程，会符号引用转换成直接引用（静态链接）。此处得到的<strong>直接引用</strong>也是放到运行时常量池中的。</li>
<li>运行期间可以动态放入新的常量。</li>
</ul>
<p><strong>字符串常量池</strong>：可以理解成运行时常量池分出来的一部分。类加载到内存的时候，字符串会存到字符串常量池里面。 </p>
<ul>
<li>JVM 为了提升性能和减少内存消耗针对字符串（String 类）专门开辟的一块区域，主要目的是为了避免字符串的重复创建。</li>
<li>JDK6时字符串常量池位于运行时常量池，JDK7挪到堆中。</li>
</ul>
<p><strong>3者区别？</strong></p>
<ul>
<li>常量池与运行时常量池都存储在<strong>方法区</strong>，而字符串常量池在 Jdk7 时就已经从方法区迁移到了 Java 堆中</li>
</ul>
<p>在类编译过程中，会把类元信息放到方法区，类元信息的其中一部分便是常量池，主要存放字面量和符号引用，而字面量的一部分便是文本字符；<strong>在类加载时将字面量和符号引用解析为直接引用存储在运行时常量池</strong>；对于文本字符，会在解析时查找字符串常量池，查出这个文本字符对应的字符串对象的直接引用，将直接引用存储在运行时常量池</p>
<h3 id="3-变量位置"><a href="#3-变量位置" class="headerlink" title="3.变量位置"></a>3.变量位置</h3><p>变量的位置不取决于它是基本数据类型还是引用数据类型，取决于它的<strong>声明位置</strong></p>
<p>静态内部类和其他内部类：方法区&#x2F;堆</p>
<ul>
<li><p><strong>一个 class 文件只能对应一个 public 类型的类</strong>，这个类可以有内部类，但不会生成新的 class 文件</p>
</li>
<li><p>静态内部类属于类本身，加载到<strong>方法区</strong>，其他内部类属于内部类的属性，加载到<strong>堆</strong></p>
</li>
</ul>
<p>类变量：堆</p>
<ul>
<li>类变量是用 static 修饰符修饰，定义在方法外的变量，随着 Java 进程产生和销毁</li>
<li>在 Java8 之前把静态变量存放于方法区，在 Java8 时存放在<strong>堆中的静态变量区</strong></li>
</ul>
<p>实例变量：堆</p>
<ul>
<li>实例（成员）变量是定义在类中，没有 static 修饰的变量，随着类的实例产生和销毁，是类实例的一部分</li>
<li>在类初始化的时候，从运行时常量池取出直接引用或者值，<strong>与初始化的对象一起放入堆中</strong></li>
</ul>
<p>局部变量：虚拟机栈</p>
<ul>
<li>局部变量是定义在类的方法中的变量</li>
<li>在所在方法被调用时<strong>放入虚拟机栈的栈帧</strong>中，方法执行结束后从虚拟机栈中弹出</li>
</ul>
<h1 id="③对象实例化"><a href="#③对象实例化" class="headerlink" title="③对象实例化"></a>③对象实例化</h1><h2 id="❶对象内存结构"><a href="#❶对象内存结构" class="headerlink" title="❶对象内存结构"></a>❶对象内存结构</h2><p>一个 Java 对象内存中存储为三部分：对象头（Header）、实例数据（Instance Data）和对齐填充 （Padding）</p>
<p><strong>对象头：</strong></p>
<ul>
<li>普通对象：分为 <code>Mark Word</code> 和 <code>Klass Word</code> 两部分</li>
</ul>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                         <span class="token builtin">Object</span> <span class="token function">Header</span> <span class="token punctuation">(</span><span class="token number">64</span> bits<span class="token punctuation">)</span>              <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span>
<span class="token operator">|</span>           <span class="token constant">Mark</span> <span class="token function">Word</span> <span class="token punctuation">(</span><span class="token number">32</span> bits<span class="token punctuation">)</span>      <span class="token operator">|</span>    <span class="token constant">Klass</span> <span class="token function">Word</span> <span class="token punctuation">(</span><span class="token number">32</span> bits<span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>Mark Word</code>：用于存储对象自身的运行时数据， 如哈希码（HashCode）、GC 分代年龄、锁状态标志（最后两位）、线程持有的锁、偏向线程ID、偏向时间戳等等</p>
<p>32 位虚拟机 Mark Word</p>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                    <span class="token constant">Mark</span> <span class="token function">Word</span> <span class="token punctuation">(</span><span class="token number">32</span> bits<span class="token punctuation">)</span>                <span class="token operator">|</span>        <span class="token constant">State</span>       <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>              hashcode<span class="token punctuation">:</span><span class="token number">25</span> <span class="token operator">|</span> age<span class="token punctuation">:</span><span class="token number">4</span> <span class="token operator">|</span> biased_lock<span class="token punctuation">:</span><span class="token number">0</span> <span class="token operator">|</span> <span class="token number">01</span> <span class="token operator">|</span>        <span class="token constant">Normal</span>      <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>      thread<span class="token punctuation">:</span><span class="token number">23</span> <span class="token operator">|</span> epoch<span class="token punctuation">:</span><span class="token number">2</span> <span class="token operator">|</span> age<span class="token punctuation">:</span><span class="token number">4</span> <span class="token operator">|</span> biased_lock<span class="token punctuation">:</span><span class="token number">1</span> <span class="token operator">|</span> <span class="token number">01</span> <span class="token operator">|</span>        <span class="token constant">Biased</span>      <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                            ptr_to_lock_record<span class="token punctuation">:</span><span class="token number">30</span> <span class="token operator">|</span> <span class="token number">00</span> <span class="token operator">|</span> <span class="token constant">Lightweight</span> <span class="token constant">Locked</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                    ptr_to_heavyweight_monitor<span class="token punctuation">:</span><span class="token number">30</span> <span class="token operator">|</span> <span class="token number">10</span> <span class="token operator">|</span> <span class="token constant">Heavyweight</span> <span class="token constant">Locked</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                                                  <span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span>    <span class="token constant">Marked</span> <span class="token keyword">for</span> <span class="token constant">GC</span>   <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>64 位虚拟机 Mark Word</p>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                      <span class="token constant">Mark</span> <span class="token function">Word</span> <span class="token punctuation">(</span><span class="token number">64</span> bits<span class="token punctuation">)</span>                           <span class="token operator">|</span>       <span class="token constant">State</span>        <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>    unused<span class="token punctuation">:</span><span class="token number">25</span> <span class="token operator">|</span> hashcode<span class="token punctuation">:</span><span class="token number">31</span> <span class="token operator">|</span> unused<span class="token punctuation">:</span><span class="token number">1</span> <span class="token operator">|</span> age<span class="token punctuation">:</span><span class="token number">4</span> <span class="token operator">|</span> biased_lock<span class="token punctuation">:</span><span class="token number">0</span> <span class="token operator">|</span> <span class="token number">01</span> <span class="token operator">|</span>       <span class="token constant">Normal</span>       <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>        thread<span class="token punctuation">:</span><span class="token number">54</span> <span class="token operator">|</span> epoch<span class="token punctuation">:</span><span class="token number">2</span> <span class="token operator">|</span> unused<span class="token punctuation">:</span><span class="token number">1</span> <span class="token operator">|</span> age<span class="token punctuation">:</span><span class="token number">4</span> <span class="token operator">|</span> biased_lock<span class="token punctuation">:</span><span class="token number">1</span> <span class="token operator">|</span> <span class="token number">01</span> <span class="token operator">|</span>       <span class="token constant">Biased</span>       <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                                         ptr_to_lock_record<span class="token punctuation">:</span><span class="token number">62</span> <span class="token operator">|</span> <span class="token number">00</span> <span class="token operator">|</span> <span class="token constant">Lightweight</span> <span class="token constant">Locked</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                                 ptr_to_heavyweight_monitor<span class="token punctuation">:</span><span class="token number">62</span> <span class="token operator">|</span> <span class="token number">10</span> <span class="token operator">|</span> <span class="token constant">Heavyweight</span> <span class="token constant">Locked</span> <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span class="token operator">|</span>                                                               <span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span>    <span class="token constant">Marked</span> <span class="token keyword">for</span> <span class="token constant">GC</span>   <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">|</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token function">hash</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> 32bit					<span class="token comment" spellcheck="true">#32位系统</span>
<span class="token function">unused</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token number">31</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">age</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> 64bit	<span class="token comment" spellcheck="true">#64位系统</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><code>Klass Word</code>：类型指针，<strong>指向该对象的 Class 类对象的指针</strong>，虚拟机通过这个指针来确定这个对象是哪个类的实例；在 64 位系统中，默认开启指针压缩（<code>-XX:+UseCompressedOops</code>），使用32bits指针。堆内存大于32G时，压缩指针会失效，会强制使用64bits来进行对象寻址</p>
<ul>
<li>数组对象：如果对象是一个数组，那在对象头中还有一块数据用于记录数组长度（12 字节）</li>
</ul>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span>
<span class="token operator">|</span> 						              <span class="token builtin">Object</span> <span class="token function">Header</span> <span class="token punctuation">(</span><span class="token number">96</span> bits<span class="token punctuation">)</span> 							              <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token constant">Mark</span> <span class="token function">Word</span><span class="token punctuation">(</span>32bits<span class="token punctuation">)</span>    <span class="token operator">|</span> 	  <span class="token constant">Klass</span> <span class="token function">Word</span><span class="token punctuation">(</span>32bits<span class="token punctuation">)</span> 	    <span class="token operator">|</span>   array <span class="token function">length</span><span class="token punctuation">(</span>32bits<span class="token punctuation">)</span>  <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">|</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>实例数据</strong>：实例数据部分是对象真正存储的有效信息，也是在程序代码中所定义的各种类型的字段内容，无论是从父类继承下来的，还是在子类中定义的，都需要记录起来</p>
<p><strong>对齐填充</strong>：Padding 起占位符的作用。64 位系统，由于 HotSpot VM 的自动内存管理系统要求<strong>对象起始地址必须是 8 字节的整数倍</strong>，就是对象的大小必须是 8 字节的整数倍，而对象头部分正好是 8 字节的倍数（1 倍或者 2 倍），因此当对象实例数据部分没有对齐时，就需要通过对齐填充来补全</p>
<p>32 位系统：</p>
<ul>
<li><p>一个 int 在 java 中占据 4byte，所以 Integer 的大小为：</p>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># 需要补位4byte</span>
<span class="token function">4</span><span class="token punctuation">(</span><span class="token constant">Mark</span> <span class="token constant">Word</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">4</span><span class="token punctuation">(</span><span class="token constant">Klass</span> <span class="token constant">Word</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">4</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">4</span><span class="token punctuation">(</span><span class="token constant">Padding</span><span class="token punctuation">)</span> <span class="token operator">=</span> 16byte
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p><code>int[] arr = new int[10]</code></p>
<pre class="line-numbers language-ruby"><code class="language-ruby"><span class="token comment" spellcheck="true"># 由于需要8位对齐，所以最终大小为56byte</span>
<span class="token function">4</span><span class="token punctuation">(</span><span class="token constant">Mark</span> <span class="token constant">Word</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">4</span><span class="token punctuation">(</span><span class="token constant">Klass</span> <span class="token constant">Word</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">4</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token operator">*</span><span class="token function">10</span><span class="token punctuation">(</span><span class="token number">10</span>个int大小<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">4</span><span class="token punctuation">(</span><span class="token constant">Padding</span><span class="token punctuation">)</span> <span class="token operator">=</span> 56sbyte
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<img src="https://img.jwt1399.top/img/202212221542828.png" style="zoom: 50%;" />

<h2 id="❷对象访问方式"><a href="#❷对象访问方式" class="headerlink" title="❷对象访问方式"></a>❷对象访问方式</h2><p>JVM 是通过<strong>栈帧中的对象引用（reference）</strong>访问到堆中的对象实例：</p>
<ul>
<li><p>句柄访问：Java 堆中会划分出一块内存来作为句柄池，reference 中存储的就是对象的句柄地址，而句柄中包含了对象实例数据和类型数据各自的具体地址信息</p>
<p>优点：reference 中存储的是稳定的句柄地址，在对象被移动（垃圾收集）时只会改变句柄中的实例数据指针，而 reference 本身不需要被修改</p>
<p><img src="https://img.jwt1399.top/img/202212221546450.jpeg"></p>
</li>
<li><p>直接指针（HotSpot 采用）：reference 中直接存储的对象地址，对象中包含对象类型数据的指针，通过这个指针可以访问对象类型数据。</p>
<p>优点：速度更快，<strong>节省了一次指针定位的时间开销</strong></p>
<p>缺点：对象被移动时（如进行 GC 后的内存重新排列），对象的 reference 也需要同步更新</p>
<p><img src="https://img.jwt1399.top/img/202212221547695.jpeg"></p>
</li>
</ul>
<h2 id="❸对象创建过程"><a href="#❸对象创建过程" class="headerlink" title="❸对象创建过程"></a>❸对象创建过程</h2><p><strong>创建对象的方式</strong></p>
<ul>
<li><p>new：最常见的方式</p>
</li>
<li><p>Class的newInstance方法（反射机制）</p>
</li>
<li><p>Constructor的newInstance(XXX)（反射机制）</p>
</li>
<li><p>使用clone()：不调用任何的构造器，要求当前的类需要实现Cloneable接口，实现clone()</p>
</li>
<li><p>使用序列化：从文件中、从网络中获取一个对象的二进制流</p>
</li>
<li><p>第三方库 Objenesis</p>
</li>
</ul>
<p><strong>创建对象的过程</strong></p>
<ol>
<li>类加载检查</li>
</ol>
<p>当虚拟机遇到一条 <code>new</code> 指令时，首先检查是否能在运行时常量池中定位到这个类的符号引用，并且检查这个符号引用代表的类是否已被加载、解析和初始化过。如果没有，那先执行类加载。</p>
<ol start="2">
<li>为对象分配内存</li>
</ol>
<p>首先计算对象占用空间的大小，接着在堆中划分一块内存给新对象。</p>
<ul>
<li><p><strong>如果内存规整</strong>：虚拟机将采用的是指针碰撞法（Bump The Point）来为对象分配内存。</p>
</li>
<li><p><strong>如果内存不规整</strong>：虚拟机需要维护一个空闲列表（Free List）来为对象分配内存。</p>
</li>
</ul>
<p>选择哪种分配方式由堆是否规整所决定，而堆是否规整又由所采用的GC收集器是否带有压缩整理功能决定。</p>
<p><strong>内存分配并发问题</strong></p>
<p>在创建对象的时候有一个很重要的问题，就是线程安全，虚拟机采用两种方式来保证线程安全：</p>
<ul>
<li><strong>CAS+失败重试：</strong> CAS 是乐观锁的一种实现方式。所谓乐观锁就是，每次不加锁而是假设没有冲突而去完成某项操作，如果因为冲突失败就重试，直到成功为止。<strong>虚拟机采用 CAS 配上失败重试的方式保证更新操作的原子性。</strong></li>
<li><strong>TLAB：</strong> 为每一个线程预先在 Eden 区分配一块内存，JVM 在给线程中的对象分配内存时，首先在 TLAB 分配，当对象大于 TLAB 中的剩余内存或 TLAB 的内存已用尽时，再采用上述的 CAS 进行内存分配，通过设置 <code>-XX:+UseTLAB</code>参数来设定</li>
</ul>
<ol start="3">
<li>初始化零值</li>
</ol>
<p>分配到的内存空间都初始化为零值，通过这个操作保证了对象的字段可以不赋初始值就直接使用，程序能访问到这些字段的数据类型所对应的零值。</p>
<ol start="4">
<li>设置对象头</li>
</ol>
<p>将对象的所属类（即类的元数据信息）、对象的哈希码、对象的GC分代年龄、锁信息等数据存储在对象的对象头中。另外，根据虚拟机当前运行状态的不同，如是否启用偏向锁等，对象头会有不同的设置方式。</p>
<ol start="5">
<li>执行 init 方法</li>
</ol>
<p>在上面工作都完成之后，从虚拟机的视角来看，一个新的对象已经产生了，但从 Java 程序的视角来看，对象创建才刚开始，执行 new 指令之后会接着执行 <code>&lt;init&gt;</code> 方法（初始化成员变量，执行实例化代码块，调用类的构造方法，并把堆内对象的首地址赋值给引用变量），把对象按照程序员的意愿进行初始化，这样一个真正可用的对象才算完全产生出来。</p>
<h1 id="③垃圾回收"><a href="#③垃圾回收" class="headerlink" title="③垃圾回收"></a>③垃圾回收</h1><h2 id="❶内存分配"><a href="#❶内存分配" class="headerlink" title="❶内存分配"></a>❶内存分配</h2><h3 id="1-两种方式"><a href="#1-两种方式" class="headerlink" title="1.两种方式"></a>1.两种方式</h3><p>JVM 为对象分配内存的过程：首先计算对象占用空间大小，接着在堆中划分一块内存给新对象</p>
<ul>
<li>如果内存规整，使用指针碰撞（Bump The Pointer）。所有用过的内存在一边，空闲的内存在另外一边，中间有一个指针作为分界点的指示器，分配内存就仅仅是把指针向空闲那边挪动一段与对象大小相等的距离</li>
<li>如果内存不规整，虚拟机维护一个空闲列表（Free List）。已使用的内存和未使用的内存相互交错，列表上记录哪些内存块是可用的，分配的时候从列表中找到一块足够大的空间划分给对象实例，并更新列表上的内容</li>
</ul>
<h3 id="2-TLAB"><a href="#2-TLAB" class="headerlink" title="2.TLAB"></a>2.TLAB</h3><p>Thread Local Allocation Buffer，TLAB 是虚拟机在堆内存的 Eden 划分出来的一块专用空间，是线程专属的。</p>
<p>在线程初始化时，虚拟机会为每个线程分配一块TLAB空间，只给当前线程使用，这样每个线程都单独拥有一个空间，如果需要分配内存，就在自己的空间上分配，这样就不存在竞争的情况，可以大大提升分配效率。</p>
<p>多线程分配内存时，使用 TLAB 可以避免线程安全问题，同时还能够提升内存分配的吞吐量，这种内存分配方式叫做<strong>快速分配策略</strong></p>
<p>我们说TLAB是线程独享的，但是只是在“分配”这个动作上是线程独享的，至于在读取、垃圾回收等动作上都是线程共享的。</p>
<ul>
<li>栈上分配使用的是栈来进行对象内存的分配</li>
<li>TLAB 分配使用的是 Eden 区域进行内存分配，属于堆内存</li>
</ul>
<p>堆区是线程共享区域，任何线程都可以访问到堆区中的共享数据，由于对象实例的创建在 JVM 中非常频繁，因此在并发环境下为避免多个线程操作同一地址，需要使用加锁等机制，进而影响分配速度</p>
<p>问题：堆空间都是共享的么？ 不一定，因为还有 TLAB，在堆中划分出一块区域，为每个线程所独占</p>
<p><img src="https://img.jwt1399.top/img/202212181344818.jpg"></p>
<p>JVM 是将 TLAB 作为内存分配的首选，但不是所有的对象实例都能够在 TLAB 中成功分配内存，一旦对象在 TLAB 空间分配内存失败时，JVM 就会通过<strong>使用加锁机制确保数据操作的原子性</strong>，从而直接在堆中分配内存</p>
<p>栈上分配优先于 TLAB 分配进行，逃逸分析中若可进行栈上分配优化，会优先进行对象栈上直接分配内存</p>
<p>参数设置：</p>
<ul>
<li><p><code>-XX:UseTLAB</code>：设置是否开启 TLAB 空间</p>
</li>
<li><p><code>-XX:TLABWasteTargetPercent</code>：设置 TLAB 空间所占用 Eden 空间的百分比大小，默认情况下 TLAB 空间的内存非常小，仅占有整个 Eden 空间的1%</p>
</li>
<li><p><code>-XX:TLABRefillWasteFraction</code>：指当 TLAB 空间不足，请求分配的对象内存大小超过此阈值时不会进行 TLAB 分配，直接进行堆内存分配，否则还是会优先进行 TLAB 分配</p>
</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212181344195.jpg"></p>
<h2 id="❷分代思想"><a href="#❷分代思想" class="headerlink" title="❷分代思想"></a>❷分代思想</h2><h3 id="1-分代介绍"><a href="#1-分代介绍" class="headerlink" title="1.分代介绍"></a>1.分代介绍</h3><p>Java8 时，堆被分为了两份：新生代和老年代（1:2），在 Java7 时，还存在一个永久代</p>
<ul>
<li>新生代使用：复制算法</li>
<li>老年代使用：标记 - 清除 或者 标记 - 整理 算法</li>
</ul>
<p>Young 区被划分为三部分，Eden 区和两个大小严格相同的 Survivor 区。 Eden 和 Survivor 大小比例默认为 8:1:1</p>
<ul>
<li>Survivor 区某一时刻只有其中一个是被使用的，另外一个留做垃圾回收时复制对象。</li>
<li>在 Eden 区变满的时候，GC 就会将存活的对象移到空闲的 Survivor 区间中，根据 JVM 的策略，在经过几次垃圾回收后，仍然存活于 Survivor 的对象将被移动到 Old 区间</li>
</ul>
<p>Old 区主要保存生命周期长的对象，一般是一些老的对象，当一些对象在 Young 复制转移一定的次数以后，对象就会被转移到 Old 区</p>
<img src="https://img.jwt1399.top/img/202212071718619.png"  />

<p>分代原因：不同对象的生命周期不同，70%-99% 的对象都是临时对象，优化 GC 性能</p>
<p><strong>GC</strong>：</p>
<ul>
<li>Minor GC：回收新生代，新生代对象存活时间很短，所以 Minor GC 会频繁执行，执行的速度比较快</li>
<li>Major GC：回收老年代。目前只有CMS收集器会有单独收集老年代的行为。</li>
<li>Mixed GC：回收整个新生代以及部分老年代的垃圾收集。目前只有G1收集器会有这种行为。</li>
<li>Full GC：回收整个Java堆和方法区。回收老年代和新生代，老年代对象其存活时间长，所以 Full GC 很少执行，执行速度会比 Minor GC 慢很多</li>
</ul>
<hr>
<h3 id="2-分代分配"><a href="#2-分代分配" class="headerlink" title="2.分代分配"></a>2.分代分配</h3><p>工作机制：</p>
<ul>
<li><strong>对象优先在 Eden 分配</strong>：当创建一个对象的时候，对象会被分配在新生代的 Eden 区，当 Eden 区要满了时候，触发 Minor GC</li>
<li>当进行 Minor GC 时，将 Eden 区存活的对象被移动到 to 区，并且当前对象的年龄会加 1，清空 Eden 区，再将 from 和 to 两个区域互换</li>
<li>当再一次触发 Minor GC 的时候，会把 Eden 区中存活下来的对象和 from 中的对象，移动到 to 区中，这些对象的年龄会加 1，清空 Eden 区和 from 区，再将 from 和 to 两个区域互换</li>
<li>To 区永远是空 Survivor 区，From 区是有数据的，每次 MinorGC 后两个区域互换</li>
<li>From 区和 To 区 也可以叫做 S0 区和 S1 区</li>
</ul>
<p>晋升到老年代：</p>
<ul>
<li><p><strong>大对象直接进入老年代</strong>：大对象就是需要大量连续内存空间的对象（比如：字符串、数组）。为了避免在 Eden 和 Survivor 之间的大量复制而降低效率。</p>
<p><code>-XX:PretenureSizeThreshold</code>：大于此值的对象直接在老年代分配</p>
</li>
<li><p><strong>长期存活的对象进入老年代</strong>：为对象定义年龄计数器，对象在 Eden 出生并经过 Minor GC 依然存活，将移动到 Survivor 中，年龄就增加 1 岁，增加到一定年龄则移动到老年代中</p>
<p><code>-XX:MaxTenuringThreshold</code>：定义年龄的阈值，对象头中用 4 个 bit 存储，所以最大值是 15，默认也是 15</p>
</li>
<li><p><strong>动态对象年龄判定</strong>：Hotspot 遍历所有对象时，按照年龄从小到大对其所占用的大小进行累加，当累加到某个年龄时，所占用大小超过了 Survivor 空间的 50% 时，则大于等于该年龄的对象就可以直接进入老年代，无须等到<code>MaxTenuringThreshold</code>中要求的年龄。</p>
<p><code>-XX:TargetSurvivorRatio=percent</code> ：设定survivor区的目标使用率，默认值是 50%</p>
<p>取这个年龄和 <code>MaxTenuringThreshold</code> 中更小的一个值，作为新的晋升年龄的阈值</p>
</li>
</ul>
<p>空间分配担保：</p>
<ul>
<li>在发生 Minor GC 之前，虚拟机先检查老年代最大可用的连续空间是否大于新生代所有对象总空间，如果条件成立的话，那么 Minor GC 可以确认是安全的</li>
<li>如果不成立，虚拟机会查看 HandlePromotionFailure 的值是否允许担保失败，如果允许那么就会继续检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小，如果大于将尝试着进行一次 Minor GC；如果小于或者 HandlePromotionFailure 的值不允许冒险，那么就要进行一次 Full GC</li>
</ul>
<h2 id="❸回收策略"><a href="#❸回收策略" class="headerlink" title="❸回收策略"></a>❸回收策略</h2><h3 id="1-触发条件"><a href="#1-触发条件" class="headerlink" title="1.触发条件"></a>1.触发条件</h3><p>内存垃圾回收机制主要集中的区域就是线程共享区域：<strong>堆和方法区</strong></p>
<p>Minor GC 触发条件：当 Eden 空间满时，就将触发一次 Minor GC</p>
<p>Full GC 同时回收新生代、老年代和方法区，有以下触发条件：</p>
<ul>
<li><p>调用 System.gc()：</p>
<ul>
<li>在默认情况下，通过 System.gc() 或 Runtime.getRuntime().gc() 的调用，会显式触发 FullGC，同时对老年代和新生代进行回收，但是虚拟机不一定真正去执行，无法保证对垃圾收集器的调用</li>
<li>不建议使用这种方式，应该让虚拟机管理内存。一般情况下，垃圾回收应该是自动进行的，无须手动触发；在一些特殊情况下，如正在编写一个性能基准，可以在运行之间调用 System.gc()</li>
</ul>
</li>
<li><p>老年代空间不足：</p>
<ul>
<li>为了避免引起的 Full GC，应当尽量不要创建过大的对象以及数组</li>
<li>通过 -Xmn 参数调整新生代的大小，让对象尽量在新生代被回收掉不进入老年代，可以通过 <code>-XX:MaxTenuringThreshold</code> 调大对象进入老年代的年龄，让对象在新生代多存活一段时间</li>
</ul>
</li>
<li><p>空间分配担保失败</p>
</li>
<li><p>JDK 1.7 及以前的永久代（方法区）空间不足</p>
</li>
<li><p>Concurrent Mode Failure：执行 CMS GC 的过程中同时有对象要放入老年代，而此时老年代空间不足（可能是 GC 过程中浮动垃圾过多导致暂时性的空间不足），便会报 Concurrent Mode Failure 错误，并触发 Full GC</p>
</li>
</ul>
<p>手动 GC 测试，VM参数：<code>-XX:+PrintGcDetails</code></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">localvarGC1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//10MB</span>
    System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">//输出: 不会被回收, FullGC时被放入老年代</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">localvarGC2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    buffer <span class="token operator">=</span> null<span class="token punctuation">;</span>
    System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">//输出: 正常被回收</span>
<span class="token punctuation">}</span>
 <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">localvarGC3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token punctuation">{</span>
         <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">//输出: 不会被回收, FullGC时被放入老年代</span>
 <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">localvarGC4</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">//输出: 正常被回收，slot复用，局部变量过了其作用域 buffer置空</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-安全区域"><a href="#2-安全区域" class="headerlink" title="2.安全区域"></a>2.安全区域</h3><p>安全点 (Safepoint)：程序执行时并非在所有地方都能停顿下来开始 GC，只有在安全点才能停下</p>
<ul>
<li>Safe Point 的选择很重要，如果太少可能导致 GC 等待的时间太长，如果太多可能导致运行时的性能问题</li>
<li>大部分指令的执行时间都非常短，通常会根据是否具有让程序长时间执行的特征为标准，选择些执行时间较长的指令作为 Safe Point， 如方法调用、循环跳转和异常跳转等</li>
</ul>
<p>在 GC 发生时，让所有线程都在最近的安全点停顿下来的方法：</p>
<ul>
<li>抢先式中断：没有虚拟机采用，首先中断所有线程，如有线程不在安全点，就恢复线程让线程运行到安全点</li>
<li>主动式中断：设置一个中断标志，各个线程运行到各个 Safe Point 时就轮询这个标志，如果中断标志为真，则将自己进行中断挂起</li>
</ul>
<p>问题：Safepoint 保证程序执行时，在不太长的时间内就会遇到可进入 GC 的 Safepoint，但是当线程处于 Waiting 状态或 Blocked 状态，线程无法响应 JVM 的中断请求，运行到安全点去中断挂起，JVM 也不可能等待线程被唤醒，对于这种情况，需要安全区域来解决</p>
<p>安全区域 (Safe Region)：指在一段代码片段中，<strong>对象的引用关系不会发生变化</strong>，在这个区域中的任何位置开始 GC 都是安全的</p>
<p>运行流程：</p>
<ul>
<li><p>当线程运行到 Safe Region 的代码时，首先标识已经进入了 Safe Region，如果这段时间内发生 GC，JVM 会忽略标识为 Safe Region 状态的线程</p>
</li>
<li><p>当线程即将离开 Safe Region 时，会检查 JVM 是否已经完成 GC，如果完成了则继续运行，否则线程必须等待 GC 完成，收到可以安全离开 Safe Region 的信号</p>
</li>
</ul>
<h3 id="3-GC分类"><a href="#3-GC分类" class="headerlink" title="3.GC分类"></a>3.GC分类</h3><ul>
<li>Minor GC：回收新生代，新生代对象存活时间很短，所以 Minor GC 会频繁执行，执行的速度比较快</li>
<li>Major GC：回收老年代。目前只有CMS收集器会有单独收集老年代的行为。</li>
<li>Mixed GC：回收整个新生代以及部分老年代的垃圾收集。目前只有G1收集器会有这种行为。</li>
<li>Full GC：回收整个Java堆和方法区。老年代对象其存活时间长，所以 Full GC 很少执行，执行速度会比 Minor GC 慢很多</li>
</ul>
<h2 id="❹垃圾判断"><a href="#❹垃圾判断" class="headerlink" title="❹垃圾判断"></a>❹垃圾判断</h2><h3 id="1-垃圾介绍"><a href="#1-垃圾介绍" class="headerlink" title="1.垃圾介绍"></a>1.垃圾介绍</h3><p>垃圾：<strong>如果一个或多个对象没有任何的引用指向它了，那么这个对象现在就是垃圾</strong></p>
<p>作用：释放没用的对象，清除内存里的记录碎片，碎片整理将所占用的堆内存移到堆的一端，以便 JVM 将整理出的内存分配给新的对象</p>
<p>区域：垃圾收集主要是针对<strong>堆</strong>和<strong>方法区</strong>进行，程序计数器、虚拟机栈和本地方法栈这三个区域属于线程私有的，只存在于线程的生命周期内，线程结束之后就会消失，因此不需要对这三个区域进行垃圾回收</p>
<p>在堆里存放着几乎所有的 Java 对象实例，在 GC 执行垃圾回收之前，首先需要区分出内存中哪些是存活对象，哪些是已经死亡的对象。只有被标记为己经死亡的对象，GC 才会在执行垃圾回收时，释放掉其所占用的内存空间，因此这个过程可以称为垃圾标记阶段，判断对象存活一般有两种方式：<strong>引用计数算法</strong>和<strong>可达性分析算法</strong></p>
<h3 id="2-引用计数法"><a href="#2-引用计数法" class="headerlink" title="2.引用计数法"></a>2.引用计数法</h3><p>引用计数算法（Reference Counting）：对每个对象保存一个整型的引用计数器属性，用于记录对象被引用的情况。对于一个对象 A，只要有任何一个对象引用了 A，则 A 的引用计数器就加 1；当引用失效时，引用计数器就减 1；当对象 A 的引用计数器的值为 0，即表示对象A不可能再被使用，可进行回收（Java 没有采用）</p>
<p>优点：</p>
<ul>
<li>回收没有延迟性，无需等到内存不够的时候才开始回收，运行时根据对象计数器是否为 0，可以直接回收</li>
<li>在垃圾回收过程中，应用无需挂起；如果申请内存时，内存不足，则立刻报 OOM 错误</li>
<li>区域性，更新对象的计数器时，只是影响到该对象，不会扫描全部对象</li>
</ul>
<p>缺点：</p>
<ul>
<li><p>每次对象被引用时，都需要去更新计数器，有一点时间开销</p>
</li>
<li><p>浪费 CPU 资源，即使内存够用，仍然在运行时进行计数器的统计。</p>
</li>
<li><p><strong>无法解决循环引用问题，会引发内存泄露</strong>（最大的缺点）</p>
</li>
</ul>
<h3 id="3-可达性分析"><a href="#3-可达性分析" class="headerlink" title="3.可达性分析"></a>3.可达性分析</h3><blockquote>
<p>可达性分析算法：也可以称为根搜索算法、追踪性垃圾收集</p>
</blockquote>
<p>GC Roots ：<strong>GC Roots 是一组活跃的引用，不是对象</strong>，放在 GC Roots Set 集合</p>
<ul>
<li>虚拟机栈中局部变量表中引用的对象：各个线程被调用的方法中使用到的参数、局部变量等</li>
<li>本地方法栈中引用的对象</li>
<li>堆中类静态属性引用的对象</li>
<li>方法区中的常量引用的对象</li>
<li>字符串常量池（string Table）里的引用</li>
<li>同步锁 synchronized 持有的对象</li>
</ul>
<p><strong>工作原理</strong></p>
<p>可达性分析算法以 GC Roots 为起始点，从上至下的方式搜索被 GC Roots  所连接的目标对象</p>
<ul>
<li><p>可达性分析算法后，内存中的存活对象都会被 GC Roots 直接或间接连接着，搜索走过的路径称为引用链</p>
</li>
<li><p>如果目标对象没有任何引用链相连，则是不可达的，就意味着该对象己经死亡，可以标记为垃圾对象</p>
</li>
<li><p>在可达性分析算法中，只有能够被 GC Roots 直接或者间接连接的对象才是存活对象</p>
</li>
</ul>
<p>分析工作必须在一个保障<strong>一致性的快照</strong>中进行，否则结果的准确性无法保证，这也是导致 GC 进行时必须 <code>Stop The World</code> 的一个原因</p>
<h3 id="4-引用分析"><a href="#4-引用分析" class="headerlink" title="4.引用分析"></a>4.引用分析</h3><p>无论是通过引用计数算法判断对象的引用数量，还是通过可达性分析算法判断对象是否可达，判定对象是否可被回收都与引用有关，Java 提供了四种强度不同的引用类型</p>
<ul>
<li><p>1.<strong>强引用</strong>：被强引用关联的对象不会被回收，只有当所有 GC Roots 都不通过【强引用】引用该对象，才能被垃圾回收</p>
<ul>
<li><p>强引用可以直接访问目标对象</p>
</li>
<li><p>虚拟机宁愿抛出 OOM 异常，也不会回收强引用所指向对象</p>
</li>
<li><p>强引用可能导致<strong>内存泄漏</strong></p>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">Object obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//使用 new 一个新对象的方式来创建强引用</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>2.<strong>软引用（SoftReference）</strong>：被软引用关联的对象只有在内存不够的情况下才会被回收</p>
<ul>
<li><p><strong>仅（可能有强引用，一个对象可以被多个引用）</strong>有软引用引用该对象时，在垃圾回收后，内存仍不足时会再次出发垃圾回收，回收软引用对象</p>
<ul>
<li><p>配合<strong>引用队列来释放软引用自身</strong>，在构造软引用时，可以指定一个引用队列，当软引用对象被回收时，就会加入指定的引用队列，通过这个队列可以跟踪对象的回收情况</p>
</li>
<li><p>软引用通常用来实现内存敏感的缓存，比如高速缓存就有用到软引用；如果还有空闲内存，就可以暂时保留缓存，当内存不足时清理掉，这样就保证了使用缓存的同时不会耗尽内存</p>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">Object obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
SoftReference<span class="token operator">&lt;</span>Object<span class="token operator">></span> sf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftReference</span><span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
obj <span class="token operator">=</span> null<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 使对象只被软引用关联</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>3.<strong>弱引用（WeakReference）</strong>：被弱引用关联的对象一定会被回收，只能存活到下一次垃圾回收发生之前</p>
<ul>
<li><p>仅有弱引用引用该对象时，在垃圾回收时，无论内存是否充足，都会回收弱引用对象</p>
<ul>
<li><p>配合引用队列来释放弱引用自身</p>
</li>
<li><p>WeakHashMap 用来存储图片信息，可以在内存不足的时候及时回收，避免了 OOM</p>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">Object obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
WeakReference<span class="token operator">&lt;</span>Object<span class="token operator">></span> wf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
obj <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>4.<strong>虚引用（PhantomReference）</strong>：也称为幽灵引用或者幻影引用，是所有引用类型中最弱的一个</p>
<ul>
<li>必须配合引用队列使用，主要配合 ByteBuffer 使用，被引用对象回收时会将虚引用入队，由 Reference Handler 线程调用虚引用相关方法释放直接内存</li>
</ul>
<ul>
<li><p>一个对象是否有虚引用的存在，不会对其生存时间造成影响，也无法通过虚引用得到一个对象</p>
<ul>
<li>为对象设置虚引用的唯一目的是在于跟踪垃圾回收过程，能在这个对象被回收时收到一个系统通知</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">Object obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
PhantomReference<span class="token operator">&lt;</span>Object<span class="token operator">></span> pf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhantomReference</span><span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
obj <span class="token operator">=</span> null<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>5.<strong>终结器引用（finalization）</strong></p>
<ul>
<li>无需手动编码，但其内部配合引用队列使用，在垃圾回收时，终结器引用入队（被引用对象暂时没有被回收），再由 Finalizer 线程通过终结器引用找到被引用对象并调用它的 finalize 方法，第二次 GC 时才能回收被引用对象</li>
</ul>
</li>
</ul>
<h3 id="5-三色标记"><a href="#5-三色标记" class="headerlink" title="5.三色标记"></a>5.三色标记</h3><h4 id="基本算法"><a href="#基本算法" class="headerlink" title="基本算法"></a>基本算法</h4><p>三色标记法把遍历对象图过程中遇到的对象，标记成以下三种颜色：</p>
<ul>
<li>白色：尚未访问过</li>
<li>灰色：正在访问的（本对象已访问过，但是本对象引用到的其他对象尚未全部访问）</li>
<li>黑色：访问完成的（本对象已访问过，而且本对象引用到的其他对象也全部访问完成）</li>
</ul>
<p>当 Stop The World (STW) 时，对象间的引用是不会发生变化的，可以轻松完成标记，遍历访问过程为：</p>
<ol>
<li><p>初始时，所有对象都在 【白色集合】中；</p>
</li>
<li><p>将 GC Roots 直接引用到的对象挪到 【灰色集合】中；</p>
</li>
<li><p>从灰色集合中获取对象：</p>
<ul>
<li>将本对象引用到的其他对象全部挪到 【灰色集合】中；</li>
<li>将本对象挪到 【黑色集合】里面。</li>
</ul>
</li>
<li><p>重复步骤3，直至【灰色集合】为空时结束。</p>
</li>
<li><p>结束后，仍在【白色集合】的对象即为 GC Roots 不可达，可以进行回收。</p>
</li>
</ol>
<img src="https://img.jwt1399.top/img/202212191451907." alt="三色标记遍历过程" style="zoom:67%;" />

<p>并发标记时，对象间的引用可能发生变化，多标和漏标的情况就有可能发生</p>
<h4 id="多标-浮动垃圾"><a href="#多标-浮动垃圾" class="headerlink" title="多标-浮动垃圾"></a>多标-浮动垃圾</h4><p><strong>多标情况：</strong>当 E 变为灰色时，断开 D 对 E 的引用，导致对象 E&#x2F;F&#x2F;G 仍会被标记为存活，本轮 GC 不会回收这部分内存，这部分本应该回收但是没有回收到的内存，被称之为<strong>浮动垃圾</strong></p>
<ul>
<li>针对并发标记开始后的<strong>新对象</strong>，通常的做法是直接全部当成黑色，也算浮动垃圾</li>
<li>浮动垃圾并不会影响应用程序的正确性，只是需要等到下一轮垃圾回收中才被清除</li>
</ul>
<img src="https://img.jwt1399.top/img/202212191503059.png" style="zoom: 50%;" />

<h4 id="漏标-读写屏障"><a href="#漏标-读写屏障" class="headerlink" title="漏标-读写屏障"></a>漏标-读写屏障</h4><p><strong>漏标情况：</strong>当 E 变为灰色时，断开 E 对 G 的引用，再让 D 引用 G。此时切回 GC 线程继续跑，因为 E 已经没有对 G 的引用了，所以不会将 G 放到灰色集合；尽管 D 重新引用了G，但 D 已经是黑色了，不会再重新做遍历处理。<br> 最终导致的结果是：G 会一直停留在白色集合中，<strong>最后被当作垃圾进行清除</strong>。这直接<strong>影响到了应用程序的正确性</strong>，是不可接受的。</p>
<img src="https://img.jwt1399.top/img/202212191513939.png" style="zoom:50%;" />

<p>即漏标只有<strong>同时满足</strong>以下两个条件时才会发生：</p>
<ul>
<li>条件一：灰色对象断开了对一个白色对象的引用（直接或间接），即灰色对象原成员变量的引用发生了变化</li>
<li>条件二：其他线程中修改了黑色对象，插入了一条或多条对该白色对象的新引用</li>
<li>结果：导致该白色对象当作垃圾被 GC，影响到了程序的正确性</li>
</ul>
<p>代码角度解释漏标：</p>
<pre class="line-numbers language-java"><code class="language-java">var G <span class="token operator">=</span> objE<span class="token punctuation">.</span>fieldG<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1.读</span>
objE<span class="token punctuation">.</span>fieldG <span class="token operator">=</span> null<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 2.写</span>
objD<span class="token punctuation">.</span>fieldG <span class="token operator">=</span> G<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// 3.写</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ol>
<li><strong>读取</strong> 对象E的成员变量fieldG的引用值，即对象G；</li>
<li>对象E 往其成员变量fieldG，<strong>写入</strong> null值。</li>
<li>对象D 往其成员变量fieldG，<strong>写入</strong> 对象G ；</li>
</ol>
<p>为了解决问题，我们只要在上面这三步中的任意一步中做一些“手脚”，<strong>将对象G记录起来，然后作为灰色对象再进行遍历</strong>即可。比如放到一个特定的集合，等初始的GC Roots遍历完（并发标记），再遍历该集合（重新标记）。</p>
<blockquote>
<p><strong>重新标记通常是需要STW的</strong>，因为应用程序一直在跑的话，该集合可能会一直增加新的对象，导致永远都跑不完。当然，并发标记期间也可以将该集合中的大部分先跑了，从而缩短重新标记STW的时间，这个是优化问题了。</p>
</blockquote>
<p>解决方法：添加读写屏障，读屏障拦截第一步，写屏障拦截第二三步，在读写前后进行一些后置处理：</p>
<ul>
<li><p><strong>写屏障 + 增量更新</strong>：黑色对象新增引用，会将黑色对象变成灰色对象，最后对该节点重新扫描，增量更新 (Incremental Update) 破坏了条件二，从而保证了不会漏标</p>
<p>缺点：对黑色变灰的对象重新扫描所有引用，比较耗费时间</p>
</li>
<li><p><strong>写屏障 (Store Barrier) + SATB</strong>：当原来成员变量的引用发生变化之前，记录下原来的引用对象</p>
<p>保留 GC 开始时的对象图，即原始快照 SATB，当 GC Roots 确定后，对象图就已经确定，那后续的标记也应该是按照这个时刻的对象图走，如果期间对白色对象有了新的引用会记录下来，并且将白色对象变灰（说明可达了，并且原始快照中本来就应该是灰色对象），最后重新扫描该对象的引用关系</p>
<p>SATB (Snapshot At The Beginning) 破坏了条件一，从而保证了不会漏标</p>
</li>
<li><p>**读屏障 (Load Barrier)**：破坏条件二，黑色对象引用白色对象的前提是获取到该对象，此时读屏障发挥作用</p>
</li>
</ul>
<p>以 Java HotSpot VM 为例，其并发标记时对漏标的处理方案如下：</p>
<ul>
<li>CMS：写屏障 + 增量更新</li>
<li>G1：写屏障 + SATB</li>
<li>ZGC：读屏障</li>
</ul>
<h3 id="6-finalization"><a href="#6-finalization" class="headerlink" title="6.finalization"></a>6.finalization</h3><p>Java 语言提供了对象终止（finalization）机制来允许开发人员提供对象被销毁之前的自定义处理逻辑</p>
<p>垃圾回收对象之前，会先调用这个对象的 <code>finalize()</code> 方法，finalize() 方法允许在子类中被重写，用于在对象被回收时进行后置处理，通常在这个方法中进行一些资源释放和清理，比如关闭文件、套接字和数据库连接等</p>
<p>生存 OR 死亡：如果从所有的根节点都无法访问到某个对象，说明对象己经不再使用，此对象需要被回收。但事实上这时候它们暂时处于缓刑阶段。<strong>一个无法触及的对象有可能在某个条件下复活自己</strong>，所以虚拟机中的对象可能的三种状态：</p>
<ul>
<li>可触及的：从根节点开始，可以到达这个对象</li>
<li>可复活的：对象的所有引用都被释放，但是对象有可能在 finalize() 中复活</li>
<li>不可触及的：对象的 finalize() 被调用并且没有复活，那么就会进入不可触及状态，不可触及的对象不可能被复活，因为 <strong>finalize() 只会被调用一次</strong>，等到这个对象再被标记为可回收时就必须回收</li>
</ul>
<p>永远不要主动调用某个对象的 finalize() 方法，应该交给垃圾回收机制调用，原因：</p>
<ul>
<li>finalize() 时可能会导致对象复活</li>
<li>finalize() 方法的执行时间是没有保障的，完全由 GC 线程决定，极端情况下，若不发生 GC，则 finalize() 方法将没有执行机会，因为优先级比较低，即使主动调用该方法，也不会因此就直接进行回收</li>
<li>一个糟糕的 finalize() 会严重影响 GC 的性能</li>
</ul>
<h3 id="7-无用属性"><a href="#7-无用属性" class="headerlink" title="7.无用属性"></a>7.无用属性</h3><h4 id="无用类"><a href="#无用类" class="headerlink" title="无用类"></a>无用类</h4><p>方法区主要回收的是无用的类</p>
<p>判定一个类是否是无用的类，需要同时满足下面 3 个条件：</p>
<ul>
<li>该类所有的实例都已经被回收，也就是 Java 堆中不存在该类的任何实例</li>
<li>加载该类的 <code>ClassLoader</code> 已经被回收</li>
<li>该类对应的 <code>java.lang.Class</code> 对象没有在任何地方被引用，无法在任何地方通过反射访问该类的方法</li>
</ul>
<p>虚拟机可以对满足上述 3 个条件的无用类进行回收，这里说的<strong>仅仅是可以</strong>，而并不是和对象一样不使用了就会必然被回收</p>
<h4 id="废弃常量"><a href="#废弃常量" class="headerlink" title="废弃常量"></a>废弃常量</h4><p>在常量池中存在字符串 “abc”，如果当前没有任何 String 对象引用该常量，说明常量 “abc” 是废弃常量，如果这时发生内存回收的话<strong>而且有必要的话</strong>（内存不够用），”abc” 就会被系统清理出常量池</p>
<h4 id="静态变量"><a href="#静态变量" class="headerlink" title="静态变量"></a>静态变量</h4><p>类加载时（第一次访问），这个类中所有静态成员就会被加载到静态变量区，该区域的成员一旦创建，直到程序退出才会被回收</p>
<p>如果是静态引用类型的变量，静态变量区只存储一份对象的引用地址，真正的对象在堆内，如果要回收该对象可以设置引用为 null</p>
<h2 id="❺回收算法"><a href="#❺回收算法" class="headerlink" title="❺回收算法"></a>❺回收算法</h2><h3 id="1-标记复制"><a href="#1-标记复制" class="headerlink" title="1.标记复制"></a>1.标记复制</h3><p>复制算法的核心就是，<strong>将原有的内存空间一分为二，每次只用其中的一块</strong>，在垃圾回收时，将正在使用的对象复制到另一个内存空间中，然后将该内存空间清理，交换两个内存的角色，完成垃圾的回收</p>
<p><img src="https://img.jwt1399.top/img/202212181546444.png"></p>
<p>算法优点：</p>
<ul>
<li>没有标记和清除过程，实现简单，运行速度快</li>
<li>复制过去以后保证空间的连续性，不会出现碎片问题</li>
</ul>
<p>算法缺点：</p>
<ul>
<li>主要不足是<strong>只使用了内存的一半</strong></li>
<li>对于 G1 这种分拆成为大量 region 的 GC，复制而不是移动，意味着 GC 需要维护 region 之间对象引用关系，不管是内存占用或者时间开销都不小</li>
</ul>
<p>基于新生代 “朝生夕灭” 的特点，大多数虚拟机都不会按照 1:1 的比例来进行内存划分，例如 HotSpot 虚拟机会将内存空间划分为一块较大的 <code>Eden</code> 和 两块较小的 <code>Survivor</code> 空间，它们之间的比例是 8:1:1 。 每次分配时只会使用 <code>Eden</code> 和其中的一块 <code>Survivor</code> ，发生垃圾回收时，只需要将存活的对象一次性复制到另外一块 <code>Survivor</code> 上，这样只有 10% 的内存空间会被浪费掉。当 <code>Survivor</code> 空间不足以容纳一次 <code>Minor GC</code> 时，此时由其他内存区域（通常是老年代）来进行分配担保。</p>
<p>应用场景：如果内存中的垃圾对象较多，需要复制的对象就较少，这种情况下适合使用该方式并且效率比较高，反之则不适合</p>
<p>现在的商业虚拟机都采用这种收集算法<strong>回收新生代</strong>，因为新生代 GC 频繁并且对象的存活率不高，但是并不是划分为大小相等的两块，而是一块较大的 Eden 空间和两块较小的 Survivor 空间</p>
<h3 id="2-标记清除"><a href="#2-标记清除" class="headerlink" title="2.标记清除"></a>2.标记清除</h3><p>标记清除算法，是将垃圾回收分为两个阶段，分别是<strong>标记和清除</strong></p>
<ul>
<li><p><strong>标记</strong>：Collector 从引用根节点开始遍历，标记所有被引用的对象，一般是在对象的 Header 中记录为可达对象，<strong>标记的是引用的对象，不是垃圾</strong></p>
</li>
<li><p><strong>清除</strong>：Collector 对堆内存从头到尾进行线性的遍历，如果发现某个对象在其 Header 中没有标记为可达对象，则将其回收，把分块连接到<strong>空闲列表</strong>的单向链表，判断回收后的分块与前一个空闲分块是否连续，若连续会合并这两个分块，之后进行分配时只需要遍历这个空闲列表，就可以找到分块</p>
</li>
<li><p><strong>分配阶段</strong>：程序会搜索空闲链表寻找空间大于等于新对象大小 size 的块 block，如果找到的块等于 size，会直接返回这个分块；如果找到的块大于 size，会将块分割成大小为 size 与 block - size 的两部分，返回大小为 size 的分块，并把大小为 block - size 的块返回给空闲列表</p>
</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212181546206.png"></p>
<p>算法缺点：</p>
<ul>
<li>标记和清除过程效率都不高</li>
<li>会产生大量不连续的内存碎片，导致无法给大对象分配内存，需要维护一个空闲链表</li>
</ul>
<p>算法优点：</p>
<ul>
<li>速度较快</li>
</ul>
<h3 id="3-标记整理"><a href="#3-标记整理" class="headerlink" title="3.标记整理"></a>3.标记整理</h3><p>标记整理（压缩）算法是在标记清除算法的基础之上，做了优化改进的算法</p>
<ul>
<li>标记阶段和标记清除算法一样，也是从根节点开始，将对象的引用进行标记</li>
<li>清理阶段，并不是简单的直接清理可回收对象，而是<strong>将存活对象都向内存另一端移动</strong>，然后清理边界以外的垃圾，从而<strong>解决了碎片化</strong>的问题</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212181547195.png"></p>
<p>优点：不会产生内存碎片</p>
<p>缺点：需要移动大量对象，处理效率比较低</p>
<h3 id="4-对比总结"><a href="#4-对比总结" class="headerlink" title="4.对比总结"></a>4.对比总结</h3><table>
<thead>
<tr>
<th align="center">算法</th>
<th align="center">速度</th>
<th align="center">空间开销</th>
<th align="center">移动对象</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>复制算法</strong></td>
<td align="center">最快</td>
<td align="center">通常需要活对象的 2 倍大小（不堆积碎片）</td>
<td align="center">是</td>
</tr>
<tr>
<td align="center"><strong>标记清除</strong></td>
<td align="center">中等</td>
<td align="center">少（但会堆积碎片）</td>
<td align="center">否</td>
</tr>
<tr>
<td align="center"><strong>标记整理</strong></td>
<td align="center">最慢</td>
<td align="center">少（不堆积碎片）</td>
<td align="center">是</td>
</tr>
</tbody></table>
<h2 id="❻垃圾回收器"><a href="#❻垃圾回收器" class="headerlink" title="❻垃圾回收器"></a>❻垃圾回收器</h2><h3 id="0-概述"><a href="#0-概述" class="headerlink" title="0.概述"></a>0.概述</h3><h4 id="a-垃圾收集器分类"><a href="#a-垃圾收集器分类" class="headerlink" title="a.垃圾收集器分类"></a>a.垃圾收集器分类</h4><ul>
<li>按线程数分（垃圾回收线程数），可以分为<strong>串行垃圾回收器</strong>和<strong>并行垃圾回收器</strong><ul>
<li>除了 CMS 和 G1 之外，其它垃圾收集器都是以串行(并发也是串行)的方式执行</li>
</ul>
</li>
<li>按照工作模式分，可以分为<strong>并发式垃圾回收器</strong>和<strong>独占式垃圾回收器</strong><ul>
<li>并发式垃圾回收器与应用程序线程交替工作，以尽可能减少应用程序的停顿时间</li>
<li>独占式垃圾回收器（Stop the world）一旦运行，就停止应用程序中的所有用户线程，直到垃圾回收过程完全结束</li>
</ul>
</li>
<li>按碎片处理方式分，可分为<strong>压缩式垃圾回收器</strong>和<strong>非压缩式垃圾回收器</strong><ul>
<li>压缩式垃圾回收器在回收完成后进行压缩整理，消除回收后的碎片，再分配对象空间使用指针碰撞</li>
<li>非压缩式的垃圾回收器不进行这步操作，再分配对象空间使用空闲列表</li>
</ul>
</li>
<li>按工作的内存区间分，又可分为<strong>年轻代垃圾回收器</strong>和<strong>老年代垃圾回收器</strong></li>
</ul>
<h4 id="b-GC-性能指标"><a href="#b-GC-性能指标" class="headerlink" title="b.GC 性能指标"></a>b.GC 性能指标</h4><ul>
<li>吞吐量：程序的运行时间占总运行时间的比例（总运行时间 &#x3D; 程序的运行时间 + 内存回收的时间）</li>
<li>垃圾收集开销：吞吐量的补数，垃圾收集所用时间与总运行时间的比例</li>
<li>暂停时间：执行垃圾收集时，程序的工作线程被暂停的时间</li>
<li>收集频率：相对于应用程序的执行，收集操作发生的频率</li>
<li>内存占用：Java 堆区所占的内存大小</li>
<li>快速：一个对象从诞生到被回收所经历的时间</li>
<li>吞吐量优先：单位时间内，STW（stop the world，停掉其他所有工作线程）时间最短</li>
<li>响应时间优先：尽可能让单次STW时间变短（尽量不影响其他线程运行）</li>
</ul>
<h4 id="c-垃圾收集器的组合关系"><a href="#c-垃圾收集器的组合关系" class="headerlink" title="c.垃圾收集器的组合关系"></a>c.垃圾收集器的组合关系</h4><ul>
<li><p>新生代收集器：Serial、ParNew、Parallel Scavenge</p>
</li>
<li><p>老年代收集器：Serial old、Parallel old、CMS</p>
</li>
<li><p>整堆收集器：G1</p>
</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212191543682.png">红色虚线在 JDK9 移除、绿色虚线在 JDK14 弃用该组合、青色虚线在 JDK14 删除 CMS 垃圾回收器</p>
<p>Serial GC、Parallel GC、Concurrent Mark Sweep GC 这三个 GC  不同：</p>
<ul>
<li>最小化地使用内存和并行开销，选 Serial GC</li>
<li>最大化应用程序的吞吐量，选 Parallel GC</li>
<li>最小化 GC 的中断或停顿时间，选 CMS GC</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212181620954.png"></p>
<p>查看默认的垃圾收回收器：</p>
<ul>
<li><p><code>-XX:+PrintcommandLineFlags</code>：查看命令行相关参数（包含使用的垃圾收集器）</p>
</li>
<li><p>使用命令行指令：jinfo -flag 相关垃圾回收器参数  进程 ID</p>
</li>
</ul>
<h3 id="1-Serial-x2F-Serial-old"><a href="#1-Serial-x2F-Serial-old" class="headerlink" title="1.Serial&#x2F;Serial old"></a>1.Serial&#x2F;Serial old</h3><p><strong>Serial</strong>：串行垃圾收集器，作用于新生代，使用单线程进行垃圾回收，采用<strong>复制算法</strong>，新生代基本都是复制算法</p>
<p><strong>STW（Stop-The-World）</strong>：垃圾回收时，只有一个线程在工作，并且 Java 应用中的所有线程都要暂停，等待垃圾回收的完成</p>
<p><strong>Serial old</strong>：执行老年代垃圾回收的串行收集器，内存回收算法使用的是<strong>标记-整理算法</strong>，同样也采用了串行回收和 STW 机制</p>
<ul>
<li>Serial old 是 Client 模式下默认的老年代的垃圾回收器</li>
<li>Serial old 在 Server 模式下主要有两个用途：<ul>
<li>在 JDK 1.5 以及之前版本（Parallel Old 诞生以前）中与 Parallel Scavenge 收集器搭配使用</li>
<li>作为老年代 CMS 收集器的<strong>后备垃圾回收方案</strong>，在并发收集发生 Concurrent Mode Failure 时使用</li>
</ul>
</li>
</ul>
<p>开启参数：<code>-XX:+UseSerialGC</code> 等价于新生代用 Serial GC 且老年代用 Serial old GC</p>
<p><img src="https://img.jwt1399.top/img/202212191545395.png"></p>
<p>优点：简单而高效（与其他收集器的单线程比），对于限定单个 CPU 的环境来说，Serial 收集器由于没有线程交互的开销，可以获得最高的单线程收集效率</p>
<p>缺点：对于交互性较强的应用而言，这种垃圾收集器是不能够接受的，比如 JavaWeb 应用</p>
<h3 id="2-ParNew"><a href="#2-ParNew" class="headerlink" title="2.ParNew"></a>2.ParNew</h3><p>Par 是 Parallel 并行的缩写，New 是只能处理的是新生代</p>
<p>并行垃圾收集器在串行垃圾收集器的基础之上做了改进，<strong>采用复制算法</strong>，将单线程改为了多线程进行垃圾回收，可以缩短垃圾回收的时间</p>
<p>对于其他的行为（收集算法、stop the world、对象分配规则、回收策略等）同 Serial 收集器一样，应用在年轻代，除 Serial 外，只有<strong>ParNew GC 能与 CMS 收集器配合工作</strong></p>
<p>相关参数：</p>
<ul>
<li><p><code>-XX：+UseParNewGC</code>：表示新生代使用并行收集器，不影响老年代</p>
</li>
<li><p><code>-XX:ParallelGCThreads</code>：默认开启和 CPU 数量相同的线程数</p>
</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212191545235.png"></p>
<p>ParNew 是很多 JVM 运行在 Server 模式下新生代的默认垃圾收集器</p>
<ul>
<li>对于新生代，回收次数频繁，使用并行方式高效</li>
<li>对于老年代，回收次数少，使用串行方式节省资源（CPU 并行需切换线程，串行可以省去切换线程的资源）</li>
</ul>
<h3 id="3-Parallel-x2F-Parallel-Old"><a href="#3-Parallel-x2F-Parallel-Old" class="headerlink" title="3.Parallel&#x2F;Parallel Old"></a>3.Parallel&#x2F;Parallel Old</h3><p>Parallel Scavenge 收集器：是应用于新生代的并行垃圾回收器，<strong>采用复制算法</strong>、并行回收和 Stop the World 机制</p>
<p>Parallel Old ：是应用于老年代的并行垃圾回收器，<strong>采用标记-整理算法</strong></p>
<p>对比其他回收器：</p>
<ul>
<li>其它收集器目标是尽可能缩短垃圾收集时用户线程的停顿时间</li>
<li>Parallel 目标是达到一个可控制的吞吐量，被称为<strong>吞吐量优先</strong>收集器</li>
<li>Parallel Scavenge 对比 ParNew 拥有<strong>自适应调节策略</strong>，可以通过一个开关参数打开 GC Ergonomics</li>
</ul>
<p>应用场景：</p>
<ul>
<li>停顿时间越短就越适合需要与用户交互的程序，良好的响应速度能提升用户体验</li>
<li>高吞吐量可以高效率地利用 CPU 时间，尽快完成程序的运算任务，适合在后台运算而不需要太多交互</li>
</ul>
<p>停顿时间和吞吐量的关系：新生代空间变小 → 缩短停顿时间 → 垃圾回收变得频繁 → 导致吞吐量下降</p>
<p>在注重吞吐量及 CPU 资源敏感的场合，都可以优先考虑 Parallel Scavenge + Parallel Old 收集器，在 Server 模式下的内存回收性能很好，<strong>Java8 默认是此垃圾收集器组合</strong></p>
<p><img src="https://img.jwt1399.top/img/202212191559772.png"></p>
<p>参数配置：</p>
<ul>
<li><code>-XX：+UseParallelGC</code>：手动指定年轻代使用 Paralle 并行收集器执行内存回收任务</li>
<li><code>-XX：+UseParalleloldcc</code>：手动指定老年代使用并行回收收集器执行内存回收任务<ul>
<li>上面两个参数，默认开启一个，另一个也会被开启（互相激活），默认 JDK8 是开启的</li>
</ul>
</li>
<li><code>-XX:+UseAdaptivesizepplicy</code>：设置 Parallel Scavenge 收集器具有<strong>自适应调节策略</strong>，在这种模式下，年轻代的大小、Eden 和 Survivor 的比例、晋升老年代的对象年龄等参数会被自动调整，虚拟机会根据当前系统的运行情况收集性能监控信息，动态调整这些参数以提供最合适的停顿时间或者最大的吞吐量</li>
<li><code>-XX:ParallelGcThreads</code>：设置年轻代并行收集器的线程数，一般与 CPU 数量相等，以避免过多的线程数影响垃圾收集性能<ul>
<li>在默认情况下，当 CPU 数量小于 8 个，ParallelGcThreads 的值等于 CPU 数量</li>
<li>当 CPU 数量大于 8 个，ParallelGCThreads 的值等于 3+[5*CPU Count]&#x2F;8]</li>
</ul>
</li>
<li><code>-XX:MaxGCPauseMillis</code>：设置垃圾收集器最大停顿时间（即 STW 的时间），单位是毫秒<ul>
<li>对于用户来讲，停顿时间越短体验越好；在服务器端，注重高并发，整体的吞吐量</li>
<li>为了把停顿时间控制在 MaxGCPauseMillis 以内，收集器在工作时会调整 Java 堆大小或其他一些参数</li>
</ul>
</li>
<li><code>-XX:GCTimeRatio</code>：垃圾收集时间占总时间的比例 &#x3D;1&#x2F;(N+1)，用于衡量吞吐量的大小<ul>
<li>取值范围（0，100）。默认值 99，也就是垃圾回收时间不超过 1</li>
<li>与 <code>-xx:MaxGCPauseMillis</code> 参数有一定矛盾性，暂停时间越长，Radio 参数就容易超过设定的比例</li>
</ul>
</li>
</ul>
<h3 id="4-CMS"><a href="#4-CMS" class="headerlink" title="4.CMS"></a>4.CMS</h3><blockquote>
<p>Concurrent Mark Sweep（CMS），是一款<strong>并发的、使用标记-清除</strong>算法、<strong>响应时间优先</strong>、<strong>针对老年代</strong>的垃圾回收器，其最大特点是<strong>让垃圾收集线程与用户线程同时工作</strong></p>
</blockquote>
<p>CMS 收集器的关注点是尽可能缩短垃圾收集时用户线程的停顿时间，停顿时间越短（<strong>低延迟</strong>）越适合与用户交互的程序，良好的响应速度能提升用户体验</p>
<p>分为以下四个流程：</p>
<ul>
<li><strong>初始标记</strong>：仅标记 GC Roots 能直接关联到的对象，速度很快，出现短暂STW</li>
<li><strong>并发标记</strong>：进行 GC Roots 开始遍历整个对象图，在整个回收过程中耗时最长，不需要 STW，可以与用户线程并发运行</li>
<li><strong>重新标记</strong>：修正并发标记期间因用户程序继续运作而导致标记产生变动的那一部分对象，比初始标记时间长但远比并发标记时间短，需要 STW（不停顿就会一直变化，采用写屏障 + 增量更新来避免漏标情况）</li>
<li><strong>并发清除</strong>：清除标记为可以回收的对象，<strong>不需要移动存活对象</strong>，所以这个阶段可以与用户线程同时并发的</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212192100642.png"></p>
<p>Mark Sweep 会造成内存碎片，不把算法换成 Mark Compact 的原因：Mark Compact 算法会整理内存，导致用户线程使用的<strong>对象的地址改变</strong>，影响用户线程继续执行</p>
<p>在整个过程中耗时最长的并发标记和并发清除过程中，收集器线程都可以与用户线程一起工作，不需要进行停顿</p>
<p>优点：并发收集、低延迟</p>
<p>缺点：</p>
<ul>
<li><p>吞吐量降低：在并发阶段虽然不会导致用户停顿，但是会因为占用了一部分线程而导致应用程序变慢，CPU 利用率不够高</p>
</li>
<li><p>CMS 收集器<strong>无法处理浮动垃圾</strong>，可能出现 Concurrent Mode Failure 导致另一次 Full GC 的产生</p>
<p>浮动垃圾是指并发清除阶段由于用户线程继续运行而产生的垃圾（产生了新对象），这部分垃圾只能到下一次 GC 时才能进行回收。由于浮动垃圾的存在，CMS 收集需要预留出一部分内存，不能等待老年代快满的时候再回收。如果预留的内存不够存放浮动垃圾，就会出现 Concurrent Mode Failure，这时虚拟机将临时启用 Serial Old 来替代 CMS，导致很长的停顿时间</p>
</li>
<li><p>标记 - 清除算法导致的空间碎片，往往出现老年代空间无法找到足够大连续空间来分配当前对象，不得不提前触发一次 Full GC；为新对象分配内存空间时，将无法使用指针碰撞（Bump the Pointer）技术，而只能够选择空闲列表（Free List）执行内存分配</p>
</li>
</ul>
<p>参数设置：</p>
<ul>
<li><p><code>-XX：+UseConcMarkSweepGC</code>：手动指定使用 CMS 收集器执行内存回收任务</p>
<p>开启该参数后会自动将 <code>-XX:+UseParNewGC</code> 打开，即：ParNew + CMS + Serial old的组合</p>
</li>
<li><p><code>-XX:CMSInitiatingoccupanyFraction</code>：设置堆内存使用率的阈值，一旦达到该阈值，便开始进行回收</p>
<ul>
<li>JDK5 及以前版本的默认值为 68，即当老年代的空间使用率达到 68% 时，会执行一次CMS回收</li>
<li>JDK6 及以上版本默认值为 92%</li>
</ul>
</li>
<li><p><code>-XX:+UseCMSCompactAtFullCollection</code>：用于指定在执行完 Full GC 后对内存空间进行压缩整理，以此避免内存碎片的产生，由于内存压缩整理过程无法并发执行，所带来的问题就是停顿时间变得更长</p>
</li>
<li><p><code>-XX:CMSFullGCsBeforecompaction</code>：<strong>设置在执行多少次 Full GC 后对内存空间进行压缩整理</strong></p>
</li>
<li><p><code>-XX:ParallelCMSThreads</code>：设置 CMS 的线程数量</p>
<ul>
<li>CMS 默认启动的线程数是 (ParallelGCThreads+3)&#x2F;4，ParallelGCThreads 是年轻代并行收集器的线程数</li>
<li>收集线程占用的 CPU 资源多于25%，对用户程序影响可能较大；当 CPU 资源比较紧张时，受到 CMS 收集器线程的影响，应用程序的性能在垃圾回收阶段可能会非常糟糕</li>
</ul>
</li>
</ul>
<h3 id="5-G1"><a href="#5-G1" class="headerlink" title="5.G1"></a>5.G1</h3><blockquote>
<p>G1（Garbage-First）是一款面向服务端应用的垃圾收集器，<strong>应用于新生代和老年代</strong>、采用<strong>标记-整理</strong>算法、<strong>响应时间优先</strong>、软实时、低延迟、可设定目标（最大 STW 停顿时间）的垃圾回收器，用于代替 CMS，适用于较大的堆（&gt;4 ~ 6G），在 JDK9 之后默认使用 G1</p>
<p>JDK 9发布之日，G1宣告取代Parallel Scavenge加Parallel Old组合，成为服务端模式下的默认垃圾收集器，而CMS则沦落至被声明为不推荐使用（Deprecate）的收集器</p>
<p>应用场景：</p>
<ul>
<li>面向服务端应用，针对具有大内存、多处理器的机器</li>
<li>需要低 GC 延迟，并具有大堆的应用程序提供解决方案</li>
</ul>
</blockquote>
<h4 id="G1-优点"><a href="#G1-优点" class="headerlink" title="G1 优点"></a>G1 优点</h4><ul>
<li>并发与并行：<ul>
<li>并行性：G1 在回收期间，可以有多个 GC 线程同时工作，有效利用多核计算能力，此时用户线程 STW</li>
<li>并发性：G1 拥有与应用程序交替执行的能力，部分工作可以和应用程序同时执行，因此不会在整个回收阶段发生完全阻塞应用程序的情况</li>
<li>其他的垃圾收集器使用<strong>内置的 JVM 线程</strong>执行 GC 的多线程操作，而 G1 GC 可以采用<strong>应用线程</strong>承担后台运行的 GC 工作，JVM 的 GC 线程处理速度慢时，系统会<strong>调用应用程序线程加速垃圾回收</strong>过程</li>
</ul>
</li>
</ul>
<ul>
<li><p>分区算法：</p>
<ul>
<li><p>从分代上看，G1  属于分代型垃圾回收器，区分年轻代和老年代，年轻代依然有 Eden 区和 Survivor 区。从堆结构上看，<strong>新生代和老年代不再物理隔离</strong>，不用担心每个代内存是否足够，这种特性有利于程序长时间运行，分配大对象时不会因为无法找到连续内存空间而提前触发下一次 GC</p>
</li>
<li><p>G1 把堆划分成多个大小相等的独立区域（<strong>Region</strong>），使得每个小空间可以单独进行垃圾回收</p>
<ul>
<li><p>将整个堆划分成约 2048 个大小相同的独立 Region 块，所有 Region 大小相同，在 JVM 生命周期内不会被改变。</p>
</li>
<li><p>每个Region的大小可以通过参数<code>-XX：G1HeapRegionSize</code>设定，取值范围为1MB～32MB之间且为 2 的 N 次幂</p>
</li>
<li><p>Region中还有一类特殊的 <strong>Humongous 区域</strong>，专门用来存储大对象，本身属于老年代区。G1认为只要大小超过了一个Region容量一半的对象即可判定为大对象。如果一个 H 区装不下一个巨型对象，那么 G1 会寻找连续的 H 分区来存储，为了能找到连续的 H 区，有时候不得不启动 Full GC</p>
</li>
<li><p>G1 不会对巨型对象进行拷贝，回收时被优先考虑，G1 会跟踪老年代所有 incoming 引用，这样老年代 incoming 引用为 0 的巨型对象就可以在新生代垃圾回收时处理掉</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212201526217.png" alt="Region 结构图"></p>
<ul>
<li><p>空间整合：</p>
<ul>
<li>CMS：标记-清除算法、内存碎片、若干次 GC 后进行一次碎片整理</li>
<li>G1：整体来看是<strong>基于标记 - 整理算法实现</strong>的收集器，从局部（Region 之间）上来看是<strong>基于复制算法实现</strong>的，两种算法都可以避免内存碎片</li>
</ul>
</li>
<li><p>可预测的停顿时间模型（软实时 soft real-time）：</p>
<ul>
<li>可以指定在 M 毫秒的时间片段内，消耗在 GC 上的时间不得超过 N 毫秒</li>
<li>由于分块的原因，G1 可以只选取部分区域进行内存回收，这样缩小了回收的范围，对于全局停顿情况也能得到较好的控制</li>
<li>G1 跟踪各个 Region 里面的垃圾堆积的价值大小（回收所获得的空间大小以及回收所需时间，通过过去回收的经验获得），在后台维护一个<strong>优先列表</strong>，每次根据允许的收集时间优先回收价值最大的 Region，保证了 G1 收集器在有限的时间内可以获取尽可能高的收集效率</li>
</ul>
<ul>
<li>相比于 CMS GC，G1 未必能做到 CMS 在最好情况下的延时停顿，但是最差情况要好很多</li>
<li>通过<code>-XX：MaxGCPauseMillis</code>参数指定的停顿时间只意味着垃圾收集发生之前的期望值</li>
</ul>
</li>
</ul>
<h4 id="G1-缺点"><a href="#G1-缺点" class="headerlink" title="G1 缺点"></a>G1 缺点</h4><ul>
<li>相较于 CMS，G1 还不具备全方位、压倒性优势。比如在用户程序运行过程中，G1 无论是为了垃圾收集产生的内存占用还是程序运行时的额外执行负载都要比 CMS 要高</li>
<li>从经验上来说，在小内存应用上 CMS 的表现大概率会优于 G1，而 G1 在大内存应用上则发挥其优势，平衡点在 6-8GB 之间</li>
</ul>
<h4 id="记忆集-RSet"><a href="#记忆集-RSet" class="headerlink" title="记忆集-RSet"></a>记忆集-RSet</h4><p>为解决对象跨代引用所带来的问题，垃圾收集器在新生代中建立了名为记忆集（Remembered Set）的数据结构，用以避免把整个老年代加进 GC Roots 扫描范围。</p>
<p>记忆集 Remembered Set 在新生代中，每个 Region 都有一个 Remembered Set，用来记录被哪些其他 Region 里的对象引用（谁引用了我就记录谁）</p>
<img src="https://img.jwt1399.top/img/202212211532056.png" style="zoom:67%;" />

<p>通过写屏障来更新记忆集：</p>
<p>程序对 Reference 类型数据写操作时，产生一个写屏障 Write Barrier 暂时中断操作，检查该对象和 Reference 类型数据是否在不同的 Region（跨代引用），不同就将相关引用信息记录到 Reference 类型所属的 Region 的 Remembered Set 之中，进行内存回收时，在 GC 根节点的枚举范围中加入 Remembered Set 即可保证不对全堆扫描也不会有遗漏</p>
<h4 id="卡表-Card-Table"><a href="#卡表-Card-Table" class="headerlink" title="卡表-Card Table"></a>卡表-Card Table</h4><p>垃圾收集器在新生代中建立了<strong>记忆集</strong>这样的数据结构，可以理解为它是一个抽象类，具体实现记忆集的三种方式：</p>
<ul>
<li><p>字长精度：每个记录精确到一个机器字长（就是处理器的寻址位数，如常见的32位或64位，这个精度决定了机器访问物理内存地址的指针长度），该字包含跨代指针。</p>
</li>
<li><p>对象精度：每个记录精确到一个对象，该对象里有字段含有跨代指针。</p>
</li>
<li><p>**卡精度(卡表)**：每个记录精确到一块内存区域，该区域内有对象含有跨代指针。</p>
</li>
</ul>
<blockquote>
<p>卡表（Card Table）在老年代中，是一种对记忆集的具体实现，主要定义了记忆集的记录精度、与堆内存的映射关系等</p>
</blockquote>
<p>卡表中的每一个元素都对应着一块特定大小的内存块，这个内存块称之为卡页（card page），当存在跨代引用时，会将卡页标记为 dirty，在垃圾收集发生时，只要筛选出卡表中 dirty 的元素，就能轻易得出哪些卡页内存块中包含跨代指针，把它们加入GC Roots中一并扫描。JVM 对于卡页的维护也是通过写屏障的方式</p>
<p><img src="https://img.jwt1399.top/img/202212211651174.png"></p>
<h4 id="写屏障-Write-Barrier"><a href="#写屏障-Write-Barrier" class="headerlink" title="写屏障-Write Barrier"></a>写屏障-Write Barrier</h4><blockquote>
<p>我们已经解决了如何使用记忆集来缩减GC Roots扫描范围的问题，但还没有解决卡表元素如何维护的问题，例如它们何时变脏、谁来把它们变脏等。</p>
</blockquote>
<p><strong>卡表元素何时变脏</strong></p>
<p>有其他分代区域中对象引用了本区域对象时，其对应的卡表元素就应该变脏，变脏时间点原则上应该发生在引用类型字段赋值的那一刻。</p>
<p><strong>如何变脏，即如何在对象赋值的那一刻去更新维护卡表呢？</strong></p>
<p>在HotSpot虚拟机里是通过写屏障（Write Barrier）技术维护卡表状态的。</p>
<p>写屏障可以看作在虚拟机层面对“引用类型字段赋值”这个动作的AOP切面，在引用对象赋值时会产生一个环形（Around）通知，供程序执行额外的动作，也就是说赋值的前后都在写屏障的覆盖范畴内。在赋值前的部分的写屏障叫作写前屏障（Pre-Write Barrier），在赋值后的则叫作写后屏障（Post-Write Barrier）。HotSpot虚拟机的许多收集器中都有使用到写屏障，但直至G1收集器出现之前，其他收集器都只用到了写后屏障。</p>
<p>应用写屏障后，虚拟机就会为所有赋值操作生成相应的指令，一旦收集器在写屏障中增加了更新卡表操作，无论更新的是不是老年代对新生代对象的引用，每次只要对引用进行更新，就会产生额外的开销，不过这个开销与Minor GC时扫描整个老年代的代价相比还是低得多的。</p>
<h4 id="回收集-CSet"><a href="#回收集-CSet" class="headerlink" title="回收集-CSet"></a>回收集-CSet</h4><p>Collection Set 代表每次 GC 暂停时回收的一系列目标分区，在任意一次收集暂停中，CSet 所有分区都会被释放，内部存活的对象都会被转移到分配的空闲分区中。年轻代收集 CSet 只容纳年轻代分区，而混合收集会通过启发式算法，在老年代候选回收分区中，筛选出回收收益最高的分区添加到 CSet 中</p>
<p>CSet根据两种不同的回收类型分为两种不同CSet。</p>
<ul>
<li><p>CSet of Young Collection</p>
<ul>
<li>只专注回收 Young Region 跟 Survivor Region</li>
</ul>
</li>
<li><p>CSet of Mix Collection</p>
<ul>
<li><p>则会通过RSet计算Region中对象的活跃度，</p>
</li>
<li><p>活跃度阈值<code>-XX:G1MixedGCLiveThresholdPercent</code>(默认85%)，只有活跃度高于这个阈值的才会准入CSet</p>
</li>
<li><p>还可通过<code>-XX:G1OldCSetRegionThresholdPercent</code>(默认10%)设置，CSet跟整个堆的比例的数量上限。</p>
</li>
</ul>
</li>
</ul>
<h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><p>G1 中提供了三种垃圾回收模式：YoungGC、Mixed GC 和 Full GC，在不同的条件下被触发</p>
<ul>
<li>当堆内存使用达到一定值（默认 45%）时，开始老年代并发标记过程</li>
<li>标记完成马上开始混合回收过程</li>
</ul>
<img src="https://img.jwt1399.top/img/202212211518167.png" style="zoom: 50%;" />

<p>顺时针：Minor GC → Minor GC + Concurrent Mark → Mixed GC 顺序，进行垃圾回收</p>
<ul>
<li><p><strong>Minor GC</strong>：发生在年轻代的 GC 算法，一般对象（除了巨型对象）都是在 Eden 区 中分配内存，当Eden 区被耗尽无法申请内存时，就会触发一次 Minor GC，G1 停止应用程序的执行 STW，把活跃对象放入老年代，垃圾对象回收</p>
<p><strong>回收过程</strong>：</p>
<ol>
<li>扫描根：根引用连同 RSet 记录的外部引用作为扫描存活对象的入口</li>
<li>更新 RSet：处理 dirty card queue 更新 RSet，此后 RSet 准确的反映对象的引用关系<ul>
<li>dirty card queue：类似缓存，产生了引用先记录在这里，然后更新到 RSet</li>
<li>作用：产生引用直接更新 RSet 需要线程同步开销很大，使用队列性能好</li>
</ul>
</li>
<li>处理 RSet：识别被老年代对象指向的 Eden 中的对象，这些被指向的对象被认为是存活的对象，把需要回收的分区放入 Young CSet 中进行回收</li>
<li>复制对象：Eden 区内存段中存活的对象会被复制到 survivor 区，survivor 区内存段中存活的对象如果年龄未达阈值，年龄会加1，达到阀值会被会被复制到 Old 区中空的内存分段，如果 survivor 空间不够，Eden 空间的部分数据会直接晋升到老年代空间</li>
<li>处理引用：处理 Soft，Weak，Phantom，JNI Weak  等引用，最终 Eden 空间的数据为空，GC 停止工作</li>
</ol>
</li>
<li><p>**Concurrent Mark **：</p>
<ul>
<li><p><strong>初始标记</strong>（Initial Marking）：仅仅只是标记一下GC Roots能直接关联到的对象，这个阶段是 STW 的，并且会触发一次 Minor GC</p>
</li>
<li><p><strong>并发标记</strong> (Concurrent Marking）：从GC Root开始对堆中对象进行可达性分析，递归扫描整个堆里的对象图，找出要回收的对象，这阶段耗时较长，但可与用户程序并发执行。当对象图扫描完成以后，还要重新处理SATB记录下的在并发时有引用变动的对象。</p>
<ul>
<li>老年代占用堆空间比例达到阈值时，就会进行并发标记 </li>
<li><code>-XX:InitiatingHeapOccupancyPercent</code> 设置阈值（默认45%）</li>
</ul>
</li>
<li><p><strong>最终标记</strong>（Final Marking）：为了修正在并发标记期间因用户程序继续运作而导致标记产生变动的那一部分标记记录，虚拟机将这段时间对象变化记录在线程的 Remembered Set Logs 里面，最终标记阶段需要把 Remembered Set Logs 的数据合并到 Remembered Set 中，对用户线程做另一个短暂 STW，用于处理并发阶段结束后仍遗留下来的最后那少量的SATB记录。但是可并行执行（<strong>防止漏标</strong>）</p>
</li>
<li><p>筛选回收（Live Data Counting and Evacuation）：首先对 CSet 中各个 Region 中的回收价值和成本进行排序，根据用户所期望的 GC 停顿时间来制定回收计划，也需要 STW，由多条收集器线程并行完成的。</p>
</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212201631402.jpg"></p>
</li>
<li><p><strong>Mixed GC</strong>：当很多对象晋升到老年代时，为了避免堆内存被耗尽，虚拟机会触发一个混合的垃圾收集器，即 Mixed GC，除了回收整个 young region，还会回收一部分的 old region。</p>
<p>注意：<strong>是一部分老年代，而不是全部老年代</strong>，选择回收价值高的老年代 region 进行回收，从而对垃圾回收的时间进行控制</p>
<p><code>-XX:MaxGCPauseMillis</code>：设置期望达到的最大 GC 停顿时间指标，JVM会尽力实现，但不保证达到，默认值是 200ms</p>
</li>
<li><p><strong>Full GC</strong>：对象内存分配速度过快，Mixed GC 来不及回收，导致老年代被填满，就会触发一次 Full GC，G1 的 Full GC 算法就是单线程执行的垃圾回收，会导致长时间的暂停时间，需要进行不断的调优，尽可能的避免 Full GC</p>
<p>产生 Full GC 的原因：</p>
<ul>
<li>晋升时没有足够的空间存放晋升的对象</li>
<li>并发处理过程完成之前空间耗尽，浮动垃圾</li>
</ul>
</li>
</ul>
<h4 id="相关参数"><a href="#相关参数" class="headerlink" title="相关参数"></a>相关参数</h4><ul>
<li><code>-XX:+UseG1GC</code>：手动指定使用 G1 垃圾收集器执行内存回收任务</li>
<li><code>-XX:G1HeapRegionSize</code>：设置每个 Region 的大小。值是 2 的幂，范围是 1MB 到 32MB 之间，目标是根据最小的 Java 堆大小划分出约 2048 个区域，默认是堆内存的 1&#x2F;2000</li>
<li><code>-XX:MaxGCPauseMillis</code>：设置期望达到的最大 GC 停顿时间指标，JVM会尽力实现，但不保证达到，默认值是 200ms</li>
<li><code>-XX:+ParallelGcThread</code>：设置 STW 时 GC 线程数的值，最多设置为 8</li>
<li><code>-XX:ConcGCThreads</code>：设置并发标记线程数，设置为并行垃圾回收线程数 ParallelGcThreads 的1&#x2F;4左右</li>
<li><code>-XX:InitiatingHeapOccupancyPercent</code>：设置并发标记阈值，默认值是 45</li>
<li><code>-XX:+ClassUnloadingWithConcurrentMark</code>：并发标记类卸载，默认启用，所有对象都经过并发标记后，就可以知道哪些类不再被使用，当一个类加载器的所有类都不再使用，则卸载它所加载的所有类</li>
<li><code>-XX:G1NewSizePercent</code>：新生代占用整个堆内存的最小百分比（默认5％） </li>
<li><code>-XX:G1MaxNewSizePercent</code>：新生代占用整个堆内存的最大百分比（默认60％） </li>
<li><code>-XX:G1ReservePercent=10</code>：保留内存区域，防止Survivor中的 to 区溢出</li>
</ul>
<h4 id="调优"><a href="#调优" class="headerlink" title="调优"></a>调优</h4><p>G1 的设计原则就是简化 JVM 性能调优，只需要简单的三步即可完成调优：</p>
<ol>
<li>开启 G1 垃圾收集器</li>
<li>设置堆的最大内存</li>
<li>设置最大的停顿时间（STW）</li>
</ol>
<p>不断调优暂停时间指标：</p>
<ul>
<li><code>-XX:MaxGCPauseMillis=x</code> 可以设置启动应用程序暂停的时间，G1会根据这个参数选择 CSet 来满足响应时间的设置</li>
<li>设置到 100ms 或者 200ms 都可以（不同情况下会不一样），但设置成50ms就不太合理</li>
<li>暂停时间设置的太短，就会导致出现 G1 跟不上垃圾产生的速度，最终退化成 Full GC</li>
<li>对这个参数的调优是一个持续的过程，逐步调整到最佳状态</li>
</ul>
<p>不要设置新生代和老年代的大小：</p>
<ul>
<li>避免使用 <code>-Xmn</code> 或 <code>-XX:NewRatio</code> 等相关选项显式设置年轻代大小，G1 收集器在运行的时候会调整新生代和老年代的大小，从而达到我们为收集器设置的暂停时间目标</li>
<li>设置了新生代大小相当于放弃了 G1 的自动调优，我们只需要设置整个堆内存的大小，剩下的交给 G1 自己去分配各个代的大小</li>
</ul>
<h3 id="6-ZGC"><a href="#6-ZGC" class="headerlink" title="6.ZGC"></a>6.ZGC</h3><blockquote>
<p>ZGC 收集器是JDK 11中推出的一个可伸缩的、低延迟的垃圾收集器，基于 Region 内存布局的，不设分代，使用了<strong>读屏障</strong>、<strong>染色指针</strong>和<strong>内存多重映射</strong>等技术来实现<strong>可并发的标记-整理算法</strong></p>
</blockquote>
<ul>
<li>在 CMS 和 G1 中都用到了写屏障，而 ZGC 用到了读屏障</li>
<li>染色指针：直接<strong>将少量额外的信息存储在指针上的技术</strong>，从 64 位的指针中拿高 4 位来标识对象此时的状态<ul>
<li>染色指针可以使某个 Region 的存活对象被移走之后，这个 Region 立即就能够被释放和重用</li>
<li>可以直接从指针中看到引用对象的三色标记状态（Marked0、Marked1）、是否进入了重分配集、是否被移动过（Remapped）、是否只能通过 finalize() 方法才能被访问到（Finalizable）</li>
<li>可以大幅减少在垃圾收集过程中内存屏障的使用数量，写屏障的目的通常是为了记录对象引用的变动情况，如果将这些信息直接维护在指针中，显然就可以省去一些专门的记录操作</li>
<li>可以作为一种可扩展的存储结构用来记录更多与对象标记、重定位过程相关的数据</li>
</ul>
</li>
<li>内存多重映射：多个虚拟地址指向同一个物理地址</li>
</ul>
<ul>
<li>可并发的标记整理算法：染色指针标识对象是否被标记或移动，读屏障保证在每次应用程序或 GC 程序访问对象时先根据染色指针的标识判断是否被移动，如果被移动就根据转发表访问新的移动对象，<strong>并更新引用</strong>，不会像 G1 一样必须等待垃圾回收完成才能访问</li>
</ul>
<p>ZGC 目标：</p>
<ul>
<li>停顿时间不会超过 10ms</li>
<li>停顿时间不会随着堆的增大而增大（不管多大的堆都能保持在 10ms 以下）</li>
<li>可支持几百 M，甚至几 T 的堆大小（最大支持4T）</li>
</ul>
<p>ZGC 的工作过程可以分为 4 个阶段：</p>
<ul>
<li><strong>并发标记</strong>（Concurrent Mark）： 遍历对象图做可达性分析的阶段，做可达性分析的阶段，前后也要经过类似于G1的初始标记和最终标记的短暂停顿。与G1不同的是，ZGC的标记是在指针上而不是在对象上进行的，标记阶段会更新染色指针中的Marked 0、Marked 1标志位。</li>
<li><strong>并发预备重分配</strong>（Concurrent Prepare for Relocate）：根据特定的查询条件统计得出本次收集过程要清理哪些 Region，将这些 Region 组成重分配集（Relocation Set）</li>
<li><strong>并发重分配</strong>（Concurrent Relocate）： 重分配是 ZGC 执行过程中的核心阶段，这个过程要把重分配集中的存活对象复制到新的 Region 上，并为重分配集中的<strong>每个 Region 维护一个转发表</strong>（Forward Table），记录从旧地址到新地址的转向关系</li>
<li><strong>并发重映射</strong>（Concurrent Remap）：修正整个堆中指向重分配集中旧对象的所有引用，ZGC 的并发映射并不是一个必须要立即完成的任务，ZGC 很巧妙地把并发重映射阶段要做的工作，合并到下一次垃圾收集循环中的并发标记阶段里去完成，因为都是要遍历所有对象，这样合并节省了一次遍历的开销</li>
</ul>
<p>ZGC 几乎在所有地方并发执行的，除了初始标记的是 STW 的，但这部分的实际时间是非常少的，所以响应速度快，在尽可能对吞吐量影响不大的前提下，实现在任意堆内存大小下都可以把垃圾收集的停顿时间限制在十毫秒以内的低延迟</p>
<p>优点：高吞吐量、低延迟</p>
<p>缺点：浮动垃圾，当 ZGC 准备要对一个很大的堆做一次完整的并发收集，其全过程要持续十分钟以上，由于应用的对象分配速率很高，将创造大量的新对象产生浮动垃圾</p>
<p>对比：</p>
<p>G1 需要通过写屏障来维护记忆集，才能处理跨代指针，得以实现Region的增量回收。记忆集要占用大量的内存空间，写屏障也对正常程序运行造成额外负担，这些都是权衡选择的代价。</p>
<p>ZGC就完全没有使用记忆集，它甚至连分代都没有，连像CMS中那样只记录新生代和老年代间引用的卡表也不需要，因而完全没有用到写屏障，所以给用户线程带来的运行负担也要小得多。可是，当 ZGC 准备要对一个很大的堆做一次完整的并发收集，其全过程要持续十分钟以上，由于应用的对象分配速率很高，将创造大量的新对象产生浮动垃圾</p>
<p><a target="_blank" rel="noopener" href="https://tech.meituan.com/2020/08/06/new-zgc-practice-in-meituan.html">新一代垃圾回收器ZGC的探索与实践 - 美团技术团队 (meituan.com)</a></p>
<h3 id="对比总结"><a href="#对比总结" class="headerlink" title="对比总结"></a>对比总结</h3><ul>
<li>最小化地使用内存和并行开销，选 Serial GC</li>
<li>最大化应用程序的吞吐量，选 Parallel GC</li>
<li>最小化 GC 的中断或停顿时间，选 CMS GC</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212181620954.png"></p>
<p>jdk8环境下，默认使用 Parallel Scavenge + Parallel Old</p>
<h1 id="④类加载"><a href="#④类加载" class="headerlink" title="④类加载"></a>④类加载</h1><h2 id="❶类文件结构"><a href="#❶类文件结构" class="headerlink" title="❶类文件结构"></a>❶类文件结构</h2><pre class="line-numbers language-java"><code class="language-java">ClassFile <span class="token punctuation">{</span>
    u4             magic<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//Class 文件的标志</span>
    u2             minor_version<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Class 的小版本号</span>
    u2             major_version<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Class 的大版本号</span>
    u2             constant_pool_count<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//常量池的数量</span>
    cp_info        constant_pool<span class="token punctuation">[</span>constant_pool_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//常量池</span>
    u2             access_flags<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Class 的访问标记</span>
    u2             this_class<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//当前类</span>
    u2             super_class<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//父类</span>
    u2             interfaces_count<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//接口</span>
    u2             interfaces<span class="token punctuation">[</span>interfaces_count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//一个类可以实现多个接口</span>
    u2             fields_count<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Class 文件的字段属性</span>
    field_info     fields<span class="token punctuation">[</span>fields_count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//一个类可以有多个字段</span>
    u2             methods_count<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//Class 文件的方法数量</span>
    method_info    methods<span class="token punctuation">[</span>methods_count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//一个类可以有个多个方法</span>
    u2             attributes_count<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//此类的属性表中的属性数</span>
    attribute_info attributes<span class="token punctuation">[</span>attributes_count<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//属性表集合</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<table>
<thead>
<tr>
<th>类型</th>
<th>名称</th>
<th>说明</th>
<th>长度</th>
<th>数量</th>
</tr>
</thead>
<tbody><tr>
<td>u4</td>
<td>magic</td>
<td>魔数，识别类文件格式</td>
<td>4个字节</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>minor_version</td>
<td>副版本号(小版本)</td>
<td>2个字节</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>major_version</td>
<td>主版本号(大版本)</td>
<td>2个字节</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>constant_pool_count</td>
<td>常量池计数器</td>
<td>2个字节</td>
<td>1</td>
</tr>
<tr>
<td>cp_info</td>
<td>constant_pool</td>
<td>常量池表</td>
<td>n个字节</td>
<td>constant_pool_count-1</td>
</tr>
<tr>
<td>u2</td>
<td>access_flags</td>
<td>访问标识</td>
<td>2个字节</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>this_class</td>
<td>类索引</td>
<td>2个字节</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>super_class</td>
<td>父类索引</td>
<td>2个字节</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>interfaces_count</td>
<td>接口计数</td>
<td>2个字节</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>interfaces</td>
<td>接口索引集合</td>
<td>2个字节</td>
<td>interfaces_count</td>
</tr>
<tr>
<td>u2</td>
<td>fields_count</td>
<td>字段计数器</td>
<td>2个字节</td>
<td>1</td>
</tr>
<tr>
<td>field_info</td>
<td>fields</td>
<td>字段表</td>
<td>n个字节</td>
<td>fields_count</td>
</tr>
<tr>
<td>u2</td>
<td>methods_count</td>
<td>方法计数器</td>
<td>2个字节</td>
<td>1</td>
</tr>
<tr>
<td>method_info</td>
<td>methods</td>
<td>方法表</td>
<td>n个字节</td>
<td>methods_count</td>
</tr>
<tr>
<td>u2</td>
<td>attributes_count</td>
<td>属性计数器</td>
<td>2个字节</td>
<td>1</td>
</tr>
<tr>
<td>attribute_info</td>
<td>attributes</td>
<td>属性表</td>
<td>n个字节</td>
<td>attributes_count</td>
</tr>
</tbody></table>
<p>Class 文件格式只有两种数据类型：无符号数和表</p>
<ul>
<li>无符号数属于基本的数据类型，以 u1、u2、u4、u8 来分别代表1个字节、2个字节、4个字节和8个字节的无符号数，无符号数可以用来描述数字、索引引用、数量值或者按照 UTF-8 编码构成字符串</li>
<li>表是由多个无符号数或者其他表作为数据项构成的复合数据类型，表都以 <code>_info</code> 结尾，用于描述有层次关系的数据，整个 Class 文件本质上就是一张表，由于表没有固定长度，所以通常会在其前面加上个数说明</li>
</ul>
<p>Class 文件获取方式：</p>
<ul>
<li>HelloWorld.java 执行 <code>javac -g xxx.java</code>指令</li>
<li>写入文件指令 <code>javap -v xxx.class &gt;xxx.txt</code></li>
<li>IDEA 插件 jclasslib 、桌面版 <a target="_blank" rel="noopener" href="https://github.com/ingokegel/jclasslib">jclasslib</a>、<a target="_blank" rel="noopener" href="https://github.com/Konloch/bytecode-viewer">bytecode-viewer</a></li>
</ul>
<img src="https://img.jwt1399.top/img/202212221701410.jpeg" style="zoom: 25%;" />

<h3 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h3><p>接下来以下面代码进行讲解类文件结构</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> JJTest<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        num <span class="token operator">=</span> num <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> num<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面代码的字节码对应的16进制</p>
<p><img src="https://img.jwt1399.top/img/202212231012766.png"></p>
<h3 id="魔数"><a href="#魔数" class="headerlink" title="魔数"></a>魔数</h3><p>每个 Class 文件开头的 4 个字节的无符号整数称为魔数（Magic Number），是 Class 文件的标识符，代表这是一个能被虚拟机接受的有效合法的 Class 文件，</p>
<ul>
<li><p>魔数值固定为 <code>0xCAFEBABE</code>，不符合则会抛出错误</p>
</li>
<li><p>使用魔数而不是扩展名来进行识别主要是基于安全方面的考虑，因为文件扩展名可以随意地改动</p>
</li>
</ul>
<h3 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h3><p>4 个 字节，5 6两个字节代表的是编译的副版本号 minor_version，7 8 两个字节是编译的主版本号 major_version</p>
<ul>
<li>不同版本的 Java 编译器编译的 Class 文件对应的版本是不一样的，高版本的 Java 虚拟机可以执行由低版本编译器生成的 Class 文件，反之 JVM 会抛出异常 <code>java.lang.UnsupportedClassVersionError</code></li>
<li>案例中<code>00 34</code>： 转换成 10 进制 16*3+4 &#x3D; 52，代表 JDK1.8</li>
</ul>
<table>
<thead>
<tr>
<th>主版本（十进制）</th>
<th>副版本（十进制）</th>
<th>编译器版本</th>
</tr>
</thead>
<tbody><tr>
<td>45</td>
<td>3</td>
<td>1.1</td>
</tr>
<tr>
<td>46</td>
<td>0</td>
<td>1.2</td>
</tr>
<tr>
<td>47</td>
<td>0</td>
<td>1.3</td>
</tr>
<tr>
<td>48</td>
<td>0</td>
<td>1.4</td>
</tr>
<tr>
<td>49</td>
<td>0</td>
<td>1.5</td>
</tr>
<tr>
<td>50</td>
<td>0</td>
<td>1.6</td>
</tr>
<tr>
<td>51</td>
<td>0</td>
<td>1.7</td>
</tr>
<tr>
<td>52</td>
<td>0</td>
<td>1.8</td>
</tr>
<tr>
<td>53</td>
<td>0</td>
<td>1.9</td>
</tr>
<tr>
<td>54</td>
<td>0</td>
<td>1.10</td>
</tr>
<tr>
<td>55</td>
<td>0</td>
<td>1.11</td>
</tr>
</tbody></table>
<h3 id="常量池计数器"><a href="#常量池计数器" class="headerlink" title="常量池计数器"></a>常量池计数器</h3><ul>
<li><p>由于常量池中常量的数量不固定，所以放置 u2 类型的无符号数表示常量池计数器（constant_pool_count）</p>
</li>
<li><p>常量池计数器值：从1开始，表示常量池中有多少项常量。即constant_pool_count&#x3D;1表示常量池中有0个常量项。</p>
</li>
<li><p>这个计数器是从 1 而不是 0 开始，是为了满足后面某些指向常量池的索引值的数据在特定情况下需要表达不引用任何一个常量池项目，这种情况可用索引值 0 来表示</p>
</li>
<li><p>案例中 <code>00 16</code>：转换成10进制 22，因此有 21 个常量池</p>
</li>
</ul>
<h3 id="常量池"><a href="#常量池" class="headerlink" title="常量池"></a>常量池</h3><p>constant_pool 是一种表结构，以 1 ~ constant_pool_count - 1 为索引，表明有多少个常量池表项。表项中存放编译时期生成的各种字面量和符号引用，这部分内容将在类加载后进入方法区的运行时常量池</p>
<ul>
<li><p>字面量（Literal） ：基本数据类型、字符串类型常量、声明为 final 的常量值等</p>
</li>
<li><p>符号引用（Symbolic References）：类和接口的全限定名、字段的名称和描述符、方法的名称和描述符</p>
<ul>
<li><p>全限定名：com&#x2F;test&#x2F;Demo 这个就是类的全限定名，仅仅是把包名的 <code>.</code> 替换成 <code>/</code>，为了使连续的多个全限定名之间不产生混淆，在使用时最后一般会加入一个 <code>;</code> 表示全限定名结束</p>
</li>
<li><p>简单名称：指没有类型和参数修饰的方法或者字段名称，比如字段 x 的简单名称就是 x</p>
</li>
<li><p>描述符：用来描述字段的数据类型、方法的参数列表（包括数量、类型以及顺序）和返回值</p>
<table>
<thead>
<tr>
<th>标志符</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>B</td>
<td>基本数据类型 byte</td>
</tr>
<tr>
<td>C</td>
<td>基本数据类型 char</td>
</tr>
<tr>
<td>D</td>
<td>基本数据类型 double</td>
</tr>
<tr>
<td>F</td>
<td>基本数据类型 float</td>
</tr>
<tr>
<td>I</td>
<td>基本数据类型 int</td>
</tr>
<tr>
<td>J</td>
<td>基本数据类型 long</td>
</tr>
<tr>
<td>S</td>
<td>基本数据类型 short</td>
</tr>
<tr>
<td>Z</td>
<td>基本数据类型 boolean</td>
</tr>
<tr>
<td>V</td>
<td>代表 void 类型</td>
</tr>
<tr>
<td>L</td>
<td>对象类型，比如：<code>Ljava/lang/Object;</code>，不同方法间用<code>;</code>隔开</td>
</tr>
<tr>
<td>[</td>
<td>数组类型，代表一维数组。比如：<code>double[][][] is [[[D</code></td>
</tr>
</tbody></table>
</li>
</ul>
</li>
</ul>
<p>常量池中常量类型</p>
<p>常量池的每一项常量都是一个表，表开始的第一位是一个 u1 类型的标志位（tag），代表当前这个常量属于哪种常量类型。</p>
<p><img src="https://img.jwt1399.top/img/202212230943482.png"></p>
<p>18 种常量没有出现 byte、short、char，boolean 的原因：编译之后都可以理解为 Integer</p>
<ul>
<li>案例中 <code>0a 00 04 00 12</code>： <ul>
<li>0a –&gt; 10 –&gt; CONSTANT_Methodref_info  –&gt; u2 u2</li>
<li>u2：00 04 –&gt; CONSTANT_Class_info #4 –&gt; CONSTANT_Class_info #21 –&gt; java&#x2F;lang&#x2F;Object</li>
<li>u2：00 12 –&gt; CONSTANT_NameAndType_info #18 –&gt; CONSTANT_Class_info #7  &amp; CONSTANT_Class_info #8  –&gt; &lt;init&gt; &amp; ()V 【无参返回值void】</li>
</ul>
</li>
</ul>
<h3 id="访问标识"><a href="#访问标识" class="headerlink" title="访问标识"></a>访问标识</h3><p>访问标识（access_flag），又叫访问标志、访问标记，该标识用两个字节表示，用于识别一些类或者接口层次的访问信息，包括这个 Class 是类还是接口，是否定义为 public类型，是否定义为 abstract类型等</p>
<ul>
<li>类的访问权限通常为 ACC_ 开头的常量</li>
<li>每一种类型的表示都是通过设置访问标记的 32 位中的特定位来实现的，比如若是 public final 的类，则该标记为 <code>ACC_PUBLIC | ACC_FINAL</code></li>
<li>使用 <code>ACC_SUPER</code> 可以让类更准确地定位到父类的方法，确定类或接口里面的 invokespecial 指令使用的是哪一种执行语义，现代编译器都会设置并且使用这个标记</li>
<li>案例中 <code>00 21</code> ： 0x0001 + 0x0020 代表 ACC_PUBLIC 和 ACC_SUPER</li>
</ul>
<table>
<thead>
<tr>
<th>标志名称</th>
<th>标志值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>ACC_PUBLIC</td>
<td>0x0001</td>
<td>标志为 public 类型</td>
</tr>
<tr>
<td>ACC_FINAL</td>
<td>0x0010</td>
<td>标志被声明为 final，只有类可以设置</td>
</tr>
<tr>
<td>ACC_SUPER</td>
<td>0x0020</td>
<td>标志允许使用 invokespecial 字节码指令的新语义，JDK1.0.2之后编译出来的类的这个标志默认为真，使用增强的方法调用父类方法</td>
</tr>
<tr>
<td>ACC_INTERFACE</td>
<td>0x0200</td>
<td>标志这是一个接口</td>
</tr>
<tr>
<td>ACC_ABSTRACT</td>
<td>0x0400</td>
<td>是否为 abstract 类型，对于接口或者抽象类来说，次标志值为真，其他类型为假</td>
</tr>
<tr>
<td>ACC_SYNTHETIC</td>
<td>0x1000</td>
<td>标志此类并非由用户代码产生（由编译器产生的类，没有源码对应）</td>
</tr>
<tr>
<td>ACC_ANNOTATION</td>
<td>0x2000</td>
<td>标志这是一个注解</td>
</tr>
<tr>
<td>ACC_ENUM</td>
<td>0x4000</td>
<td>标志这是一个枚举</td>
</tr>
</tbody></table>
<h3 id="索引集合"><a href="#索引集合" class="headerlink" title="索引集合"></a>索引集合</h3><p>本类索引、父类索引、接口索引集合</p>
<ul>
<li><p>本类索引用于确定这个类的全限定名</p>
<ul>
<li>案例中<code>00 03</code> ： cp_info #3 【即3号常量池】–&gt; cp_info #20 –&gt; JJTest&#x2F;Demo</li>
</ul>
</li>
<li><p>父类索引用于确定这个类的父类的全限定名，Java 语言不允许多重继承，所以父类索引只有一个，除了Object 之外，所有的 Java 类都有父类，因此除了 java.lang.Object 外，所有 Java 类的父类索引都不为0</p>
<ul>
<li>案例中<code>00 04</code>：cp_info #4 –&gt; cp_info #21 –&gt; java&#x2F;lang&#x2F;Object</li>
</ul>
</li>
<li><p>接口索引集合就用来描述这个类实现了哪些接口</p>
<ul>
<li>interfaces_count 项的值表示当前类或接口的直接超接口数量</li>
<li>interfaces[] 接口索引集合，被实现的接口将按 implements 语句后的接口顺序从左到右排列在接口索引集合中</li>
<li>案例中<code>00 00</code>：表示当前类没有实现接口</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>长度</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>u2</td>
<td>this_class</td>
</tr>
<tr>
<td>u2</td>
<td>super_class</td>
</tr>
<tr>
<td>u2</td>
<td>interfaces_count</td>
</tr>
<tr>
<td>u2</td>
<td>interfaces[interfaces_count]</td>
</tr>
</tbody></table>
<h3 id="字段表"><a href="#字段表" class="headerlink" title="字段表"></a>字段表</h3><p>字段 fields 用于描述接口或类中声明的变量，包括类变量以及实例变量，但不包括方法内部、代码块内部声明的局部变量（local variables）以及从父类或父接口继承。字段叫什么名字、被定义为什么数据类型，都是无法固定的，只能引用常量池中的常量来描述</p>
<p>fields_count（字段计数器），表示当前 class 文件 fields 表的成员个数，用两个字节来表示</p>
<ul>
<li>案例中 <code>00 01</code>：表示当前 class 文件只有一个字段，即num</li>
</ul>
<p>fields[]（字段表）：</p>
<ul>
<li>fields表中的每个成员都是一个 fields_info 结构的数据项，用于表示当前类或接口中某个字段的完整描述</li>
</ul>
<table>
<thead>
<tr>
<th>标志名称</th>
<th>标志值</th>
<th>含义</th>
<th>数量</th>
</tr>
</thead>
<tbody><tr>
<td>u2</td>
<td>access_flags</td>
<td>访问标志</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>name_index</td>
<td>字段名索引</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>descriptor_index</td>
<td>描述符索引</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>attributes_count</td>
<td>属性计数器</td>
<td>1</td>
</tr>
<tr>
<td>attribute_info</td>
<td>attributes</td>
<td>属性集合</td>
<td>attributes_count</td>
</tr>
</tbody></table>
<p>字段访问标志：</p>
<ul>
<li>案例中 <code>00 02</code>：ACC_PRIVATE，字段为private</li>
</ul>
<table>
<thead>
<tr>
<th>标志名称</th>
<th>标志值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>ACC_PUBLIC</td>
<td>0x0001</td>
<td>字段是否为public</td>
</tr>
<tr>
<td>ACC_PRIVATE</td>
<td>0x0002</td>
<td>字段是否为private</td>
</tr>
<tr>
<td>ACC_PROTECTED</td>
<td>0x0004</td>
<td>字段是否为protected</td>
</tr>
<tr>
<td>ACC_STATIC</td>
<td>0x0008</td>
<td>字段是否为static</td>
</tr>
<tr>
<td>ACC_FINAL</td>
<td>0x0010</td>
<td>字段是否为final</td>
</tr>
<tr>
<td>ACC_VOLATILE</td>
<td>0x0040</td>
<td>字段是否为volatile</td>
</tr>
<tr>
<td>ACC_TRANSTENT</td>
<td>0x0080</td>
<td>字段是否为transient</td>
</tr>
<tr>
<td>ACC_SYNCHETIC</td>
<td>0x1000</td>
<td>字段是否为由编译器自动产生</td>
</tr>
<tr>
<td>ACC_ENUM</td>
<td>0x4000</td>
<td>字段是否为enum</td>
</tr>
</tbody></table>
<p>字段名索引：根据该值查询常量池中的指定索引项即可</p>
<ul>
<li>案例中 <code>00 05</code>：cp_info #5 –&gt;num</li>
</ul>
<p>描述符索引：用来描述字段的数据类型、方法的参数列表和返回值</p>
<ul>
<li>案例中 <code>00 06</code>：cp_info #6  –&gt; I –&gt; 整型</li>
</ul>
<table>
<thead>
<tr>
<th>字符</th>
<th>类型</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>B</td>
<td>byte</td>
<td>有符号字节型树</td>
</tr>
<tr>
<td>C</td>
<td>char</td>
<td>Unicode字符，UTF-16编码</td>
</tr>
<tr>
<td>D</td>
<td>double</td>
<td>双精度浮点数</td>
</tr>
<tr>
<td>F</td>
<td>float</td>
<td>单精度浮点数</td>
</tr>
<tr>
<td>I</td>
<td>int</td>
<td>整型数</td>
</tr>
<tr>
<td>J</td>
<td>long</td>
<td>长整数</td>
</tr>
<tr>
<td>S</td>
<td>short</td>
<td>有符号短整数</td>
</tr>
<tr>
<td>Z</td>
<td>boolean</td>
<td>布尔值true&#x2F;false</td>
</tr>
<tr>
<td>V</td>
<td>void</td>
<td>代表void类型</td>
</tr>
<tr>
<td>L Classname</td>
<td>reference</td>
<td>一个名为Classname的实例</td>
</tr>
<tr>
<td>[</td>
<td>reference</td>
<td>一个一维数组</td>
</tr>
</tbody></table>
<p>属性表集合：属性个数存放在 attribute_count 中，属性具体内容存放在 attribute 数组中，一个字段还可能拥有一些属性，用于存储更多的额外信息，比如常量的初始化值、一些注释信息等，对于常量属性而言，attribute_length 值恒为2</p>
<ul>
<li>案例中 <code>00 00</code>：当前字段没有属性</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">ConstantValue_attribute<span class="token punctuation">{</span>
    u2 attribute_name_index<span class="token punctuation">;</span>
    u4 attribute_length<span class="token punctuation">;</span>
    u2 constantvalue_index<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="方法表"><a href="#方法表" class="headerlink" title="方法表"></a>方法表</h3><p>方法表是 methods 指向常量池索引集合，其中每一个 method_info 项都对应着一个类或者接口中的方法信息，完整描述了每个方法的签名</p>
<ul>
<li>如果这个方法不是抽象的或者不是 native 的，字节码中就会体现出来</li>
<li>methods 表只描述当前类或接口中声明的方法，不包括从父类或父接口继承的方法<ul>
<li>methods 表可能会出现由编译器自动添加的方法，比如初始化方法 &lt;clinit&gt; 和实例化方法 &lt;init&gt;</li>
</ul>
</li>
</ul>
<p>要重载（Overload）一个方法，除了要与原方法具有相同的简单名称之外，还要求必须拥有一个与原方法不同的特征签名，特征签名就是一个方法中各个参数在常量池中的字段符号引用的集合，因为返回值不会包含在特征签名之中，因此 Java 语言里无法仅仅依靠返回值的不同来对一个已有方法进行重载。但在 Class 文件格式中，特征签名的范围更大一些，只要描述符不是完全一致的两个方法就可以共存</p>
<p>methods_count（方法计数器）：表示 class 文件 methods 表的成员个数，使用两个字节来表示</p>
<ul>
<li>案例中<code>00 02</code>：表示两个方法，&lt;init&gt; 和 add</li>
</ul>
<p>methods[]（方法表）：每个表项都是一个 method_info 结构，表示当前类或接口中某个方法的完整描述</p>
<p>方法表结构如下：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>名称</th>
<th>含义</th>
<th>数量</th>
</tr>
</thead>
<tbody><tr>
<td>u2</td>
<td>access_flags</td>
<td>访问标志</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>name_index</td>
<td>字段名索引</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>descriptor_index</td>
<td>描述符索引</td>
<td>1</td>
</tr>
<tr>
<td>u2</td>
<td>attrubutes_count</td>
<td>属性计数器</td>
<td>1</td>
</tr>
<tr>
<td>attribute_info</td>
<td>attributes</td>
<td>属性集合</td>
<td>attributes_count</td>
</tr>
</tbody></table>
<p>方法表访问标志：</p>
<table>
<thead>
<tr>
<th>标志名称</th>
<th>标志值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>ACC_PUBLIC</td>
<td>0x0001</td>
<td>public，方法可以从包外访问</td>
</tr>
<tr>
<td>ACC_PRIVATE</td>
<td>0x0002</td>
<td>private，方法只能本类访问</td>
</tr>
<tr>
<td>ACC_PROTECTED</td>
<td>0x0004</td>
<td>protected，方法在自身和子类可以访问</td>
</tr>
<tr>
<td>ACC_STATIC</td>
<td>0x0008</td>
<td>static，静态方法</td>
</tr>
</tbody></table>
<ul>
<li><p>案例中<code>00 01</code>：ACC_PUBLIC，public，方法可以从包外访问</p>
</li>
<li><p>案例中<code>00 07</code>：&lt;init&gt; ，实例初始化方法</p>
</li>
<li><p>案例中<code>00 08</code>：()V，无参，返回值类型void</p>
</li>
<li><p>案例中<code>00 01</code>：当前方法有一个属性</p>
</li>
</ul>
<h3 id="属性表"><a href="#属性表" class="headerlink" title="属性表"></a>属性表</h3><p>属性表集合，指的是 Class 文件所携带的辅助信息，比如该 Class 文件的源文件的名称，以及任何带有 <code>RetentionPolicy.CLASS</code> 或者 <code>RetentionPolicy.RUNTIME</code> 的注解，这类信息通常被用于 Java 虚拟机的验证和运行，以及 Java 程序的调试。字段表、方法表都可以有自己的属性表，用于描述某些场景专有的信息</p>
<p>attributes_ count（属性计数器）：表示当前文件属性表的成员个数</p>
<ul>
<li>案例中<code>00 01</code>：表示有1个属性表</li>
</ul>
<p>attributes[]（属性表）：属性表的每个项的值必须是 attribute_info 结构</p>
<ul>
<li><p>案例中<code>00 10</code>：属性名索引 cp_info #16 –&gt;SourceFile</p>
</li>
<li><p>案例中<code>00 00 00 02</code>：属性长度为 2</p>
</li>
<li><p>案例中<code>00 11</code>：源码文件素引cp_info #17 –&gt;Demo.java</p>
</li>
<li><p>属性的通用格式：</p>
<pre class="line-numbers language-java"><code class="language-java">ConstantValue_attribute<span class="token punctuation">{</span>
    u2 attribute_name_index<span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">//属性名索引</span>
    u4 attribute_length<span class="token punctuation">;</span>		 <span class="token comment" spellcheck="true">//属性长度</span>
    u2 attribute_info<span class="token punctuation">;</span>			<span class="token comment" spellcheck="true">//属性表</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>属性类型：</p>
<table>
<thead>
<tr>
<th>属性名称</th>
<th>使用位置</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>Code</td>
<td>方法表</td>
<td>Java 代码编译成的字节码指令</td>
</tr>
<tr>
<td>ConstantValue</td>
<td>字段表</td>
<td>final 关键字定义的常量池</td>
</tr>
<tr>
<td>Deprecated</td>
<td>类、方法、字段表</td>
<td>被声明为 deprecated 的方法和字段</td>
</tr>
<tr>
<td>Exceptions</td>
<td>方法表</td>
<td>方法抛出的异常</td>
</tr>
<tr>
<td>EnclosingMethod</td>
<td>类文件</td>
<td>仅当一个类为局部类或者匿名类是才能拥有这个属性，这个属性用于标识这个类所在的外围方法</td>
</tr>
<tr>
<td>InnerClass</td>
<td>类文件</td>
<td>内部类列表</td>
</tr>
<tr>
<td>LineNumberTable</td>
<td>Code 属性</td>
<td>Java 源码的行号与字节码指令的对应关系</td>
</tr>
<tr>
<td>LocalVariableTable</td>
<td>Code 属性</td>
<td>方法的局部变量描述</td>
</tr>
<tr>
<td>StackMapTable</td>
<td>Code 属性</td>
<td>JDK1.6 中新增的属性，供新的类型检查检验器检查和处理目标方法的局部变量和操作数有所需要的类是否匹配</td>
</tr>
<tr>
<td>Signature</td>
<td>类，方法表，字段表</td>
<td>用于支持泛型情况下的方法签名</td>
</tr>
<tr>
<td>SourceFile</td>
<td>类文件</td>
<td>记录源文件名称</td>
</tr>
<tr>
<td>SourceDebugExtension</td>
<td>类文件</td>
<td>用于存储额外的调试信息</td>
</tr>
<tr>
<td>Syothetic</td>
<td>类，方法表，字段表</td>
<td>标志方法或字段为编泽器自动生成的</td>
</tr>
<tr>
<td>LocalVariableTypeTable</td>
<td>类</td>
<td>使用特征签名代替描述符，是为了引入泛型语法之后能描述泛型参数化类型而添加</td>
</tr>
<tr>
<td>RuntimeVisibleAnnotations</td>
<td>类，方法表，字段表</td>
<td>为动态注解提供支持</td>
</tr>
<tr>
<td>RuntimelnvisibleAnnotations</td>
<td>类，方法表，字段表</td>
<td>用于指明哪些注解是运行时不可见的</td>
</tr>
<tr>
<td>RuntimeVisibleParameterAnnotation</td>
<td>方法表</td>
<td>作用与 RuntimeVisibleAnnotations 属性类似，只不过作用对象为方法</td>
</tr>
<tr>
<td>RuntirmelnvisibleParameterAnniotation</td>
<td>方法表</td>
<td>作用与 RuntimelnvisibleAnnotations 属性类似，作用对象哪个为方法参数</td>
</tr>
<tr>
<td>AnnotationDefauit</td>
<td>方法表</td>
<td>用于记录注解类元素的默认值</td>
</tr>
<tr>
<td>BootstrapMethods</td>
<td>类文件</td>
<td>用于保存 invokeddynanic 指令引用的引导方式限定符</td>
</tr>
</tbody></table>
<h3 id="部分属性详解"><a href="#部分属性详解" class="headerlink" title="部分属性详解"></a>部分属性详解</h3><h4 id="①-ConstantValue属性"><a href="#①-ConstantValue属性" class="headerlink" title="① ConstantValue属性"></a>① ConstantValue属性</h4><p>ConstantValue属性表示一个常量字段的值。位于field_info结构的属性表中。</p>
<h4 id="②-Deprecated-属性"><a href="#②-Deprecated-属性" class="headerlink" title="② Deprecated 属性"></a>② Deprecated 属性</h4><p>Deprecated 属性是在JDK1.1为了支持注释中的关键词@deprecated而引入的。</p>
<h4 id="③-Code属性"><a href="#③-Code属性" class="headerlink" title="③ Code属性"></a>③ Code属性</h4><p>Code属性就是存放方法体里面的代码。但是，并非所有方法表都有Code属性。像接口或者抽象方法，他们没有具体的方法体，因此也就不会有Code属性了。Code属性表的结构，如下图：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>名称</th>
<th>数量</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>u2</td>
<td>attribute_name_index</td>
<td>1</td>
<td>属性名索引</td>
</tr>
<tr>
<td>u4</td>
<td>attribute_length</td>
<td>1</td>
<td>属性长度</td>
</tr>
<tr>
<td>u2</td>
<td>max_stack</td>
<td>1</td>
<td>操作数栈深度的最大值</td>
</tr>
<tr>
<td>u2</td>
<td>max_locals</td>
<td>1</td>
<td>局部变量表所需的存续空间</td>
</tr>
<tr>
<td>u4</td>
<td>code_length</td>
<td>1</td>
<td>字节码指令的长度</td>
</tr>
<tr>
<td>u1</td>
<td>code</td>
<td>code_lenth</td>
<td>存储字节码指令</td>
</tr>
<tr>
<td>u2</td>
<td>exception_table_length</td>
<td>1</td>
<td>异常表长度</td>
</tr>
<tr>
<td>exception_info</td>
<td>exception_table</td>
<td>exception_length</td>
<td>异常表</td>
</tr>
<tr>
<td>u2</td>
<td>attributes_count</td>
<td>1</td>
<td>属性集合计数器</td>
</tr>
<tr>
<td>attribute_info</td>
<td>attributes</td>
<td>attributes_count</td>
<td>属性集合</td>
</tr>
</tbody></table>
<p>可以看到：Code属性表的前两项跟属性表是一致的，即Code属性表遵循属性表的结构，后面那些则是他自定义的结构。</p>
<h4 id="④-InnerClasses-属性"><a href="#④-InnerClasses-属性" class="headerlink" title="④ InnerClasses 属性"></a>④ InnerClasses 属性</h4><p>为了方便说明特别定义一个表示类或接口的Class格式为C。如果C的常量池中包含某个CONSTANT_Class_info成员，且这个成员所表示的类或接口不属于任何一个包，那么C的ClassFile结构的属性表中就必须含有对应的InnerClasses属性。InnerClasses属性是在JDK1.1中为了支持内部类和内部接口而引入的，位于ClassFile结构的属性表。</p>
<h4 id="⑤-LineNumberTable属性"><a href="#⑤-LineNumberTable属性" class="headerlink" title="⑤ LineNumberTable属性"></a>⑤ LineNumberTable属性</h4><p>LineNumberTable属性是可选变长属性，位于Code结构的属性表。</p>
<p>LineNumberTable属性是用来描述Java源码行号与字节码行号之间的对应关系。这个属性可以用来在调试的时候定位代码执行的行数。</p>
<ul>
<li>start_pc，即字节码行号；</li>
<li>line_number，即Java源代码行号。</li>
</ul>
<p>在Code属性的属性表中，LineNumberTable属性可以按照任意顺序出现，此外，多个LineNumberTable属性可以共同表示一个行号在源文件中表示的内容，即LineNumberTable属性不需要与源文件的行一一对应。</p>
<h4 id="⑥-LocalVariableTable属性"><a href="#⑥-LocalVariableTable属性" class="headerlink" title="⑥ LocalVariableTable属性"></a>⑥ LocalVariableTable属性</h4><p>LocalVariableTable是可选变长属性，位于Code属性的属性表中。它被调试器用于确定方法在执行过程中局部变量的信息。在Code属性的属性表中，LocalVariableTable属性可以按照任意顺序出现。Code属性中的每个局部变量最多只能有一个LocalVariableTable属性。</p>
<ul>
<li><p>start pc + length表示这个变量在字节码中的生命周期起始和结束的偏移位置（this生命周期从头e到结尾10）</p>
</li>
<li><p>index就是这个变量在局部变量表中的槽位（槽位可复用）</p>
</li>
<li><p>name就是变量名</p>
</li>
<li><p>Descriptor表示局部变量类型描述</p>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// LocalVariableTable属性表结构：</span>
LocalVariableTable_attribute<span class="token punctuation">{</span>
    u2 attribute_name_index<span class="token punctuation">;</span>
    u4 attribute_length<span class="token punctuation">;</span>
    u2 local_variable_table_length<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        u2 start_pc<span class="token punctuation">;</span>
        u2 length<span class="token punctuation">;</span>
        u2 name_index<span class="token punctuation">;</span>
        u2 descriptor_index<span class="token punctuation">;</span>
        u2 index<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> local_variable_table<span class="token punctuation">[</span>local_variable_table_length<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="⑦-Signature属性"><a href="#⑦-Signature属性" class="headerlink" title="⑦ Signature属性"></a>⑦ Signature属性</h4><p>Signature属性是可选的定长属性，位于ClassFile，field_info或method_info结构的属性表中。在Java语言中，任何类、接口、初始化方法或成员的泛型签名如果包含了类型变量（Type Variables）或参数化类型（Parameterized Types），则Signature属性会为它记录泛型签名信息。</p>
<p>⑧ SourceFile属性</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>名称</th>
<th>数量</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>u2</td>
<td>attribute_name_index</td>
<td>1</td>
<td>属性名索引</td>
</tr>
<tr>
<td>u4</td>
<td>attribute_length</td>
<td>1</td>
<td>属性长度</td>
</tr>
<tr>
<td>u2</td>
<td>sourcefile index</td>
<td>1</td>
<td>源码文件素引</td>
</tr>
</tbody></table>
<p>可以看到，其长度总是固定的8个字节。</p>
<h4 id="⑨-其他属性"><a href="#⑨-其他属性" class="headerlink" title="⑨ 其他属性"></a>⑨ 其他属性</h4><p>Java虚拟机中预定义的属性有20多个，这里就不一一介绍了，通过上面几个属性的介绍，只要领会其精髓，其他属性的解读也是易如反掌。</p>
<h2 id="❷类加载时机"><a href="#❷类加载时机" class="headerlink" title="❷类加载时机"></a>❷类加载时机</h2><p><strong>主动引用</strong>：对于初始化阶段，虚拟机严格规范了有且只有 6 种情况下，必须对类进行初始化</p>
<ol>
<li>当遇到 <code>new</code>、<code>getstatic</code>、<code>putstatic</code>、<code>invokestatic</code> 这 4 条直接码指令时<ul>
<li>当 jvm 执行 <code>new</code> 指令时会初始化类。即当程序创建一个类的实例对象。</li>
<li>当 jvm 执行 <code>getstatic</code> 指令时会初始化类。即程序访问类的静态变量(不是静态常量，常量会被加载到运行时常量池)。</li>
<li>当 jvm 执行 <code>putstatic</code> 指令时会初始化类。即程序给类的静态变量赋值。</li>
<li>当 jvm 执行 <code>invokestatic</code> 指令时会初始化类。即程序调用类的静态方法。</li>
</ul>
</li>
<li>使用 <code>java.lang.reflect</code> 包的方法对类进行反射调用时如 <code>Class.forname(&quot;...&quot;)</code>, <code>newInstance()</code> 等等。如果类没初始化，需要触发其初始化。</li>
<li>初始化一个类，如果其父类还未初始化，则先触发该父类的初始化。</li>
<li>当虚拟机启动时，用户需要定义一个要执行的主类 (包含 <code>main</code> 方法的那个类)，虚拟机会先初始化这个类。</li>
<li><code>MethodHandle</code> 和 <code>VarHandle</code> 可以看作是轻量级的反射调用机制，而要想使用这 2 个调用， 就必须先使用 <code>findStaticVarHandle</code> 来初始化要调用的类。</li>
<li>当一个接口中定义了 JDK8 新加入的默认方法（被 default 关键字修饰的接口方法）时，如果有这个接口的实现类发生了初始化，那该接口要在其之前被初始化。</li>
</ol>
<p><strong>被动引用</strong>：所有引用类的方式都不会触发初始化，称为被动引用</p>
<ul>
<li>通过子类引用父类的静态字段，不会导致子类初始化，只会触发父类的初始化</li>
<li>通过数组定义来引用类，不会触发此类的初始化。该过程会对数组类进行初始化，数组类是一个由虚拟机自动生成的、直接继承自 Object 的子类，其中包含了数组的属性和方法</li>
<li>常量（final 修饰）在编译阶段会存入调用类的常量池中，本质上没有直接引用到定义常量的类，因此不会触发定义常量的类的初始化</li>
<li>调用 ClassLoader 类的 loadClass() 方法加载一个类，并不是对类的主动使用，不会导致类的初始化</li>
</ul>
<h2 id="❸类加载过程"><a href="#❸类加载过程" class="headerlink" title="❸类加载过程"></a>❸类加载过程</h2><h3 id="0-生命周期"><a href="#0-生命周期" class="headerlink" title="0.生命周期"></a>0.生命周期</h3><blockquote>
<p>在Java中数据类型分为<strong>基本数据类型</strong>和<strong>引用数据类型</strong>。基本数据类型由虚拟机预先定义，引用数据类型则需要进行类的加载。</p>
</blockquote>
<p>按照Java虚拟机规范，从class文件到加载到内存中的类，到类卸载出内存为止，它的整个生命周期包括如下7个阶段：</p>
<ul>
<li>加载（Loading）</li>
<li>链接：验证（Verification）、准备（Preparation）、解析（Resolution）</li>
<li>初始化（Initialization）</li>
<li>使用（Using）</li>
<li>卸载（Unloading）</li>
</ul>
<img src="https://img.jwt1399.top/img/202212241155714.png" style="zoom: 50%;" />

<h3 id="1-加载"><a href="#1-加载" class="headerlink" title="1.加载"></a>1.加载</h3><p>加载过程完成以下三件事：</p>
<ol>
<li>通过全限定类名获取定义此类的二进制字节流</li>
<li>将字节流所代表的静态存储结构转换为方法区的运行时数据结构（Java类模型） </li>
<li>在内存中生成一个代表该类的 <code>Class</code> 对象，作为方法区这些数据的访问入口</li>
</ol>
<p>二进制字节流可以从以下方式中获取：</p>
<ul>
<li>通过文件系统读入一个class后缀的文件</li>
<li>从 ZIP 包读取，成为 JAR、EAR、WAR 格式的基础</li>
<li>从网络中获取，最典型的应用是 Applet</li>
<li>由其他文件生成，例如由 JSP 文件生成对应的 Class 类</li>
<li>运行时计算生成，例如动态代理技术，在 java.lang.reflect.Proxy 使用 ProxyGenerator.generateProxyClass 生成字节码</li>
</ul>
<p>方法区内部采用 C++ 的 instanceKlass 描述 Java 类的数据结构：</p>
<ul>
<li><code>_java_mirror</code> 即 Java 的类镜像，例如对 String 来说就是 String.class，作用是把 class 暴露给 Java 使用</li>
<li><code>_super</code> 即父类、<code>_fields</code> 即成员变量、<code>_methods</code> 即方法、<code>_constants</code> 即常量池、<code>_class_loader</code> 即类加载器、<code>_vtable</code> 虚方法表、<code>_itable</code> 接口方法表</li>
</ul>
<p>加载过程：</p>
<ul>
<li>如果这个类还有父类没有加载，先加载父类</li>
<li><code>Class 对象</code>和 <code>_java_mirror</code> 相互持有对方的地址，堆中对象通过 instanceKlass 和元空间进行交互</li>
<li>加载和链接可能是交替运行的</li>
</ul>
<table>
<thead>
<tr>
<th>类实例&amp;类模型位置</th>
<th>加载过程</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img.jwt1399.top/img/202212241215535.png"></td>
<td><img src="https://img.jwt1399.top/img/202212241215552.png" style="zoom:80%;" /></td>
</tr>
</tbody></table>
<p><strong>数组类型不通过类加载器创建，它由 Java 虚拟机直接创建。</strong></p>
<p>创建数组类有些特殊，因为数组类本身并不是由类加载器负责创建，而是由 JVM 在运行时根据需要而直接创建的，但数组的元素类型仍然需要依靠类加载器去创建，创建数组类的过程：</p>
<ul>
<li>如果数组的元素类型是引用类型，那么遵循定义的加载过程递归加载和创建数组的元素类型</li>
<li>JVM 使用指定的元素类型和数组维度来创建新的数组类</li>
<li><strong>基本数据类型由启动类加载器加载</strong></li>
</ul>
<h3 id="2-链接"><a href="#2-链接" class="headerlink" title="2.链接"></a>2.链接</h3><h4 id="2-1验证"><a href="#2-1验证" class="headerlink" title="2.1验证"></a>2.1验证</h4><blockquote>
<p>确保 Class 文件的字节流中包含的信息是否符合 JVM 规范，保证被加载类的正确性，不会危害虚拟机自身的安全</p>
</blockquote>
<p>主要包括<strong>四种验证</strong>：</p>
<ul>
<li><p>文件格式验证</p>
<ul>
<li>魔数检查</li>
<li>版本检查</li>
<li>长度检查</li>
</ul>
</li>
<li><p>元数据验证</p>
<ul>
<li><p>是否所有的类都有父类的存在（除了 Object 外，其他类都应该有父类）</p>
</li>
<li><p>是否一些被定义为 final 的方法或者类被重写或继承了</p>
</li>
<li><p>非抽象类是否实现了所有抽象方法或者接口方法</p>
</li>
<li><p>是否存在不兼容的方法</p>
</li>
</ul>
</li>
<li><p>字节码验证</p>
<ul>
<li>在字节码的执行过程中，是否会跳转到一条不存在的指令</li>
<li>函数的调用是否传递了正确类型的参数</li>
<li>变量的赋值是不是给了正确的数据类型</li>
<li>栈映射帧（StackMapTable）在这个阶段用于检测在特定的字节码处，其局部变量表和操作数栈是否有着正确的数据类型</li>
</ul>
</li>
<li><p>符号引用验证</p>
<ul>
<li>Class 文件在其常量池会通过字符串记录将要使用的其他类或者方法</li>
<li>因此虚拟机就会检查这些类和方法是否存在，并且当前类有权限访问这些数据</li>
<li>如果一个需要使用类无法在系统中找到，则会抛出NoClassDefFoundError，如果一个方法无法被找到，则会抛出NoSuchMethodError。此阶段在解析环节才会执行。</li>
</ul>
</li>
</ul>
<h4 id="2-2准备"><a href="#2-2准备" class="headerlink" title="2.2准备"></a>2.2准备</h4><blockquote>
<p>为类变量&#x2F;静态变量分配内存并设置默认初始值的阶段，使用的是方法区的内存。</p>
</blockquote>
<p>说明：实例变量不会在这阶段分配内存，它会在对象实例化时随着对象一起被分配在堆中，类加载发生在所有实例化操作之前，并且类加载只进行一次，实例化可以进行多次</p>
<p>类变量初始化：</p>
<ul>
<li>static 变量分配空间和赋值是两个步骤：<strong>分配空间在准备阶段完成，赋值在初始化阶段完成</strong></li>
<li>如果 static 变量是 final 的基本类型以及字符串常量，那么编译阶段值（方法区）就确定了，准备阶段会显式初始化</li>
<li>如果 static 变量是 final 的，但属于引用类型或者构造器方法的字符串，赋值在初始化阶段完成</li>
</ul>
<p>实例：</p>
<ul>
<li><p>初始值一般为 0 值，例如下面的类变量 value 被初始化为 0 而不是 123：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>常量 value 被初始化为 123 而不是 0：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>Java 并不支持 boolean 类型，对于 boolean 类型，内部实现是 int，由于 int 的默认值是 0，故 boolean 的默认值就是 false</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>默认初始值</th>
</tr>
</thead>
<tbody><tr>
<td>byte</td>
<td>(byte)0</td>
</tr>
<tr>
<td>short</td>
<td>(short)0</td>
</tr>
<tr>
<td>int</td>
<td>0</td>
</tr>
<tr>
<td>long</td>
<td>0L</td>
</tr>
<tr>
<td>float</td>
<td>0.0f</td>
</tr>
<tr>
<td>double</td>
<td>0.0</td>
</tr>
<tr>
<td>char</td>
<td>\u0000</td>
</tr>
<tr>
<td>boolean</td>
<td>false</td>
</tr>
<tr>
<td>reference</td>
<td>null</td>
</tr>
</tbody></table>
<h4 id="2-3解析"><a href="#2-3解析" class="headerlink" title="2.3解析"></a>2.3解析</h4><blockquote>
<p>将常量池中类、接口、字段、方法的<strong>符号引用替换为直接引用</strong>（内存地址）的过程。</p>
</blockquote>
<ul>
<li>符号引用：用于描述目标。可以是任何字面量，属于编译原理方面的概念，如：包括类和接口的全限名、字段的名称和描述符、方法的名称和<strong>方法描述符</strong>（因为类还没有加载完，很多方法是找不到的）</li>
<li>直接引用：直接指向目标的地址。如果有了直接引用，那说明引用的目标必定已经存在于内存之中</li>
</ul>
<p>解析动作主要针对类或接口、字段、类方法、接口方法、方法类型等</p>
<ul>
<li>在类加载阶段解析的是非虚方法，静态绑定</li>
<li>也可以在初始化阶段之后再开始解析，这是为了支持 Java 的<strong>动态绑定</strong></li>
<li>通过解析操作，符号引用就可以转变为目标方法在类的虚方法表中的位置，从而使得方法被成功调用</li>
</ul>
<h3 id="3-初始化"><a href="#3-初始化" class="headerlink" title="3.初始化"></a>3.初始化</h3><blockquote>
<p>初始化阶段是执行初始化方法 <code>&lt;clinit&gt;()</code>方法的过程，是类加载的最后一步，这一步 JVM 才开始真正执行类中定义的 Java 程序代码(字节码)。</p>
</blockquote>
<p>在编译生成 class 文件时，编译器会产生两个方法加于 class 文件中，一个是类的初始化方法 <code>&lt;clinit&gt;()</code> ，另一个是实例的初始化方法 <code>&lt;init&gt;()</code> </p>
<p>类构造器 <code>&lt;clinit&gt;()</code> 与实例构造器 <code>&lt;init&gt;()</code> 不同，它不需要程序员进行显式调用，在一个类的生命周期中，类构造器最多被虚拟机<strong>调用一次</strong>，后续实例化不再加载，引用第一次加载的类，而实例构造器则会被虚拟机调用多次，只要程序员创建对象</p>
<h4 id="3-1-clinit"><a href="#3-1-clinit" class="headerlink" title="3.1 clinit"></a>3.1 clinit</h4><p><code>&lt;clinit&gt;()</code>：类构造器，由编译器自动收集类中<strong>所有类变量的赋值动作和静态语句块</strong>中的语句合并产生的</p>
<p>作用：是在类加载过程中的初始化阶段进行静态变量初始化和执行静态代码块</p>
<ul>
<li>如果类中没有静态变量或静态代码块，那么 <code>&lt;clinit&gt;()</code>  方法将不会被生成</li>
<li><code>&lt;clinit&gt;()</code>  方法只执行一次，在执行 <code>&lt;clinit&gt;()</code>  方法时，必须先执行父类的<code>&lt;clinit&gt;()</code> 方法</li>
<li>static 变量的赋值操作和静态代码块的合并顺序由源文件中出现的顺序决定</li>
<li>static 不加 final 的变量都在初始化环节赋值</li>
</ul>
<p><strong>线程安全</strong>问题：</p>
<ul>
<li>虚拟机会保证一个类的 <code>&lt;clinit&gt;()</code> 方法在多线程环境下被正确的加锁和同步，如果多个线程同时初始化一个类，只会有一个线程执行这个类的 <code>&lt;clinit&gt;()</code> 方法，其它线程都阻塞等待，直到活动线程执行 <code>&lt;clinit&gt;()</code> 方法完毕</li>
<li>如果在一个类的 <code>&lt;clinit&gt;()</code> 方法中有耗时的操作，就可能造成多个线程阻塞，在实际过程中此种阻塞很隐蔽</li>
</ul>
<p>特别注意：静态语句块只能访问到定义在它之前的类变量，定义在它之后的类变量只能赋值，不能访问</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//i = 0;                // 给变量赋值可以正常编译通过</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  	<span class="token comment" spellcheck="true">// 这句编译器会提示“非法向前引用”</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接口中不可以使用静态语句块，但有类变量初始化的赋值操作，因此接口与类一样都会生成 <code>&lt;clinit&gt;()</code> 方法</p>
<ul>
<li>在初始化一个接口时，并不会先初始化它的父接口，所以执行接口的 <code>&lt;clinit&gt;()</code> 方法不需要先执行父接口的 <code>&lt;clinit&gt;()</code> 方法</li>
<li>在初始化一个实现类时，不会先初始化所实现的接口，所以接口的实现类在初始化时不会执行接口的 <code>&lt;clinit&gt;()</code> 方法</li>
<li>只有当父接口中定义的变量使用时，父接口才会初始化</li>
</ul>
<h4 id="3-3-init"><a href="#3-3-init" class="headerlink" title="3.3 init"></a>3.3 init</h4><p><code>&lt;init&gt;()</code> 指实例构造器，主要作用是在类实例化过程中执行，执行内容包括成员变量初始化和代码块的执行</p>
<p>实例化即调用 <code>&lt;init&gt;()V</code> ，虚拟机会保证这个类的构造方法的线程安全，先为实例变量分配内存空间，再执行赋默认值，然后根据源码中的顺序执行赋初值或代码块，没有成员变量初始化和代码块则不会执行</p>
<p>new 关键字会创建对象并复制 dup 一个对象引用，一个调用 <code>&lt;init&gt;</code> 方法，另一个用来赋值给接收者</p>
<h3 id="4-卸载"><a href="#4-卸载" class="headerlink" title="4.卸载"></a>4.卸载</h3><blockquote>
<p>卸载类即该类的 Class 对象被 GC。</p>
</blockquote>
<p>卸载类需要满足3个要求:</p>
<ol>
<li>该类的所有的实例对象都已被 GC，也就是说堆不存在该类的实例对象</li>
<li>该类没有在其他任何地方被引用</li>
<li>该类的类加载器的实例已被 GC</li>
</ol>
<ul>
<li><p>JVM 自带的类加载器加载的类是不会被卸载的</p>
<ul>
<li>因为 JVM 会始终引用启动、扩展、系统类加载器，这些类加载器始终引用它们所加载的类，这些类始终是可及的</li>
</ul>
</li>
<li><p>自定义的类加载器加载的类是可能被卸载。</p>
</li>
</ul>
<h2 id="❹类实例化过程"><a href="#❹类实例化过程" class="headerlink" title="❹类实例化过程"></a>❹类实例化过程</h2><p><strong>父类的类构造器<code>&lt;clinit&gt;</code> ➔ 子类的类构造器<code>&lt;clinit&gt;</code>➔ 父类的实例构造器<code>&lt;init&gt;</code> ➔ 父类的构造函数 ➔ 子类的的实例构造器<code>&lt;init&gt;</code> ➔ 子类的构造函数</strong></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//父类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Father</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"父静态代码块"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"父非静态代码块"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Father</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"父构造器"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//子类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Son</span> <span class="token keyword">extends</span> <span class="token class-name">Father</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"子静态代码块"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"子非静态代码块"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"子构造器"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment" spellcheck="true">//创建对象</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Son</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">/**
  运行结果：
  父静态代码块
  子静态代码块
  父非静态代码块
  父构造器
  子非静态代码块
  子构造器
**/</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="❺类加载器"><a href="#❺类加载器" class="headerlink" title="❺类加载器"></a>❺类加载器</h2><h3 id="0-基础知识"><a href="#0-基础知识" class="headerlink" title="0.基础知识"></a>0.基础知识</h3><h4 id="类加载分类"><a href="#类加载分类" class="headerlink" title="类加载分类"></a>类加载分类</h4><ul>
<li><p>显式加载：在代码中通过调用ClassLoader加载class对象，如直接使用Class.forName(name)或ClassLoader.loadClass(name)加载class对象。</p>
<ul>
<li><p>ClassLoader.loadClass(className)：只加载和链接，<strong>不会进行初始化</strong></p>
</li>
<li><p>Class.forName(String name, boolean initialize, ClassLoader loader)：使用 loader 进行加载和链接，根据参数 initialize 决定是否初始化</p>
</li>
</ul>
</li>
</ul>
<ul>
<li>隐式加载：不直接在代码中调用 ClassLoader 的方法加载类对象，如在加载某个类的class文件时，该类的class文件中引用了另外一个类的对象，此时额外引用的类将通过JVM自动加载到内存中。<ul>
<li>创建类对象、使用类的静态域、创建子类对象、使用子类的静态域</li>
<li>在 JVM 启动时，通过三大类加载器加载 class</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//隐式加载</span>
User user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//显式加载，并初始化</span>
Class <span class="token class-name">clazz</span> <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.test.java.User"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//显式加载，但不初始化</span>
ClassLoader<span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"com.test.java.Parent"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>类加载器基本特征：</p>
<ul>
<li><strong>可见性</strong>，子类加载器可以访问父加载器加载的类型，但是反过来是不允许的</li>
<li><strong>单一性</strong>，由于父加载器的类型对于子加载器是可见的，所以父加载器中加载过的类型，不会在子加载器中重复加载</li>
</ul>
<h4 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h4><blockquote>
<p>ClassLoader 类，是一个抽象类，除启动类加载器外其它类加载器都继承自 ClassLoader</p>
</blockquote>
<p>获取 ClassLoader 的途径：</p>
<ul>
<li>获取当前类的 ClassLoader：<code>clazz.getClassLoader()</code></li>
<li>获取当前线程上下文的 ClassLoader：<code>Thread.currentThread.getContextClassLoader()</code></li>
<li>获取系统的 ClassLoader：<code>ClassLoader.getSystemClassLoader()</code></li>
<li>获取调用者的 ClassLoader：<code>DriverManager.getCallerClassLoader()</code></li>
</ul>
<p>ClassLoader 类常用方法：</p>
<ul>
<li><code>getParent()</code>：返回该类加载器的超类加载器  </li>
<li><code>loadclass(String name)</code>：加载名为name的类，返回结果为Class类的实例，<strong>该方法就是双亲委派模式</strong></li>
<li><code>findclass(String name)</code>：查找二进制名称为 name 的类，返回结果为 Class 类的实例，该方法会在检查完父类加载器之后被 loadClass() 方法调用</li>
<li><code>findLoadedClass(String name)</code>：查找名称为 name 的已经被加载过的类，final 修饰无法重写</li>
<li><code>defineClass(String name, byte[] b, int off, int len)</code>：将<strong>字节流</strong>解析成 JVM 能够识别的类对象</li>
<li><code>resolveclass(Class&lt;?&gt; c)</code>：链接指定的 Java 类，可以使类的 Class 对象创建完成的同时也被解析</li>
<li><code>InputStream getResourceAsStream(String name)</code>：指定资源名称获取输入流</li>
</ul>
<h4 id="类加载模型"><a href="#类加载模型" class="headerlink" title="类加载模型"></a>类加载模型</h4><p>在 JVM 中，对于类加载模型提供了三种，分别为全盘加载、双亲委派、缓存机制</p>
<ul>
<li><p><strong>全盘加载：</strong>当一个类加载器负责加载某个 Class 时，该 Class 所依赖和引用的其他 Class 也将由该类加载器负责载入，除非显示指定使用另外一个类加载器来载入</p>
</li>
<li><p><strong>双亲委派：</strong>某个特定的类加载器在接到加载类的请求时，首先将加载任务委托给父加载器，<strong>依次递归</strong>，如果父加载器可以完成类加载任务，就成功返回；只有当父加载器无法完成此加载任务时，才自己去加载</p>
</li>
<li><p><strong>缓存机制：</strong>会保证所有加载过的 Class 都会被缓存，当程序中需要使用某个 Class 时，类加载器先从缓存区中搜寻该 Class，只有当缓存区中不存在该 Class 对象时，系统才会读取该类对应的二进制数据，并将其转换成 Class 对象存入缓冲区（方法区）中。<strong>这就是修改了 Class 后，必须重新启动 JVM，程序所做的修改才会生效的原因</strong></p>
</li>
</ul>
<h3 id="1-加载器"><a href="#1-加载器" class="headerlink" title="1.加载器"></a>1.加载器</h3><blockquote>
<p>类加载器是 Java 的核心组件，用于加载字节码到 JVM 内存，得到 Class 类的对象</p>
</blockquote>
<p>从 Java 虚拟机规范来讲，只存在以下两种不同的类加载器：</p>
<ul>
<li>启动类加载器（Bootstrap ClassLoader）：使用 C++ 实现，是虚拟机自身的一部分</li>
<li>自定义类加载器（User-Defined ClassLoader）：Java 虚拟机规范<strong>将所有派生于抽象类 ClassLoader 的类加载器都划分为自定义类加载器</strong>，使用 Java 语言实现，独立于虚拟机</li>
</ul>
<p>从 Java 开发人员的角度看：</p>
<img src="https://img.jwt1399.top/img/202301201331894.png" style="zoom: 33%;" />

<ul>
<li>启动类加载器（Bootstrap ClassLoader）：<ul>
<li>出于安全考虑，Bootstrap 启动类加载器只加载包名为 java、javax、sun 等开头的类</li>
<li>启动类加载器负责加载在 <code>JAVA_HOME/jre/lib</code> 或 <code>sun.boot.class.path</code> 目录中的，或者被 <code>-Xbootclasspath</code> 参数所指定的路径中的类，并且是虚拟机识别的类库加载到虚拟机内存中</li>
<li>仅按照文件名识别，如 rt.jar 名字不符合的类库即使放在 lib 目录中也不会被加载</li>
<li>启动类加载器无法被 Java 程序直接引用，编写自定义类加载器时，如果要把加载请求委派给启动类加载器，直接使用 null 代替</li>
</ul>
</li>
<li>扩展类加载器（Extension ClassLoader）：<ul>
<li>由 <code>ExtClassLoader (sun.misc.Launcher$ExtClassLoader)</code>  实现，上级为 Bootstrap，显示为 null</li>
<li>将 <code>JAVA_HOME/jre/lib/ext</code> 或者被 <code>java.ext.dir</code> 系统变量所指定路径中的所有类库加载到内存中</li>
<li>开发者可以使用扩展类加载器，创建的 JAR 放在此目录下，会由扩展类加载器自动加载</li>
</ul>
</li>
<li>应用程序类加载器（Application ClassLoader）：<ul>
<li>由 <code>AppClassLoader(sun.misc.Launcher$AppClassLoader)</code> 实现，上级为 Extension</li>
<li>负责加载环境变量 classpath 或系统属性 <code>java.class.path</code> 指定路径下的类库</li>
<li>这个类加载器是 ClassLoader 中的 <code>getSystemClassLoader()</code> 方法的返回值，因此称为系统类加载器</li>
<li>可以直接使用这个类加载器，如果应用程序中没有自定义类加载器，这个就是程序中默认的类加载器</li>
</ul>
</li>
<li>自定义类加载器：由开发人员自定义的类加载器，上级是 Application</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClassLoaderTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//获取系统类加载器</span>
        ClassLoader systemClassLoader <span class="token operator">=</span> ClassLoader<span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>systemClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//sun.misc.Launcher$AppClassLoader@18b4aac2</span>

        <span class="token comment" spellcheck="true">//获取其上层  扩展类加载器</span>
        ClassLoader extClassLoader <span class="token operator">=</span> systemClassLoader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>extClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//sun.misc.Launcher$ExtClassLoader@610455d6</span>

        <span class="token comment" spellcheck="true">//获取其上层 获取不到启动类加载器</span>
        ClassLoader bootStrapClassLoader <span class="token operator">=</span> extClassLoader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bootStrapClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//null</span>

        <span class="token comment" spellcheck="true">//对于用户自定义类来说：使用系统类加载器进行加载</span>
        ClassLoader classLoader <span class="token operator">=</span> ClassLoaderTest<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//sun.misc.Launcher$AppClassLoader@18b4aac2</span>

        <span class="token comment" spellcheck="true">//String 类使用引导类加载器进行加载的 --> java核心类库都是使用启动类加载器加载的</span>
        ClassLoader classLoader1 <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>classLoader1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//null</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-双亲委派"><a href="#2-双亲委派" class="headerlink" title="2.双亲委派"></a>2.双亲委派</h3><ul>
<li><strong>向上委托</strong>：如果一个类加载器收到了类加载请求，它并不会自己先去加载，而是把这个请求委托给父类的加载器去执行，如果父类加载器还存在其父类加载器，则进一步向上委托，依次递归，请求最终将到达顶层的启动类加载器。如果父类加载器可以完成类加载任务，就成功返回；</li>
<li><strong>向下委派</strong>：倘若父类加载器无法完成此加载任务，子加载器才会尝试自己去加载，这就是双亲委派模式。</li>
</ul>
<img src="https://img.jwt1399.top/img/202212241706954.png" style="zoom:50%;" />

<p>双亲委派机制的优点：</p>
<ul>
<li><p>可以避免类被重复加载，当父类已经加载后则无需重复加载，保证类的全局唯一性</p>
</li>
<li><p>保护程序安全，防止类库的核心 API 被随意篡改</p>
<p>例如：在工程中新建 java.lang 包，接着在该包下新建 String 类，并定义 main 函数</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"demo info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时执行 main 函数会出现异常，在类 java.lang.String 中找不到 main 方法。因为双亲委派的机制，java.lang.String 在启动类加载器（Bootstrap）得到加载，启动类加载器优先级更高，在核心 jre 库中有其相同名字的类文件，但该类中并没有 main 方法</p>
</li>
</ul>
<p>双亲委派机制的缺点：</p>
<p>检查类是否加载的委托过程是单向的，这个方式虽然从结构上看比较清晰，使各个 ClassLoader 的职责非常明确，但<strong>顶层的 ClassLoader 无法访问底层的 ClassLoader 所加载的类</strong>（可见性）</p>
<p>通常情况下，启动类加载器中的类为<u>系统核心类</u>，包括一些重要的系统接口，而在应用类加载器中，为<u>应用类</u>。按照这种模式，应用类访问系统类自然是没有问题，但是系统类访问应用类就会出现问题。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://m.imooc.com/wiki/jvm-loadparent">https://m.imooc.com/wiki/jvm-loadparent</a></p>
<h3 id="3-源码分析"><a href="#3-源码分析" class="headerlink" title="3.源码分析"></a>3.源码分析</h3><p>双亲委派机制在<code>java.lang.ClassLoader.loadClass(String，boolean)</code>方法中体现。逻辑如下：</p>
<ol>
<li><p>先在当前加载器的缓存中查找有无目标类 <code>findLoadedClass(name)</code>，如果有，直接返回。</p>
</li>
<li><p>判断当前加载器的父加载器是否为空，如果不为空，则调用<code>parent.loadClass(name，false)</code>接口进行加载。</p>
</li>
<li><p>如果当前加载器的父加载器为空，则调用<code>findBootstrapClassorNull(name)</code>接口，让启动类加载器进行加载。</p>
</li>
<li><p>如果通过以上3条路径都没能成功加载，则调用<code>findClass(name)</code>接口进行加载。该接口最终会调用<code>java.lang.ClassLoader</code>接口的<code>defineClass</code>系列的<code>native</code>接口加载目标Java类。</p>
</li>
</ol>
<p>双亲委派的模型就隐藏在这第2和第3步中。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">protected</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">loadClass</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span>
    <span class="token keyword">throws</span> ClassNotFoundException <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true">// 1.调用当前类加载器的 findLoadedClass(name)，检查当前类加载器是否已加载过指定 name 的类</span>
        Class <span class="token class-name">c</span> <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment" spellcheck="true">// 当前类加载器如果没有加载过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> t0 <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 2.判断当前类加载器是否有父类加载器</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 如果当前类加载器有父类加载器，则调用父类加载器的 loadClass(name,false)</span>
         			     <span class="token comment" spellcheck="true">// 父类加载器的 loadClass 方法，又会检查自己是否已经加载过</span>
                    c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 3.当前类加载器没有父类加载器，说明当前类加载器是 BootStrapClassLoader</span>
          			   <span class="token comment" spellcheck="true">// 则调用 BootStrap ClassLoader 的方法加载类</span>
                    c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> t1 <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 4.如果调用父类的类加载器无法对类进行加载，则用自己的 findClass() 方法进行加载</span>
                <span class="token comment" spellcheck="true">// 可以自定义 findClass() 方法</span>
                c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// this is the defining class loader; record the stats</span>
                sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getParentDelegationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTime</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getFindClassTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addElapsedTimeFrom</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span>PerfCounter<span class="token punctuation">.</span><span class="token function">getFindClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 链接指定的 Java 类，可以使类的 Class 对象创建完成的同时也被解析</span>
            <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-破坏委派"><a href="#4-破坏委派" class="headerlink" title="4.破坏委派"></a>4.破坏委派</h3><blockquote>
<p>双亲委派模型并不是一个具有强制性约束的模型，而是 Java 设计者推荐给开发者的类加载器实现方式</p>
</blockquote>
<p>破坏双亲委派模型的方式：</p>
<ul>
<li><p>1.自定义 ClassLoader</p>
<ul>
<li>如果不想破坏双亲委派模型，只需要重写 findClass 方法</li>
<li>如果想要去破坏双亲委派模型，需要去**重写 loadClass **方法</li>
</ul>
</li>
<li><p>2.引入线程上下文类加载器</p>
<p>Java 提供了很多服务提供者接口（Service Provider Interface，SPI），允许第三方为这些接口提供实现。常见的有 JDBC、JCE、JNDI 等。这些 SPI 接口由 Java 核心库来提供，而 SPI 的实现代码则是作为 Java 应用所依赖的 jar 包被包含进类路径 classpath 里，SPI 接口中的代码需要加载具体的实现类：</p>
<ul>
<li>SPI 的接口是 Java 核心库的一部分，是由启动类加载器来加载的</li>
<li>SPI 的实现类是由系统类加载器加载，启动类加载器是无法找到 SPI 的实现类，因为双亲委派模型中 BootstrapClassloader 无法委派 AppClassLoader 来加载类</li>
</ul>
<p>JDK 开发人员引入了线程上下文类加载器（Thread Context ClassLoader），这种类加载器可以通过 Thread  类的 setContextClassLoader 方法设置线程上下文类加载器，在执行线程中抛弃双亲委派加载模式，使程序可以逆向使用类加载器，使 Bootstrap 加载器拿到了 Application 加载器加载的类，破坏了双亲委派模型</p>
</li>
<li><p>3.实现程序的动态性，如代码热替换（Hot Swap）、模块热部署（Hot Deployment）</p>
<p>IBM 公司主导的 JSR一291（OSGiR4.2）实现模块化热部署的关键是它自定义的类加载器机制的实现，每一个程序模块（OSGi 中称为 Bundle）都有一个自己的类加载器，当更换一个 Bundle 时，就把 Bundle 连同类加载器一起换掉以实现代码的热替换，在 OSGi 环境下，类加载器不再双亲委派模型推荐的树状结构，而是进一步发展为更加复杂的网状结构</p>
<p>当收到类加载请求时，OSGi 将按照下面的顺序进行类搜索:</p>
<ol>
<li>将以 java.* 开头的类，委派给父类加载器加载</li>
<li>否则，将委派列表名单内的类，委派给父类加载器加载</li>
<li>否则，将 Import 列表中的类，委派给 Export 这个类的 Bundle 的类加载器加载</li>
<li>否则，查找当前 Bundle 的 ClassPath，使用自己的类加载器加载</li>
<li>否则，查找类是否在自己的 Fragment Bundle 中，如果在就委派给 Fragment Bundle 类加载器加载</li>
<li>否则，查找 Dynamic Import 列表的 Bundle，委派给对应 Bundle 的类加载器加载</li>
<li>否则，类查找失败</li>
</ol>
<p>热替换是指在程序的运行过程中，不停止服务，只通过替换程序文件来修改程序的行为，<strong>热替换的关键需求在于服务不能中断</strong>，修改必须立即表现正在运行的系统之中</p>
</li>
</ul>
<img src="https://img.jwt1399.top/img/202212251522492.png" style="zoom: 33%;" />

<h3 id="5-自定义加载器"><a href="#5-自定义加载器" class="headerlink" title="5.自定义加载器"></a>5.自定义加载器</h3><p>对于自定义类加载器的实现，只需要继承 ClassLoader 类，覆写 findClass 方法即可</p>
<p>作用：隔离加载类、修改类加载的方式、拓展加载源、防止源码泄漏</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">//自定义类加载器，读取指定的类路径classPath下的class文件</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> String classPath<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">MyClassLoader</span><span class="token punctuation">(</span>String classPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>classPath <span class="token operator">=</span> classPath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
     <span class="token keyword">public</span> <span class="token function">MyClassLoader</span><span class="token punctuation">(</span>ClassLoader parent<span class="token punctuation">,</span> String classPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>classPath <span class="token operator">=</span> classPath<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">findClass</span><span class="token punctuation">(</span>String className<span class="token punctuation">)</span> <span class="token keyword">throws</span> ClassNotFoundException <span class="token punctuation">{</span>
       BufferedInputStream bis <span class="token operator">=</span> null<span class="token punctuation">;</span>
        ByteArrayOutputStream baos <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取字节码文件的完整路径</span>
            String fileName <span class="token operator">=</span> classPath <span class="token operator">+</span> className <span class="token operator">+</span> <span class="token string">".class"</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 获取一个输入流</span>
            bis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 获取一个输出流</span>
            baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 具体读入数据并写出的过程</span>
            <span class="token keyword">int</span> len<span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> bis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                baos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 获取内存中的完整的字节数组的数据</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> byteCodes <span class="token operator">=</span> baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 调用 defineClass()，将字节数组的数据转换为 Class 的实例。</span>
            Class <span class="token class-name">clazz</span> <span class="token operator">=</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> byteCodes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> byteCodes<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>baos <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                    baos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bis <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                    bis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    MyClassLoader loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyClassLoader</span><span class="token punctuation">(</span><span class="token string">"/Workspace/Project/JVM_study/src/java1/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        Class <span class="token class-name">clazz</span> <span class="token operator">=</span> loader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"Demo1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"加载此类的类的加载器为："</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//MyClassLoader</span>

        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"加载当前类的类的加载器的父类加载器为："</span> <span class="token operator">+</span> clazz<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//sun.misc.Launcher$AppClassLoader</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-JDK9新特性"><a href="#6-JDK9新特性" class="headerlink" title="6.JDK9新特性"></a>6.JDK9新特性</h3><p>为了保证兼容性，JDK9 没有改变三层类加载器架构和双亲委派模型，但为了模块化系统的顺利运行做了一些变动：</p>
<ul>
<li><p>扩展机制被移除，扩展类加载器由于<strong>向后兼容性</strong>的原因被保留，不过被重命名为平台类加载器（platform classloader），可以通过 ClassLoader 的新方法 getPlatformClassLoader() 来获取</p>
</li>
<li><p>JDK9 基于模块化进行构建（原来的 rt.jar 和 tools.jar 被拆分成数个 JMOD 文件），其中 Java 类库就满足了可扩展的需求，那就无须再保留 <code>&lt;JAVA_HOME&gt;\lib\ext</code> 目录，此前使用这个目录或者 <code>java.ext.dirs</code> 系统变量来扩展 JDK 功能的机制就不需要再存在</p>
</li>
<li><p>启动类加载器、平台类加载器、应用程序类加载器全都继承于 <code>jdk.internal.loader.BuiltinClassLoader</code></p>
</li>
</ul>
<h1 id="⑤程序编译"><a href="#⑤程序编译" class="headerlink" title="⑤程序编译"></a>⑤程序编译</h1><blockquote>
<p>Java 代码执行流程：<code>Java 程序(.java) --（编译）--&gt; 字节码文件(.class)--（解释执行/JIT）--&gt; 操作系统（Win，Linux）</code></p>
</blockquote>
<h2 id="❶字节码指令集"><a href="#❶字节码指令集" class="headerlink" title="❶字节码指令集"></a>❶字节码指令集</h2><p>Java 字节码由操作码和操作数组成。</p>
<ul>
<li>操作码（Opcode）：一个字节长度（0-255，意味着指令集的操作码总数不可能超过 256 条），代表着某种特定的操作含义。</li>
<li>操作数（Operands）：零个或者多个，紧跟在操作码之后，代表此操作需要的参数。</li>
</ul>
<p>由于 Java 虚拟机是基于栈而不是寄存器的结构，所以大多数指令都只有一个操作码。比如 <code>aload_0</code>（将局部变量表中下标为 0 的数据压入操作数栈中）就只有操作码没有操作数，而 <code>invokespecial #1</code>（调用成员方法或者构造方法，并传递常量池中下标为 1 的常量）就是由操作码和操作数组成的。</p>
<h3 id="0-字节码与数据类型"><a href="#0-字节码与数据类型" class="headerlink" title="0.字节码与数据类型"></a>0.字节码与数据类型</h3><p>在 JVM 的指令集中，大多数的指令都包含了其操作所对应的数据类型信息。例如 iload 指令用于从局部变量表中加载 int 型的数据到操作数栈中，而 fload 指令加载的则是 float 类型的数据</p>
<ul>
<li>i 代表对 int 类型的数据操作</li>
<li>l 代表 long </li>
<li>s 代表 short</li>
<li>b 代表 byte</li>
<li>c 代表 char</li>
<li>f 代表 float</li>
<li>d 代表 double</li>
<li>a代表引用类型</li>
</ul>
<p>大部分的指令都没有支持 byte、char、short、boolean 类型，编译器会在编译期或运行期将 byte 和 short 类型的数据带符号扩展（Sign-Extend-）为相应的 int 类型数据，将 boolean 和 char 类型数据零位扩展（Zero-Extend）为相应的 int 类型数据</p>
<p>在做值相关操作时:</p>
<ul>
<li>一个指令，可以从局部变量表、常量池、堆中对象、方法调用、系统调用中等取得数据，这些数据（可能是值，也可能是对象的引用）被压入操作数栈</li>
<li>一个指令，也可以从操作数栈中取出一到多个值（pop 多次），完成赋值、加减乘除、方法传参、系统调用等等操作</li>
</ul>
<h3 id="1-加载与存储指令"><a href="#1-加载与存储指令" class="headerlink" title="1.加载与存储指令"></a>1.加载与存储指令</h3><blockquote>
<p>加载和存储指令用于将数据从栈帧的局部变量表和操作数栈之间来回传递</p>
</blockquote>
<p><strong>局部变量压栈指令</strong>：将给定的局部变量表中的数据压入操作数栈</p>
<ul>
<li><code>xload</code>、<code>xload_n</code>，x 表示数据类型，为 i、l、f、d、a； n 为 0 到 3</li>
<li>指令 <code>xload_n</code> 表示将第 n 个局部变量压入操作数栈，aload_n 表示将一个对象引用压栈</li>
<li>指令 <code>xload n</code> 通过指定参数的形式，把局部变量压入操作数栈，局部变量数量超过 4 个时使用这个命令</li>
</ul>
<p><strong>常量入栈指令</strong>：将常数压入操作数栈，根据数据类型和入栈内容的不同，又分为 <code>const_&lt;n&gt;</code>、<code>push</code>、<code>ldc</code> 指令</p>
<ul>
<li><code>push</code>：包括 bipush 和 sipush，区别在于接收数据类型的不同，bipush 接收 8 位整数作为参数，sipush 接收 16 位整数</li>
<li><code>ldc</code>：如果以上指令不能满足需求，可以使用 ldc 指令，接收一个 8 位的参数，该参数指向常量池中的 int、 float 或者 String 的索引，将指定的内容压入堆栈。<code>ldc_w</code> 接收两个 8 位参数，能支持的索引范围更大，如果要压入的元素是 long 或 double 类型的，则使用 <code>ldc2_w</code> 指令</li>
<li><code>aconst_null</code> 将 null 对象引用压入栈，<code>iconst_m1</code> 将 int 类型常量 -1 压入栈，<code>iconst_0</code> 将 int 类型常量 0 压入栈</li>
</ul>
<p><strong>出栈装入局部变量表指令</strong>：将操作数栈中栈顶元素弹出后，装入局部变量表的指定位置，用于给局部变量赋值</p>
<ul>
<li><code>xstore</code>、<code>xstore_n</code>，x 表示取值类型为 i、l、f、d、a， n 为 0 到 3</li>
<li><code>xastore</code> 表示存入数组，x 取值为 i、l、f、d、a、b、c、s</li>
</ul>
<p><strong>扩充局部变量表的访问索引的指令</strong>：<code>wide</code></p>
<h3 id="2-算术指令"><a href="#2-算术指令" class="headerlink" title="2.算术指令"></a>2.算术指令</h3><blockquote>
<p>算术指令用于对两个操作数栈上的值进行某种特定运算，并把计算结果重新压入操作数栈</p>
</blockquote>
<p>没有直接支持 byte、 short、 char 和 boolean 类型的算术指令，对于这些数据的运算，都使用 int 类型的指令来处理，数组类型也是转换成 int 数组</p>
<ul>
<li><p>加法指令：iadd、ladd、fadd、dadd</p>
</li>
<li><p>减法指令：isub、lsub、fsub、dsub</p>
</li>
<li><p>乘法指令：imu、lmu、fmul、dmul</p>
</li>
<li><p>除法指令：idiv、ldiv、fdiv、ddiv</p>
</li>
<li><p>求余指令：irem、lrem、frem、drem（remainder 余数）</p>
</li>
<li><p>取反指令：ineg、lneg、fneg、dneg （negation 取反）</p>
</li>
<li><p>自增指令：iinc 1 1（直接<strong>在局部变量 slot 上进行运算</strong>，不用放入操作数栈）</p>
</li>
<li><p>自减指令：iinc 1 -1 </p>
</li>
<li><p>位运算指令，又可分为：</p>
<ul>
<li>位移指令：ishl、ishr、 iushr、lshl、lshr、 lushr</li>
<li>按位或指令：ior、lor</li>
<li>按位与指令：iand、land</li>
<li>按位异或指令：ixor、lxor</li>
</ul>
</li>
<li><p>比较指令：dcmpg、dcmpl、 fcmpg、fcmpl、lcmp</p>
</li>
</ul>
<p>运算模式：</p>
<ul>
<li><strong>向最接近数舍入模式</strong>：JVM 在进行浮点数计算时，所有的运算结果都必须舍入到适当的精度，非精确结果必须舍入为可被表示的最接近的精确值，如果有两种可表示形式与该值一样接近，将优先选择最低有效位为零的</li>
<li><strong>向零舍入模式</strong>：将浮点数转换为整数时，该模式将在目标数值类型中选择一个最接近但是不大于原值的数字作为最精确的舍入结果</li>
</ul>
<p>NaN 值：当一个操作产生溢出时，将会使用有符号的无穷大表示，如果某个操作结果没有明确的数学定义，将使用 NaN 值来表示</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">double</span> j <span class="token operator">=</span> i <span class="token operator">/</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//无穷大，NaN: not a number</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>**分析 i++**：从字节码角度分析：a++ 和 ++a 的区别是先执行 iload 还是先执行 iinc</p>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token number">4</span> iload_1		<span class="token comment" spellcheck="true">//存入操作数栈</span>
 <span class="token number">5</span> iinc <span class="token number">1</span> by <span class="token number">1</span>	<span class="token comment" spellcheck="true">//自增i++</span>
 <span class="token number">8</span> istore_3		<span class="token comment" spellcheck="true">//把操作数栈没有自增的数据的存入局部变量表</span>
   
 <span class="token number">9</span> iinc <span class="token number">2</span> by <span class="token number">1</span>	<span class="token comment" spellcheck="true">//++i</span>
<span class="token number">12</span> iload_2		<span class="token comment" spellcheck="true">//加载到操作数栈</span>
<span class="token number">13</span> istore <span class="token number">4</span>		<span class="token comment" spellcheck="true">//存入局部变量表，这个存入没有 _ 符号，_只能到3</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> b <span class="token operator">=</span> a<span class="token operator">++</span> <span class="token operator">+</span> <span class="token operator">++</span>a <span class="token operator">+</span> a<span class="token operator">--</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">//11</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">//34</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>判断结果：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            x <span class="token operator">=</span> x<span class="token operator">++</span><span class="token punctuation">;</span>
            i<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 结果是 0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="3-类型转换指令"><a href="#3-类型转换指令" class="headerlink" title="3.类型转换指令"></a>3.类型转换指令</h3><blockquote>
<p>类型转换指令可以将两种不同的数值类型进行相互转换，除了 boolean 之外的七种类型</p>
</blockquote>
<p>宽化类型转换：</p>
<ul>
<li><p>JVM 支持以下数值的宽化类型转换（widening numeric conversion），小范围类型到大范围类型的安全转换</p>
<ul>
<li>从 int 类型到 long、float 或者 double 类型，对应的指令为 i2l、i2f、i2d</li>
<li>从 long 类型到 float、 double 类型，对应的指令为 l2f、l2d</li>
<li>从 float 类型到 double 类型，对应的指令为 f2d</li>
</ul>
</li>
<li><p>精度损失问题</p>
<ul>
<li>宽化类型转换是不会因为超过目标类型最大值而丢失信息</li>
<li>从 int 转换到 float 或者 long 类型转换到 double 时，将可能发生精度丢失</li>
</ul>
</li>
<li><p>从 byte、char 和 short 类型到 int 类型的宽化类型转换实际上是不存在的，JVM 把它们当作 int 处理</p>
</li>
</ul>
<p>窄化类型转换：</p>
<ul>
<li><p>Java 虚拟机直接支持以下窄化类型转换：</p>
<ul>
<li>从 int 类型至 byte、 short 或者 char 类型，对应的指令有 i2b、i2c、i2s</li>
<li>从 long 类型到 int 类型，对应的指令有 l2i</li>
<li>从 float 类型到 int 或者 long 类型，对应的指令有:f2i、f2l</li>
<li>从 double 类型到 int、long 或 float 者类型，对应的指令有 d2i、d2、d2f</li>
</ul>
</li>
<li><p>精度损失问题：</p>
<ul>
<li>窄化类型转换可能会导致转换结果具备不同的正负号、不同数量级，转换过程可能会导致数值丢失精度</li>
<li>将一个浮点值窄化转换为整数类型 T（T 限于 int 或 long 类型之一）时，将遵循以下转换规则：<ul>
<li>如果浮点值是 NaN，那转换结果就是 int 或 long 类型的 0</li>
<li>如果浮点值不是无穷大的话，浮点值使用 IEEE 754 的向零舍入模式取整，获得整数值 v，如果 v 在目标类型 T 的表示范围之内，那转换结果就是 v，否则将根据 v 的符号，转换为 T 所能表示的最大或者最小正数</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="4-对象的创建与访问指令"><a href="#4-对象的创建与访问指令" class="headerlink" title="4.对象的创建与访问指令"></a>4.对象的创建与访问指令</h3><ul>
<li><p><strong>创建类实例指令</strong>：new，接收一个操作数指向常量池的索引，表示要创建的类型，执行完成后将对象的引用压入栈</p>
</li>
<li><p><strong>创建数组的指令</strong>：newarray、anewarray、multianewarray</p>
<ul>
<li>newarray：创建基本类型数组</li>
<li>anewarray：创建引用类型数组</li>
<li>multianewarray：创建多维数组</li>
</ul>
<p>arraylength：取数组长度的指令。该指令弹出栈顶的数组元素，获取数组的长度，将长度压入栈。</p>
</li>
</ul>
<ul>
<li><p><strong>字段访问指令</strong>：对象创建后可以通过对象访问指令获取对象实例或数组实例中的字段或者数组元素</p>
<ul>
<li>getstatic：从类中获取静态字段（static字段&#x2F;类变量）</li>
<li>putstatic： 设置类中静态字段的值</li>
<li>getfield：获取类实例字段（非static字段&#x2F;实例变量）</li>
<li>putfield：设置类实例字段的值</li>
</ul>
</li>
<li><p><strong>类型检查指令</strong>：检查类实例或数组类型的指令</p>
<ul>
<li><p>checkcast：用于检查类型强制转换是否可以进行，如果可以进行 checkcast 指令不会改变操作数栈，否则它会抛出 ClassCastException 异常</p>
</li>
<li><p>instanceof：判断给定对象是否是某一个类的实例，会将判断结果压入操作数栈</p>
</li>
</ul>
</li>
</ul>
<h3 id="5-方法调用与返回指令"><a href="#5-方法调用与返回指令" class="headerlink" title="5.方法调用与返回指令"></a>5.方法调用与返回指令</h3><h4 id="方法调用指令"><a href="#方法调用指令" class="headerlink" title="方法调用指令"></a>方法调用指令</h4><p>普通调用指令：</p>
<ul>
<li>invokestatic：调用静态方法</li>
<li>invokespecial：调用私有方法、构造器，和父类的实例方法或构造器，以及所实现接口的默认方法</li>
<li>invokevirtual：调用所有虚方法（虚方法分派），支持多态</li>
<li>invokeinterface：调用接口方法</li>
</ul>
<p>动态调用指令：</p>
<ul>
<li>invokedynamic：调用动态绑定的方法，动态解析出需要调用的方法<ul>
<li>Java7 为了实现动态类型语言支持而引入了该指令，但是并没有提供直接生成 invokedynamic 指令的方法，需要借助 ASM 这种底层字节码工具来产生 invokedynamic 指令</li>
<li>Java8 的 lambda 表达式的出现，invokedynamic 指令在 Java 中才有了直接生成方式</li>
</ul>
</li>
</ul>
<p>指令对比：</p>
<ul>
<li>普通调用指令固化在虚拟机内部，方法的调用执行不可干预，根据方法的符号引用链接到具体的目标方法</li>
<li>动态调用指令支持用户确定方法</li>
<li>invokestatic 和 invokespecial 指令调用的方法称为非虚方法，虚拟机能够直接识别具体的目标方法</li>
<li>invokevirtual 和 invokeinterface 指令调用的方法称为虚方法，虚拟机需要在执行过程中根据调用者的动态类型来确定目标方法</li>
</ul>
<p>指令说明：</p>
<ul>
<li>如果虚拟机能够确定目标方法有且仅有一个，比如说目标方法被标记为 final，那么可以不通过动态绑定，直接确定目标方法</li>
<li>普通成员方法是由 invokevirtual 调用，属于<strong>动态绑定</strong>，即支持多态</li>
</ul>
<h4 id="方法返回指令"><a href="#方法返回指令" class="headerlink" title="方法返回指令"></a>方法返回指令</h4><p>方法调用结束前，需要进行返回。方法返回指令是根据返回值的类型区分的。</p>
<table>
<thead>
<tr>
<th>方法返回指令</th>
<th>void</th>
<th>int</th>
<th>long</th>
<th>float</th>
<th>double</th>
<th>reference</th>
</tr>
</thead>
<tbody><tr>
<td><strong>xreturn</strong></td>
<td>return</td>
<td>ireturn</td>
<td>lreturn</td>
<td>freutrn</td>
<td>dreturn</td>
<td>areturn</td>
</tr>
</tbody></table>
<p>ireturn（当返回值是boolean、byte、char、short和int 类型时使用）</p>
<p>通过ireturn指令，将当前函数操作数栈的顶层元素弹出，并将这个元素压入调用者函数的操作数栈中（因为调用者非常关心函数的返回值），所有在当前函数操作数栈中的其他元素都会被丢弃。</p>
<p>如果当前返回的是synchronized方法，那么还会执行一个隐含的monitorexit指令，退出临界区。</p>
<p>最后，会丢弃当前方法的整个帧，恢复调用者的帧，并将控制权转交给调用者。</p>
<h3 id="6-操作数栈管理指令"><a href="#6-操作数栈管理指令" class="headerlink" title="6.操作数栈管理指令"></a>6.操作数栈管理指令</h3><blockquote>
<p>JVM 提供的操作数栈管理指令，可以用于直接操作操作数栈的指令</p>
</blockquote>
<ul>
<li><p>pop、pop2：将一个或两个元素从栈顶弹出，并且直接废弃</p>
</li>
<li><p>dup、dup2，dup_x1、dup2_x1，dup_x2、dup2_x2：复制栈顶一个或两个数值并重新压入栈顶</p>
</li>
<li><p>swap：将栈最顶端的两个 slot 数值位置交换，JVM 没有提供交换两个 64 位数据类型数值的指令</p>
</li>
<li><p>nop：一个非常特殊的指令，字节码为 0x00，和汇编语言中的 nop 一样，表示什么都不做，一般可用于调试、占位等</p>
</li>
</ul>
<h3 id="7-比较控制指令"><a href="#7-比较控制指令" class="headerlink" title="7.比较控制指令"></a>7.比较控制指令</h3><p>比较指令：比较栈顶两个元素的大小，并将比较结果入栈</p>
<ul>
<li>lcmp：比较两个 long 类型值</li>
<li>fcmpl：比较两个 float 类型值（当遇到NaN时，返回-1）</li>
<li>fcmpg：比较两个 float 类型值（当遇到NaN时，返回1）</li>
<li>dcmpl：比较两个 double 类型值（当遇到NaN时，返回-1）</li>
<li>dcmpg：比较两个 double 类型值（当遇到NaN时，返回1）</li>
</ul>
<p>条件跳转指令：</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>ifeq</td>
<td>equals，当栈顶int类型数值等于0时跳转</td>
</tr>
<tr>
<td>ifne</td>
<td>not equals，当栈顶in类型数值不等于0时跳转</td>
</tr>
<tr>
<td>iflt</td>
<td>lower than，当栈顶in类型数值小于0时跳转</td>
</tr>
<tr>
<td>ifle</td>
<td>lower or equals，当栈顶in类型数值小于等于0时跳转</td>
</tr>
<tr>
<td>ifgt</td>
<td>greater than，当栈顶int类型数组大于0时跳转</td>
</tr>
<tr>
<td>ifge</td>
<td>greater or equals，当栈顶in类型数值大于等于0时跳转</td>
</tr>
<tr>
<td>ifnull</td>
<td>为 null 时跳转</td>
</tr>
<tr>
<td>ifnonnull</td>
<td>不为 null 时跳转</td>
</tr>
</tbody></table>
<p>比较条件跳转指令：</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>if_icmpeq</td>
<td>比较栈顶两 int 类型数值大小（下同），当前者等于后者时跳转</td>
</tr>
<tr>
<td>if_icmpne</td>
<td>当前者不等于后者时跳转</td>
</tr>
<tr>
<td>if_icmplt</td>
<td>当前者小于后者时跳转</td>
</tr>
<tr>
<td>if_icmple</td>
<td>当前者小于等于后者时跳转</td>
</tr>
<tr>
<td>if_icmpgt</td>
<td>当前者大于后者时跳转</td>
</tr>
<tr>
<td>if_icmpge</td>
<td>当前者大于等于后者时跳转</td>
</tr>
<tr>
<td>if_acmpeq</td>
<td>当结果相等时跳转</td>
</tr>
<tr>
<td>if_acmpne</td>
<td>当结果不相等时跳转</td>
</tr>
</tbody></table>
<p>多条件分支跳转指令：</p>
<ul>
<li>tableswitch：用于 switch 条件跳转，case 值连续</li>
<li>lookupswitch：用于 switch 条件跳转，case 值不连续</li>
</ul>
<p>无条件跳转指令：</p>
<ul>
<li><p>goto：用来进行跳转到指定行号的字节码</p>
</li>
<li><p>goto_w：无条件跳转（宽索引）</p>
</li>
</ul>
<h3 id="8-异常处理指令"><a href="#8-异常处理指令" class="headerlink" title="8.异常处理指令"></a>8.异常处理指令</h3><p><strong>抛出异常指令</strong>：athrow 指令，在Java程序中显示抛出异常的操作（throw语句）都是由athrow指令来实现。</p>
<p><strong>处理异常</strong>：</p>
<p>JVM 处理异常（catch 语句）不是由字节码指令来实现的，而是<strong>采用异常表来完成</strong>的</p>
<ul>
<li><p>代码：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>    
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    
    <span class="token keyword">try</span> <span class="token punctuation">{</span>    	
        i <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>   
        i <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>   
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        i <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>字节码：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token number">0</span><span class="token operator">:</span> 	iconst_0
    <span class="token number">1</span><span class="token operator">:</span> 	istore_1 	<span class="token comment" spellcheck="true">// 0 -> i	->赋值</span>
    <span class="token number">2</span><span class="token operator">:</span> 	bipush <span class="token number">10</span> 	<span class="token comment" spellcheck="true">// try 10 放入操作数栈顶</span>
    <span class="token number">4</span><span class="token operator">:</span> 	istore_1 	<span class="token comment" spellcheck="true">// 10 -> i 将操作数栈顶数据弹出，存入局部变量表的 slot1</span>
    <span class="token number">5</span><span class="token operator">:</span> 	bipush <span class="token number">30</span> 	<span class="token comment" spellcheck="true">// 【finally】 </span>
    <span class="token number">7</span><span class="token operator">:</span> 	istore_1 	<span class="token comment" spellcheck="true">// 30 -> i </span>
    <span class="token number">8</span><span class="token operator">:</span> 	<span class="token keyword">goto</span> <span class="token number">27</span> 	<span class="token comment" spellcheck="true">// return </span>
    <span class="token number">11</span><span class="token operator">:</span> astore_2 	<span class="token comment" spellcheck="true">// catch Exceptin -> e </span>
    <span class="token number">12</span><span class="token operator">:</span> bipush <span class="token number">20</span> 	<span class="token comment" spellcheck="true">// </span>
    <span class="token number">14</span><span class="token operator">:</span> istore_1 	<span class="token comment" spellcheck="true">// 20 -> i </span>
    <span class="token number">15</span><span class="token operator">:</span> bipush <span class="token number">30</span> 	<span class="token comment" spellcheck="true">// 【finally】 </span>
    <span class="token number">17</span><span class="token operator">:</span> istore_1 	<span class="token comment" spellcheck="true">// 30 -> i </span>
    <span class="token number">18</span><span class="token operator">:</span> <span class="token keyword">goto</span> <span class="token number">27</span> 	<span class="token comment" spellcheck="true">// return </span>
    <span class="token number">21</span><span class="token operator">:</span> astore_3 	<span class="token comment" spellcheck="true">// catch any -> slot 3 </span>
    <span class="token number">22</span><span class="token operator">:</span> bipush <span class="token number">30</span> 	<span class="token comment" spellcheck="true">// 【finally】</span>
    <span class="token number">24</span><span class="token operator">:</span> istore_1 	<span class="token comment" spellcheck="true">// 30 -> i </span>
    <span class="token number">25</span><span class="token operator">:</span> aload_3 	<span class="token comment" spellcheck="true">// 将局部变量表的slot 3数据弹出，放入操作数栈栈顶</span>
    <span class="token number">26</span><span class="token operator">:</span> athrow 		<span class="token comment" spellcheck="true">// throw 抛出异常</span>
    <span class="token number">27</span><span class="token operator">:</span> <span class="token keyword">return</span>
Exception table<span class="token operator">:</span>  <span class="token comment" spellcheck="true">// 任何阶段出现任务异常都会执行 finally</span>
    from   to 	target 	type
        <span class="token number">2</span>	   <span class="token number">5</span> 		  <span class="token number">11</span> 	  Class <span class="token class-name">java</span><span class="token operator">/</span>lang<span class="token operator">/</span>Exception
        <span class="token number">2</span> 	 <span class="token number">5</span> 		  <span class="token number">21</span> 	  any <span class="token comment" spellcheck="true">// 剩余的异常类型，比如 Error</span>
        <span class="token number">11</span>  <span class="token number">15</span> 		  <span class="token number">21</span> 	  any <span class="token comment" spellcheck="true">// 剩余的异常类型，比如 Error</span>
LineNumberTable<span class="token operator">:</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
LocalVariableTable<span class="token operator">:</span>
    Start Length Slot Name Signature
    <span class="token number">12</span> 		  <span class="token number">3</span> 		<span class="token number">2</span> 	 e 	  Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>Exception<span class="token punctuation">;</span>
     <span class="token number">0</span> 		 <span class="token number">28</span> 		<span class="token number">0</span>   args 	<span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span>
     <span class="token number">2</span> 		 <span class="token number">26</span> 		<span class="token number">1</span> 	 i 	  I
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>如果一个方法定义了一个try-catch 或者try-finally的异常处理，就会创建一个 <strong>Exception table</strong> 的结构，异常表保存了每个异常处理信息</p>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">Exception table<span class="token operator">:</span>  
    from   to 	target 	type
        <span class="token number">2</span>	   <span class="token number">5</span> 		 <span class="token number">11</span> 	  Class <span class="token class-name">java</span><span class="token operator">/</span>lang<span class="token operator">/</span>Exception
        <span class="token number">2</span> 	 <span class="token number">5</span> 		 <span class="token number">21</span> 	  any <span class="token comment" spellcheck="true">// 剩余的异常类型，比如 Error</span>
     <span class="token number">11</span>   <span class="token number">15</span> 		 <span class="token number">21</span> 	  any <span class="token comment" spellcheck="true">// 剩余的异常类型，比如 Error</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><strong>[from, to) 是前闭后开的检测范围</strong>，一旦这个范围内的字节码执行出现异常，则通过 type 匹配异常类型，如果一致，进入 target 所指示行号</li>
</ul>
<ul>
<li>11 行的字节码指令 astore_2 是将异常对象引用存入局部变量表的 slot 2 位置，如果有多个catch语句，因为异常出现时，只能进入 Exception table 中一个分支，所以局部变量表 slot 2 位置被共用</li>
<li>字节码中 finally 中的代码被<strong>复制了 3 份</strong>，分别放入 try 流程，catch 流程以及 catch 剩余的异常类型流程，因此finally中的代码一定会执行</li>
</ul>
<h3 id="9-同步控制指令"><a href="#9-同步控制指令" class="headerlink" title="9.同步控制指令"></a>9.同步控制指令</h3><blockquote>
<p>Java虚拟机支持两种同步结构：方法级的同步和方法内部一段指令序列的同步，这两种同步都是使用monitor来支持的</p>
</blockquote>
<p><strong>方法级的同步</strong>：是隐式的，无须通过字节码指令来控制，它实现在方法调用和返回操作之中，虚拟机可以从方法常量池的方法表结构中的 ACC_SYNCHRONIZED 访问标志得知一个方法是否声明为同步方法</p>
<p><strong>方法内指定指令序列的同步</strong>：有 monitorenter 和 monitorexit 两条指令来支持 synchronized 关键字的语义</p>
<ul>
<li>montiorenter：进入并获取对象监视器，即为栈顶对象加锁</li>
<li>monitorexit：释放并退出对象监视器，即为栈顶对象解锁</li>
</ul>
<img src="https://img.jwt1399.top/img/202212231517239.png" style="zoom: 33%;" />







<h3 id="🌟图解字节码运行"><a href="#🌟图解字节码运行" class="headerlink" title="🌟图解字节码运行"></a>🌟图解字节码运行</h3><p>1）原始java 代码</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*
    演示 字节码指令 和 操作数栈、常量池的关系
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> b <span class="token operator">=</span> Short<span class="token punctuation">.</span>MAX_VALUE <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//32767 + 1</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2）编译后的核心字节码文件</p>
<pre class="line-numbers language-java"><code class="language-java">  MD5 checksum cc8fc12b6e178b8f28e787497e993363
  Compiled from <span class="token string">"Demo.java"</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">com<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>test<span class="token punctuation">.</span>Demo</span>
  minor version<span class="token operator">:</span> <span class="token number">0</span>
  major version<span class="token operator">:</span> <span class="token number">52</span>
  flags<span class="token operator">:</span> ACC_PUBLIC<span class="token punctuation">,</span> ACC_SUPER
Constant pool<span class="token operator">:</span>
   #<span class="token number">1</span> <span class="token operator">=</span> Methodref          #<span class="token number">7</span><span class="token punctuation">.</span>#<span class="token number">25</span>         <span class="token comment" spellcheck="true">// java/lang/Object."&lt;init>":()V</span>
   #<span class="token number">2</span> <span class="token operator">=</span> Class              #<span class="token number">26</span>            <span class="token comment" spellcheck="true">// java/lang/Short</span>
   #<span class="token number">3</span> <span class="token operator">=</span> Integer            <span class="token number">32768</span>
   #<span class="token number">4</span> <span class="token operator">=</span> Fieldref           #<span class="token number">27</span><span class="token punctuation">.</span>#<span class="token number">28</span>        <span class="token comment" spellcheck="true">// java/lang/System.out:Ljava/io/PrintStream;</span>
   #<span class="token number">5</span> <span class="token operator">=</span> Methodref          #<span class="token number">29</span><span class="token punctuation">.</span>#<span class="token number">30</span>        <span class="token comment" spellcheck="true">// java/io/PrintStream.println:(I)V</span>
   #<span class="token number">6</span> <span class="token operator">=</span> Class              #<span class="token number">31</span>            <span class="token comment" spellcheck="true">// com/jvm/test/Demo</span>
   #<span class="token number">7</span> <span class="token operator">=</span> Class              #<span class="token number">32</span>            <span class="token comment" spellcheck="true">// java/lang/Object</span>
   #<span class="token number">8</span> <span class="token operator">=</span> Utf8               <span class="token operator">&lt;</span>init<span class="token operator">></span>
   #<span class="token number">9</span> <span class="token operator">=</span> <span class="token function">Utf8</span>               <span class="token punctuation">(</span><span class="token punctuation">)</span>V
  #<span class="token number">10</span> <span class="token operator">=</span> Utf8               Code
  #<span class="token number">11</span> <span class="token operator">=</span> Utf8               LineNumberTable
  #<span class="token number">12</span> <span class="token operator">=</span> Utf8               LocalVariableTable
  #<span class="token number">13</span> <span class="token operator">=</span> Utf8               <span class="token keyword">this</span>
  #<span class="token number">14</span> <span class="token operator">=</span> Utf8               Lcom<span class="token operator">/</span>jvm<span class="token operator">/</span>test<span class="token operator">/</span>Demo<span class="token punctuation">;</span>
  #<span class="token number">15</span> <span class="token operator">=</span> Utf8               main
  #<span class="token number">16</span> <span class="token operator">=</span> <span class="token function">Utf8</span>               <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
  #<span class="token number">17</span> <span class="token operator">=</span> Utf8               args
  #<span class="token number">18</span> <span class="token operator">=</span> Utf8               <span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span>
  #<span class="token number">19</span> <span class="token operator">=</span> Utf8               a
  #<span class="token number">20</span> <span class="token operator">=</span> Utf8               I
  #<span class="token number">21</span> <span class="token operator">=</span> Utf8               b
  #<span class="token number">22</span> <span class="token operator">=</span> Utf8               c
  #<span class="token number">23</span> <span class="token operator">=</span> Utf8               SourceFile
  #<span class="token number">24</span> <span class="token operator">=</span> Utf8               Demo<span class="token punctuation">.</span>java
  #<span class="token number">25</span> <span class="token operator">=</span> NameAndType        #<span class="token number">8</span><span class="token operator">:</span>#<span class="token number">9</span>          <span class="token comment" spellcheck="true">// "&lt;init>":()V</span>
  #<span class="token number">26</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>lang<span class="token operator">/</span>Short
  #<span class="token number">27</span> <span class="token operator">=</span> Class              #<span class="token number">33</span>            <span class="token comment" spellcheck="true">// java/lang/System</span>
  #<span class="token number">28</span> <span class="token operator">=</span> NameAndType        #<span class="token number">34</span><span class="token operator">:</span>#<span class="token number">35</span>        <span class="token comment" spellcheck="true">// out:Ljava/io/PrintStream;</span>
  #<span class="token number">29</span> <span class="token operator">=</span> Class              #<span class="token number">36</span>            <span class="token comment" spellcheck="true">// java/io/PrintStream</span>
  #<span class="token number">30</span> <span class="token operator">=</span> NameAndType        #<span class="token number">37</span><span class="token operator">:</span>#<span class="token number">38</span>        <span class="token comment" spellcheck="true">// println:(I)V</span>
  #<span class="token number">31</span> <span class="token operator">=</span> Utf8               com<span class="token operator">/</span>jvm<span class="token operator">/</span>test<span class="token operator">/</span>Demo
  #<span class="token number">32</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>lang<span class="token operator">/</span>Object
  #<span class="token number">33</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>lang<span class="token operator">/</span>System
  #<span class="token number">34</span> <span class="token operator">=</span> Utf8               out
  #<span class="token number">35</span> <span class="token operator">=</span> Utf8               Ljava<span class="token operator">/</span>io<span class="token operator">/</span>PrintStream<span class="token punctuation">;</span>
  #<span class="token number">36</span> <span class="token operator">=</span> Utf8               java<span class="token operator">/</span>io<span class="token operator">/</span>PrintStream
  #<span class="token number">37</span> <span class="token operator">=</span> Utf8               println
  #<span class="token number">38</span> <span class="token operator">=</span> <span class="token function">Utf8</span>               <span class="token punctuation">(</span>I<span class="token punctuation">)</span>V
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> com<span class="token punctuation">.</span>jvm<span class="token punctuation">.</span>test<span class="token punctuation">.</span><span class="token function">Demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>V
    flags<span class="token operator">:</span> ACC_PUBLIC
    Code<span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span><span class="token operator">:</span> aload_0
         <span class="token number">1</span><span class="token operator">:</span> invokespecial #<span class="token number">1</span>                  <span class="token comment" spellcheck="true">// Method java/lang/Object."&lt;init>":()V</span>
         <span class="token number">4</span><span class="token operator">:</span> <span class="token keyword">return</span>
      LineNumberTable<span class="token operator">:</span>
        line <span class="token number">15</span><span class="token operator">:</span> <span class="token number">0</span>
      LocalVariableTable<span class="token operator">:</span>
        Start  Length  Slot  Name   Signature
            <span class="token number">0</span>       <span class="token number">5</span>     <span class="token number">0</span>  <span class="token keyword">this</span>   Lcom<span class="token operator">/</span>jvm<span class="token operator">/</span>test<span class="token operator">/</span>Demo<span class="token punctuation">;</span>
 
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
    flags<span class="token operator">:</span> ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC
    Code<span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span><span class="token operator">:</span> bipush        <span class="token number">10</span>
         <span class="token number">2</span><span class="token operator">:</span> istore_1
         <span class="token number">3</span><span class="token operator">:</span> ldc           #<span class="token number">3</span>                  <span class="token comment" spellcheck="true">// int 32768</span>
         <span class="token number">5</span><span class="token operator">:</span> istore_2
         <span class="token number">6</span><span class="token operator">:</span> iload_1
         <span class="token number">7</span><span class="token operator">:</span> iload_2
         <span class="token number">8</span><span class="token operator">:</span> iadd
         <span class="token number">9</span><span class="token operator">:</span> istore_3
        <span class="token number">10</span><span class="token operator">:</span> getstatic     #<span class="token number">4</span>        <span class="token comment" spellcheck="true">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
        <span class="token number">13</span><span class="token operator">:</span> iload_3
        <span class="token number">14</span><span class="token operator">:</span> invokevirtual #<span class="token number">5</span>        <span class="token comment" spellcheck="true">// Method java/io/PrintStream.println:(I)V</span>
        <span class="token number">17</span><span class="token operator">:</span> <span class="token keyword">return</span>
      LineNumberTable<span class="token operator">:</span>
        line <span class="token number">17</span><span class="token operator">:</span> <span class="token number">0</span>
        line <span class="token number">18</span><span class="token operator">:</span> <span class="token number">3</span>
        line <span class="token number">19</span><span class="token operator">:</span> <span class="token number">6</span>
        line <span class="token number">20</span><span class="token operator">:</span> <span class="token number">10</span>
        line <span class="token number">21</span><span class="token operator">:</span> <span class="token number">17</span>
      LocalVariableTable<span class="token operator">:</span>
        Start  Length  Slot  Name   Signature
            <span class="token number">0</span>      <span class="token number">18</span>     <span class="token number">0</span>  args   <span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span>
            <span class="token number">3</span>      <span class="token number">15</span>     <span class="token number">1</span>     a   I
            <span class="token number">6</span>      <span class="token number">12</span>     <span class="token number">2</span>     b   I
           <span class="token number">10</span>       <span class="token number">8</span>     <span class="token number">3</span>     c   I
<span class="token punctuation">}</span>
SourceFile<span class="token operator">:</span> <span class="token string">"Demo.java"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>3）常量池载入运行时常量池</p>
<p><img src="https://img.jwt1399.top/img/202212231525849.png"></p>
<p>4）方法字节码载入方法区</p>
<p><img src="https://img.jwt1399.top/img/202212231525099.png"></p>
<p>5）main线程开始运行，分配栈帧内存（stack&#x3D;2,  locals&#x3D;4）</p>
<p><img src="https://img.jwt1399.top/img/202212231525266.png">  </p>
<p>6）执行引擎开始执行字节码</p>
<p>bipush 10</p>
<ul>
<li>将一个byte压入操作数栈（其长度会补齐4个字节），类似的指令还有</li>
<li>sipush将一个short压入操作数栈（其长度会补齐4个字节）</li>
<li>idc将一个int压入操作数栈</li>
<li>idc2_w将一个long压入操作数栈（分两次压入，因为long是8个字节）</li>
<li>这里小的数字都是和字节码指令存在一起，超过short范围的数字存入常量池</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212231526930.png"></p>
<p>istore_1</p>
<ul>
<li>将操作数栈顶数据弹出，存入局部变量表的槽位slot 1中，下图的args&#x2F;a&#x2F;b&#x2F;c就是对应的槽位</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212231526080.png"></p>
<p><img src="https://img.jwt1399.top/img/202212231526737.png"></p>
<p>idc  #3</p>
<ul>
<li>idc 从常量池加载 #3 数据到操作数栈</li>
<li><strong>注意：</strong> Short.MAX_VALUE是32767，所以32768 &#x3D; Short.MAX_VALUE + 1 超过了Short.MAX_VALUE的值，所以编译器将其放在运行时常量池中。实际是在编译期间计算好的，是一种优化，叫常量折叠优化</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212231526161.png"></p>
<p>istore_2</p>
<ul>
<li>将操作数栈顶数据弹出，存入局部变量表的2号槽位中</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212231526604.png"></p>
<p><img src="https://img.jwt1399.top/img/202212231526004.png"></p>
<p>iload_1</p>
<p>再接下来，需要执行int c &#x3D; a + b；执行引擎不能直接在局部变量表进行a+b操作，需要先将a、b进行读取，然后放入操作数栈中才能进行计算分析</p>
<ul>
<li>把局部变量从1号槽位加载数据到操作数栈中</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212231526636.png"></p>
<p>iload 2</p>
<ul>
<li>再把局部变量从2号槽位加载数据到操作数栈中</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212231526141.png"></p>
<p>iadd</p>
<ul>
<li>iadd会弹出操作数栈中的2个变量，并进行求和得到32778，最后将结果32778写回到操作数栈中</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212231526224.png"></p>
<p><img src="https://img.jwt1399.top/img/202212231527135.png"><br>istore_3</p>
<ul>
<li>将操作数栈的数弹出，存入局部变量表3号槽位。到目前为止，局部变量a、b、c都有值了</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212231527590.png"></p>
<p><img src="https://img.jwt1399.top/img/202212231527063.png"></p>
<p>getstatic #4</p>
<ul>
<li>去常量池找到成员变量引用，去堆中找到System.out对象。getstatic 会把对象引用放入操作数栈中</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212231527694.png"></p>
<p><img src="https://img.jwt1399.top/img/202212231527400.png"></p>
<p>iload_3</p>
<ul>
<li>将局部变量表3号槽位的值加载到操作数栈中</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212231527091.png"></p>
<p><img src="https://img.jwt1399.top/img/202212231527091.png"></p>
<p>invokevirtual #5</p>
<ul>
<li>找到常量池 #5项</li>
<li>定位到方法区 java&#x2F;io&#x2F;PrintStream.println: (I)V方法</li>
<li>生成新的栈帧（分配locals、stack等）</li>
<li>传递传数，执行新栈帧中的字节码</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212231528002.png"></p>
<ul>
<li>执行完毕，弹出栈帧</li>
<li>清除main操作数栈内容</li>
</ul>
<p><img src="https://img.jwt1399.top/img/202212231528262.png"></p>
<p>return</p>
<ul>
<li>完成main方法调用，弹出main栈帧</li>
<li>程序结束</li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_32265569/article/details/107904061">Java字节码的一段旅行经历——提升硬实力1</a></p>
<h3 id="🌟a-字节码分析"><a href="#🌟a-字节码分析" class="headerlink" title="🌟a++ 字节码分析"></a>🌟a++ 字节码分析</h3><p>在日常的项目开发中，经常遇到a++、++a、a–之类，下面我们开始从字节码的视角来分析a++。</p>
<p>java代码如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/*
 从字节码角度分析  a++ 相关题目
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> b <span class="token operator">=</span> a<span class="token operator">++</span> <span class="token operator">+</span> <span class="token operator">++</span>a <span class="token operator">+</span> a<span class="token operator">--</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用javap -v xxx.class 来查看类文件全部指令信息，如下：</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    descriptor<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span><span class="token punctuation">)</span>V
    flags<span class="token operator">:</span> ACC_PUBLIC<span class="token punctuation">,</span> ACC_STATIC
    Code<span class="token operator">:</span>
      stack<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> locals<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> args_size<span class="token operator">=</span><span class="token number">1</span>
         <span class="token number">0</span><span class="token operator">:</span> bipush        <span class="token number">10</span>
         <span class="token number">2</span><span class="token operator">:</span> istore_1
         <span class="token number">3</span><span class="token operator">:</span> iload_1
         <span class="token number">4</span><span class="token operator">:</span> iinc          <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>
         <span class="token number">7</span><span class="token operator">:</span> iinc          <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>
        <span class="token number">10</span><span class="token operator">:</span> iload_1
        <span class="token number">11</span><span class="token operator">:</span> iadd
        <span class="token number">12</span><span class="token operator">:</span> iload_1
        <span class="token number">13</span><span class="token operator">:</span> iinc          <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token number">16</span><span class="token operator">:</span> iadd
        <span class="token number">17</span><span class="token operator">:</span> istore_2
        <span class="token number">18</span><span class="token operator">:</span> getstatic     #<span class="token number">2</span>          <span class="token comment" spellcheck="true">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
        <span class="token number">21</span><span class="token operator">:</span> iload_1
        <span class="token number">22</span><span class="token operator">:</span> invokevirtual #<span class="token number">3</span>          <span class="token comment" spellcheck="true">// Method java/io/PrintStream.println:(I)V</span>
        <span class="token number">25</span><span class="token operator">:</span> getstatic     #<span class="token number">2</span>          <span class="token comment" spellcheck="true">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
        <span class="token number">28</span><span class="token operator">:</span> iload_2
        <span class="token number">29</span><span class="token operator">:</span> invokevirtual #<span class="token number">3</span>          <span class="token comment" spellcheck="true">// Method java/io/PrintStream.println:(I)V</span>
        <span class="token number">32</span><span class="token operator">:</span> <span class="token keyword">return</span>
      LineNumberTable<span class="token operator">:</span>
        line <span class="token number">17</span><span class="token operator">:</span> <span class="token number">0</span>
        line <span class="token number">18</span><span class="token operator">:</span> <span class="token number">3</span>
        line <span class="token number">19</span><span class="token operator">:</span> <span class="token number">18</span>
        line <span class="token number">20</span><span class="token operator">:</span> <span class="token number">25</span>
        line <span class="token number">21</span><span class="token operator">:</span> <span class="token number">32</span>
      LocalVariableTable<span class="token operator">:</span>
        Start  Length  Slot  Name   Signature
            <span class="token number">0</span>      <span class="token number">33</span>     <span class="token number">0</span>  args   <span class="token punctuation">[</span>Ljava<span class="token operator">/</span>lang<span class="token operator">/</span>String<span class="token punctuation">;</span>
            <span class="token number">3</span>      <span class="token number">30</span>     <span class="token number">1</span>     a   I
           <span class="token number">18</span>      <span class="token number">15</span>     <span class="token number">2</span>     b   I
<span class="token punctuation">}</span>
SourceFile<span class="token operator">:</span> <span class="token string">"Demo.java"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分析：</p>
<ul>
<li>iinc指令是直接在局部变量槽位slot上进行运算</li>
<li>a++ 和 ++a 的区别是先执行 iload 还是先执行 iinc<ul>
<li>a++是先加载iload，再自增iinc</li>
<li>++a是先自增iinc，再加载iload</li>
</ul>
</li>
</ul>
<p>下面我们通过字节码来剖析如下两行代码在内存当中整个执行过程</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> b <span class="token operator">=</span> a<span class="token operator">++</span> <span class="token operator">+</span> <span class="token operator">++</span>a <span class="token operator">+</span> a<span class="token operator">--</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>下图是先将10通过bipush 放入操作数栈中</p>
<p><img src="https://img.jwt1399.top/img/202212231530556.png"></p>
<p>接着将10从操作数栈上弹出存入局部变量表1号槽位，相当于代码 int a &#x3D; 10 执行完成</p>
<p><img src="https://img.jwt1399.top/img/202212231530112.png"></p>
<p>接着执行：int b &#x3D; a++ + ++a + a–; 因为有从左往右的执行顺序，所以先执行a++，先将a的值加载到操作数栈中；通过iload_1加载1号槽位的数据到操作数栈中</p>
<p><img src="https://img.jwt1399.top/img/202212231530986.png"></p>
<p>接着执行a++自增1操作，这个操作是在局部变量表中完成的。相当于完成了a++执行</p>
<p><img src="https://img.jwt1399.top/img/202212231530544.png"></p>
<p>再接着执行++a自增1操作，这个操作也是在局部变量表中完成的</p>
<p><img src="https://img.jwt1399.top/img/202212231530149.png"></p>
<p>接着从局部变量表1号槽位加载数据到操作数栈中，即12入栈，完成发a++  、++a 各自的执行了</p>
<p><img src="https://img.jwt1399.top/img/202212231530866.png"></p>
<p>然后，iadd是将操作数栈中弹出（出栈）两个数12、10进行求和操作，得到22，最后将累加的结果22存入栈中。即完成了a++  + ++a的执行</p>
<p><img src="https://img.jwt1399.top/img/202212231530345.png"></p>
<p>接着，需要执行a–，先将局部变量表槽位1的数据12加载到操作数栈中</p>
<p><img src="https://img.jwt1399.top/img/202212231531507.png"></p>
<p>然后，将局部变量表槽位1的数据自减1</p>
<p><img src="https://img.jwt1399.top/img/202212231531205.png"></p>
<p>接着，执行iadd操作，将操作数栈12、22弹出栈后，进行求和操作得到34，再将34结果压入栈</p>
<p><img src="https://img.jwt1399.top/img/202212231531053.png"></p>
<p>最后，执行istore_2操作，将操作数栈弹出数据34，并压入局部变量表2号槽位中</p>
<p><img src="https://img.jwt1399.top/img/202212231531053.png"></p>
<p><img src="https://img.jwt1399.top/img/202212231533680.png"></p>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_32265569/article/details/107970980">Java字节码角度分析a++ ——提升硬实力2</a></p>
<h2 id="❷编译器"><a href="#❷编译器" class="headerlink" title="❷编译器"></a>❷编译器</h2><ul>
<li><strong>前端编译器</strong>：把 <code>*.java</code> 文件转变成 <code>.class</code> 文件的过程；如 JDK 的 Javac，Eclipse JDT 中的增量式编译器。</li>
<li><strong>提前编译器</strong>：直接把程序编译成目标机器指令集相关的二进制代码的过程。如 JDK 的 jaotc，GUN Compiler for the Java（GCJ），Excelsior JET 。</li>
<li><strong>即时编译器</strong>：常称为 JIT 编译器（Just In Time Complier），在运行期把字节码转变成本地机器码的过程；如 HotSpot 虚拟机中的 C1、C2 编译器，Graal 编译器。<ul>
<li>**客户端编译器 (Client Complier)**：简称 C1；</li>
<li>**服务端编译器 (Servier Complier)**：简称 C2；</li>
<li><strong>Graal 编译器</strong>：在 JDK 10 时才出现，长期目标是替代 C2。</li>
</ul>
</li>
</ul>
<p>C1 编译器会对字节码进行简单可靠的优化，耗时短，以达到更快的编译速度。</p>
<p>C1 编译器的优化方法：</p>
<ul>
<li><p>方法内联：<strong>将调用的函数代码编译到调用点处</strong>，可以减少栈帧的生成，减少参数传递以及跳转过程</p>
</li>
<li><p>冗余消除：根据运行时状况进行代码折叠或削除</p>
</li>
<li><p>内联缓存：是一种加快动态绑定的优化技术（方法调用部分详解）</p>
</li>
</ul>
<p>C2 编译器进行耗时较长的优化以及激进优化，优化的代码执行效率更高，当激进优化的假设不成立时，再退回使用 C1 编译，这也是使用分层编译的原因</p>
<p>C2 的优化主要是在全局层面，<strong>逃逸分析</strong>是优化的基础，如果不存在逃逸行为，则可进行如下优化：</p>
<ul>
<li>**栈上分配 (Stack Allocations)**：如果一个对象不会逃逸到线程外，那么将会在栈上分配内存来创建这个对象，而不是 Java 堆上，此时对象所占用的内存空间就会随着栈帧的出栈而销毁，从而可以减轻垃圾回收的压力。</li>
<li>**标量替换 (Scalar Replacement)**：如果一个数据已经无法再分解成为更小的数据类型，那么这些数据就称为标量（如 int、long 等数值类型及 reference 类型等）；反之，如果一个数据可以继续分解，那它就被称为聚合量（如对象）。如果一个对象不会逃逸外方法外，那么就可以将其改为直接创建若干个被这个方法使用的成员变量来替代，从而减少内存占用。</li>
<li><strong>同步消除 (Synchronization Elimination)<strong>：线程同步本身比较耗时，如果确定一个对象不会逃逸出线程，不被其它线程访问到，那对象的读写就不会存在竞争，则可以消除对该对象的</strong>同步锁</strong>，通过 &#96;</li>
</ul>
<h2 id="❸执行引擎-解释-JIT"><a href="#❸执行引擎-解释-JIT" class="headerlink" title="❸执行引擎(解释+JIT)"></a>❸执行引擎(解释+JIT)</h2><p>Java 是<strong>半编译半解释型语言</strong>，将解释执行与编译执行二者结合起来进行：</p>
<ul>
<li>解释器：根据预定义的规范对字节码采用逐行解释的方式执行，即将每条字节码指令翻译为对应平台的本地机器指令执行</li>
<li>即时编译器（JIT : Just In Time Compiler）：虚拟机在运行期把字节码编译成本地机器码后执行，并存入 Code Cache，下次遇到相同的代码直接执行，效率高</li>
</ul>
<ul>
<li>编译器（Compiler）和解释器（Interpreter）的工作都是将程序员的源代码翻译成可执行的机器代码，要么一次性翻译（编译器），要么逐行解释并运行（解释器）。</li>
</ul>
<p>HostSpot  的默认执行方式：</p>
<ul>
<li>当程序启动后，解释器可以马上发挥作用立即执行，让程序快速启动，省去编译器编译的时间（解释器存在的<strong>必要性</strong>）</li>
<li>随着程序运行时间的推移，如果虚拟机<u>发现某个方法或代码块的运行特别频繁</u>（<strong>热点探测功能</strong>），就会<u>使用即时编译器</u>将其编译为本地机器码，并使用各种手段进行优化，从而提高执行效率</li>
</ul>
<img src="https://img.jwt1399.top/img/202212261031834.png" style="zoom: 67%;" />

<p>HotSpot  可以通过 VM 参数设置程序执行方式：</p>
<ul>
<li>-Xint：完全采用解释器模式执行程序</li>
<li>-Xcomp：完全采用即时编译器模式执行程序。如果即时编译出现问题，解释器会介入执行</li>
<li>-Xmixed：采用解释器 + 即时编译器的混合模式共同执行程序</li>
</ul>
<h2 id="❹分层编译"><a href="#❹分层编译" class="headerlink" title="❹分层编译"></a>❹分层编译</h2><blockquote>
<p>在分层编译的工作模式出现前，采用客户端编译器还是服务端编译器完全取决于虚拟机是运行在客户端模式还是服务端模式下，可以在启动时通过 <code>-client</code> 或 <code>-server</code> 参数进行指定，也可以让虚拟机根据自身版本和宿主机性能来自主选择。</p>
</blockquote>
<p>要编译出优化程度越高的代码通常都需要越长的编译时间，为了在程序启动速度与运行效率之间达到最佳平衡，HotSpot 虚拟机在编译子系统中加入了分层编译（Tiered Compilation），JVM 将执行状态分成了 5 个层次：</p>
<ul>
<li><strong>第 0 层</strong>：纯解释器执行，并且解释器不开启性能监控功能；</li>
<li><strong>第 1 层</strong>：使用C1即时编译器编译执行，进行简单可靠的稳定优化，不开启性能监控功能；</li>
<li><strong>第 2 层</strong>：使用C1即时编译器编译执行，仅开启方法及回边次数统计等有限的性能监控；</li>
<li><strong>第 3 层</strong>：使用C1即时编译器编译执行，开启全部性能监控；</li>
<li><strong>第 4 层</strong>：使用C2即时编译器编译执行，并且会根据性能监控信息进行一些不可靠的激进优化。</li>
</ul>
<p>C1 编译器会对字节码进行简单可靠的优化，耗时短，以达到更快的编译速度</p>
<p>C2 编译器进行耗时较长的优化以及激进优化，优化的代码执行效率更高</p>
<p>实施分层编译后，解释器、C1编译器和C2编译器就会同时工作，可以用C1编译器获取更高的编译速度、用C2编译器来获取更好的编译质量。</p>
<h2 id="❺热点探测"><a href="#❺热点探测" class="headerlink" title="❺热点探测"></a>❺热点探测</h2><p>即时编译器编译的目标是 “热点代码”，它主要分为以下两类：</p>
<ul>
<li>被多次调用的方法。</li>
<li>被多次执行循环体。这里指的是一个方法只被少量调用过，但方法体内部存在循环次数较多的循环体，此时也认为是热点代码。但编译器编译的仍然是循环体所在的方法，而不会单独编译循环体。</li>
</ul>
<p>判断某段代码是否是热点代码的行为称为 “热点探测” （Hot Spot Code Detection），主流的热点探测方法有以下两种：</p>
<ul>
<li>**基于采样的热点探测 (Sample Based Hot Spot Code Detection)**：采用这种方法的虚拟机会周期性地检查各个线程的调用栈顶，如果发现某个（或某些）方法经常出现在栈顶，那么就认为它是 “热点方法”。</li>
<li>**基于计数的热点探测 (Counter Based Hot Spot Code Detection)**：采用这种方法的虚拟机会为每个方法（甚至是代码块）建立计数器，统计方法的执行次数，如果执行次数超过一定的阈值就认为它是 “热点方法”。</li>
</ul>
<p>HotSpot VM 采用的热点探测方式是基于计数器的热点探测，为每一个方法都建立 2 个不同类型的计数器：方法调用计数器（Invocation Counter）和回边计数器（BackEdge Counter）</p>
<ul>
<li><p>方法调用计数器：用于统计方法被调用的次数，默认阈值在 Client 模式 下是 1500 次，在 Server 模式下是 10000 次（需要进行激进的优化），超过这个阈值，就会触发 JIT 编译，阈值可以通过虚拟机参数 <code>-XX:CompileThreshold</code> 设置</p>
<p>工作流程：当一个方法被调用时， 会先检查该方法是否存在被 JIT 编译过的版本，存在则使用编译后的本地代码来执行；如果不存在则将此方法的调用计数器值加 1，然后判断方法调用计数器与回边计数器值之和是否超过方法调用计数器的阈值，如果超过阈值会向即时编译器<strong>提交一个该方法的代码编译请求</strong></p>
</li>
<li><p>回边计数器：统计一个方法中循环体代码执行的次数，在字节码中控制流向后跳转的指令称为回边</p>
<p>如果一个方法中的循环体需要执行多次，可以优化为为栈上替换，简称 OSR (On StackReplacement) 编译，<strong>OSR 替换循环代码体的入口，C1、C2 替换的是方法调用的入口</strong>，OSR 编译后会出现方法的整段代码被编译了，但是只有循环体部分才执行编译后的机器码，其他部分仍是解释执行</p>
</li>
</ul>
<h1 id="⑥代码优化"><a href="#⑥代码优化" class="headerlink" title="⑥代码优化"></a>⑥代码优化</h1><h2 id="❶语法糖"><a href="#❶语法糖" class="headerlink" title="❶语法糖"></a>❶语法糖</h2><p>语法糖：指 Java 编译器把 *.java 源码编译为 *.class 字节码的过程中，自动生成和转换的一些代码，主要是为了减轻程序员的负担</p>
<h3 id="构造器"><a href="#构造器" class="headerlink" title="构造器"></a>构造器</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 这个无参构造是编译器帮助我们加上的</span>
    <span class="token keyword">public</span> <span class="token function">Candy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 即调用父类 Object 的无参构造方法，即调用 java/lang/Object."&lt;init>":()V</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="拆装箱"><a href="#拆装箱" class="headerlink" title="拆装箱"></a>拆装箱</h3><p>这段代码在 JDK 5 之前是无法编译通过的</p>
<pre class="line-numbers language-java"><code class="language-java">Integer x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> y <span class="token operator">=</span> x<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>必须写成如下代码：</p>
<pre class="line-numbers language-java"><code class="language-java">Integer x <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//装箱</span>
<span class="token keyword">int</span> y <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//拆箱</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>JDK5 以后编译阶段自动转换成上述片段</p>
<h3 id="泛型擦除"><a href="#泛型擦除" class="headerlink" title="泛型擦除"></a>泛型擦除</h3><p>泛型也是在 JDK 5 开始加入的特性，但 Java 在编译泛型代码后会执行<strong>泛型擦除</strong>的动作，即泛型信息在编译为字节码之后就丢失了，实际的类型都<strong>当做了 Object 类型</strong>来处理：</p>
<pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 实际调用的是 List.add(Object e)</span>
Integer x <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 实际调用的是 Object obj = List.get(int index);</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>编译器真正生成的字节码中，还要额外做一个类型转换的操作：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 需要将 Object 转为 Integer</span>
Integer x <span class="token operator">=</span> <span class="token punctuation">(</span>Integer<span class="token punctuation">)</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>如果前面的 x 变量类型修改为 int 基本类型那么最终生成的字节码是：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 需要将 Object 转为 Integer, 并执行拆箱操作</span>
<span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Integer<span class="token punctuation">)</span>list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h3 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> args<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 直接赋值</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">foo</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可变参数 <code>String... args</code> 其实是 <code>String[] args</code> ， Java 编译器会在编译期间将上述代码变换为：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>注：如果调用了 <code>foo()</code> 则等价代码为 <code>foo(new String[]&#123;&#125;)</code> ，创建了一个空的数组，而不会传递 null 进去</p>
<h3 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a>foreach</h3><p>数组的循环：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 数组赋初值的简化写法也是语法糖</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> e <span class="token operator">:</span> array<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>编译后为循环取数：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> array<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> e <span class="token operator">=</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>集合的循环：</p>
<pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> list <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>Integer i <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>编译后转换为对迭代器的调用：</p>
<pre class="line-numbers language-java"><code class="language-java">List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> list <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Iterator iter <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span><span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Integer e <span class="token operator">=</span> <span class="token punctuation">(</span>Integer<span class="token punctuation">)</span>iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注：foreach 循环写法，能够配合数组以及所有实现了 Iterable 接口的集合类一起使用，其中 Iterable 用来获取集合的迭代器</p>
<h3 id="switch"><a href="#switch" class="headerlink" title="switch"></a>switch</h3><blockquote>
<p>switch 可以作用于字符串和枚举类：</p>
</blockquote>
<h4 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">switch</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">"hello"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token string">"world"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意：<strong>switch 配合 String 和枚举使用时，变量不能为 null</strong></p>
<p>会被编译器转换为：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">byte</span> x <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">switch</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">99162322</span><span class="token operator">:</span> <span class="token comment" spellcheck="true">// hello 的 hashCode</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">113318802</span><span class="token operator">:</span> <span class="token comment" spellcheck="true">// world 的 hashCode</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">switch</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"h"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>总结：</p>
<ul>
<li>执行了两遍 switch，第一遍是根据字符串的 hashCode 和 equals 将字符串的转换为相应 byte 类型，第二遍才是利用 byte 执行进行比较</li>
<li>hashCode 是为了提高效率，减少可能的比较；而 equals 是为了防止 hashCode 冲突</li>
</ul>
<h4 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h4><p>switch 枚举的例子，原始代码：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">enum</span> Sex <span class="token punctuation">{</span>
    MALE<span class="token punctuation">,</span> FEMALE
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span>Sex sex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>sex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> MALE<span class="token operator">:</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"男"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> FEMALE<span class="token operator">:</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"女"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>编译转换后的代码：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
* 定义一个合成类（仅 jvm 使用，对我们不可见）
* 用来映射枚举的 ordinal 与数组元素的关系
* 枚举的 ordinal 表示枚举对象的序号，从 0 开始
* 即 MALE 的 ordinal()=0，FEMALE 的 ordinal()=1
*/</span>
<span class="token keyword">static</span> <span class="token keyword">class</span> $MAP <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 数组大小即为枚举元素个数，里面存储 case 用来对比的数字</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        map<span class="token punctuation">[</span>Sex<span class="token punctuation">.</span>MALE<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        map<span class="token punctuation">[</span>Sex<span class="token punctuation">.</span>FEMALE<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span>Sex sex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> x <span class="token operator">=</span> $MAP<span class="token punctuation">.</span>map<span class="token punctuation">[</span>sex<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"男"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"女"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="枚举类"><a href="#枚举类" class="headerlink" title="枚举类"></a>枚举类</h3><p>JDK 7 新增了枚举类：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">enum</span> Sex <span class="token punctuation">{</span>
    MALE<span class="token punctuation">,</span> FEMALE
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>编译转换后：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Sex</span> <span class="token keyword">extends</span> <span class="token class-name">Enum</span><span class="token operator">&lt;</span>Sex<span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Sex MALE<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Sex FEMALE<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Sex<span class="token punctuation">[</span><span class="token punctuation">]</span> $VALUES<span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        MALE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sex</span><span class="token punctuation">(</span><span class="token string">"MALE"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FEMALE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sex</span><span class="token punctuation">(</span><span class="token string">"FEMALE"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        $VALUES <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sex</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>MALE<span class="token punctuation">,</span> FEMALE<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token function">Sex</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> ordinal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> ordinal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> Sex<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> $VALUES<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> Sex <span class="token function">valueOf</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Enum<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>Sex<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="try-w-r"><a href="#try-w-r" class="headerlink" title="try-w-r"></a>try-w-r</h3><p>JDK 7 开始新增了对需要关闭的资源处理的特殊语法 <code>try-with-resources</code>，格式：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">try</span><span class="token punctuation">(</span>资源变量 <span class="token operator">=</span> 创建资源对象<span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>其中资源对象需要实现 <strong>AutoCloseable</strong> 接口，例如 InputStream、OutputStream、Connection、Statement、ResultSet 等接口都实现了 AutoCloseable ，使用 try-withresources可以不用写 finally 语句块，编译器会帮助生成关闭资源代码：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">try</span><span class="token punctuation">(</span>InputStream is <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>转换成：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">try</span> <span class="token punctuation">{</span>
    InputStream is <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Throwable t <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// t 是我们代码出现的异常</span>
        t <span class="token operator">=</span> e1<span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 判断了资源不为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>is <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果我们代码有异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    is<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 如果 close 出现异常，作为被压制异常添加</span>
                    t<span class="token punctuation">.</span><span class="token function">addSuppressed</span><span class="token punctuation">(</span>e2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 如果我们代码没有异常，close 出现的异常就是最后 catch 块中的 e</span>
                is<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>addSuppressed(Throwable e)</code>：添加被压制异常，是为了防止异常信息的丢失（<strong>fianlly 中如果抛出了异常</strong>）</p>
<h3 id="方法重写"><a href="#方法重写" class="headerlink" title="方法重写"></a>方法重写</h3><p>方法重写时对返回值分两种情况：</p>
<ul>
<li>父子类的返回值完全一致</li>
<li>子类返回值可以是父类返回值的子类</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> Number <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token comment" spellcheck="true">// 子类m方法的返回值是Integer是父类m方法返回值Number的子类</span>
    <span class="token keyword">public</span> Integer <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>对于子类，Java 编译器会做如下处理：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">A</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> Integer <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 此方法才是真正重写了父类 public Number m() 方法</span>
    <span class="token keyword">public</span> synthetic bridge Number <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 调用 public Integer m()</span>
        <span class="token keyword">return</span> <span class="token function">m</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中桥接方法比较特殊，仅对 Java 虚拟机可见，并且与原来的 public Integer m() 没有命名冲突</p>
<h3 id="匿名内部类"><a href="#匿名内部类" class="headerlink" title="匿名内部类"></a>匿名内部类</h3><h4 id="无参优化"><a href="#无参优化" class="headerlink" title="无参优化"></a>无参优化</h4><p>源代码：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Runnable runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>转化后代码：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 额外生成的类</span>
<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Candy</span>$<span class="token number">1</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    Candy$<span class="token function">1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Runnable runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Candy</span>$<span class="token function">1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="带参优化"><a href="#带参优化" class="headerlink" title="带参优化"></a>带参优化</h4><p>引用局部变量的匿名内部类，源代码：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Runnable runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ok:"</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>转换后代码：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Candy</span>$<span class="token number">1</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> val$x<span class="token punctuation">;</span>
    Candy$<span class="token function">1</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>val$x <span class="token operator">=</span> x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ok:"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>val$x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Candy</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Runnable runnable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Candy</span>$<span class="token function">1</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>局部变量在底层创建为内部类的成员变量，必须是 final 的原因：</p>
<ul>
<li><p>在 Java 中方法调用是值传递的，在匿名内部类中对变量的操作都是基于原变量的副本，不会影响到原变量的值，所以<strong>原变量的值的改变也无法同步到副本中</strong></p>
</li>
<li><p>外部变量为 final 是在编译期以强制手段确保用户不会在内部类中做修改原变量值的操作，也是<strong>防止外部操作修改了变量而内部类无法随之变化</strong>出现的影响</p>
<p>在创建 <code>Candy$1 </code> 对象时，将 x 的值赋值给了 <code>Candy$1</code> 对象的 val 属性，x 不应该再发生变化了，因为发生变化，this.val$x 属性没有机会再跟着变化</p>
</li>
</ul>
<h3 id="反射优化"><a href="#反射优化" class="headerlink" title="反射优化"></a>反射优化</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Reflect1</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"foo..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        Method foo <span class="token operator">=</span> Reflect1<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d\t"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            foo<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        System<span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>foo.invoke 0 ~ 15 次调用的是 MethodAccessor 的实现类 <code>NativeMethodAccessorImpl.invoke0()</code>，本地方法执行速度慢；当调用到第 16 次时，会采用运行时生成的类 <code>sun.reflect.GeneratedMethodAccessor1</code> 代替</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// inflationThreshold 膨胀阈值，默认 15</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>numInvocations <span class="token operator">></span> ReflectionFactory<span class="token punctuation">.</span><span class="token function">inflationThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ReflectUtil<span class="token punctuation">.</span><span class="token function">isVMAnonymousClass</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MethodAccessorImpl acc <span class="token operator">=</span> <span class="token punctuation">(</span>MethodAccessorImpl<span class="token punctuation">)</span>
            <span class="token keyword">new</span> <span class="token class-name">MethodAccessorGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
            <span class="token function">generateMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           method<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           method<span class="token punctuation">.</span><span class="token function">getExceptionTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           method<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        parent<span class="token punctuation">.</span><span class="token function">setDelegate</span><span class="token punctuation">(</span>acc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 【调用本地方法实现】</span>
    <span class="token keyword">return</span> <span class="token function">invoke0</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> Object <span class="token function">invoke0</span><span class="token punctuation">(</span>Method m<span class="token punctuation">,</span> Object obj<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GeneratedMethodAccessor1</span> <span class="token keyword">extends</span> <span class="token class-name">MethodAccessorImpl</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 如果有参数，那么抛非法参数异常</span>
    block4 <span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arrobject <span class="token operator">==</span> null <span class="token operator">||</span> arrobject<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span> block4<span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 【可以看到，已经是直接调用方法】</span>
        Reflect1<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 因为没有返回值</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
   <span class="token comment" spellcheck="true">//....</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过查看 ReflectionFactory 源码可知：</p>
<ul>
<li>sun.reflect.noInflation 可以用来禁用膨胀，直接生成 GeneratedMethodAccessor1，但首次生成比较耗时，如果仅反射调用一次，不划算</li>
<li>sun.reflect.inflationThreshold 可以修改膨胀阈值</li>
</ul>
<h2 id="❷运行期优化-JIT优化"><a href="#❷运行期优化-JIT优化" class="headerlink" title="❷运行期优化(JIT优化)"></a>❷运行期优化(JIT优化)</h2><blockquote>
<p>即时编译器除了将字节码编译为本地机器码外，还会对代码进行一定程度的优化，它包含多达几十种优化技术，这里选取其中代表性的进行介绍：</p>
</blockquote>
<h3 id="逃逸分析"><a href="#逃逸分析" class="headerlink" title="逃逸分析"></a>逃逸分析</h3><p>逃逸分析并不是直接的优化手段，而是一个代码分析方式，通过动态分析对象的作用域，为优化手段如栈上分配、标量替换和同步消除等提供依据，发生逃逸行为的情况有两种：方法逃逸和线程逃逸</p>
<ul>
<li>方法逃逸：当一个对象在方法中定义之后，被外部方法引用<ul>
<li>全局逃逸：一个对象的作用范围逃出了当前方法或者当前线程，比如对象是一个静态变量、全局变量赋值、已经发生逃逸的对象、作为当前方法的返回值</li>
<li>参数逃逸：一个对象被作为方法参数传递或者被参数引用</li>
</ul>
</li>
<li>线程逃逸：如类变量或实例变量，可能被其它线程访问到</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> StringBuilder <span class="token function">concat</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> strings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>String string <span class="token operator">:</span> strings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sb<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 发生了方法逃逸</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">concat</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> strings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>String string <span class="token operator">:</span> strings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 没有发生方法逃逸</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果不存在逃逸行为，则可以对该对象进行如下优化：同步消除、标量替换和栈上分配</p>
<ul>
<li>**栈上分配 (Stack Allocations)**：如果一个对象不会逃逸到线程外，那么将会在栈上分配内存来创建这个对象，而不是 Java 堆上，此时对象所占用的内存空间就会随着栈帧的出栈而销毁，从而可以减轻垃圾回收的压力。</li>
<li>**标量替换 (Scalar Replacement)**：如果一个数据已经无法再分解成为更小的数据类型，那么这些数据就称为标量（如 int、long 等数值类型及 reference 类型等）；反之，如果一个数据可以继续分解，那它就被称为聚合量（如对象）。如果一个对象不会逃逸外方法外，那么就可以将其改为直接创建若干个被这个方法使用的成员变量来替代，从而减少内存占用。<ul>
<li><code>-XX:+EliminateAllocations</code>：开启标量替换</li>
<li><code>-XX:+PrintEliminateAllocations</code>：查看标量替换情况</li>
</ul>
</li>
<li><strong>同步消除 (Synchronization Elimination)<strong>：线程同步本身比较耗时，如果确定一个对象不会逃逸出线程，不被其它线程访问到，那对象的读写就不会存在竞争，则可以消除对该对象的</strong>同步锁</strong>，通过 <code>-XX:+EliminateLocks</code> 可以开启同步消除 ( - 号关闭)</li>
</ul>
<h3 id="方法内联"><a href="#方法内联" class="headerlink" title="方法内联"></a>方法内联</h3><p>方法内联：<strong>将调用的函数代码编译到调用点处</strong>，这样可以减少栈帧的生成，减少参数传递以及跳转过程</p>
<p>方法内联能够消除方法调用的固定开销，任何方法除非被内联，否则调用都会有固定开销，来源于保存程序在该方法中的执行位置，以及新建、压入和弹出新方法所使用的栈帧。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> i <span class="token operator">*</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">square</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>square 是热点方法，会进行内联，把方法内代码拷贝粘贴到调用者的位置：</p>
<pre class="line-numbers language-java"><code class="language-java">System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">9</span> <span class="token operator">*</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>还能够进行常量折叠（constant folding）的优化：</p>
<pre class="line-numbers language-java"><code class="language-java">System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">81</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><p>冗余消除：根据运行时状况进行代码折叠或削除</p>
</li>
<li><p>内联缓存：是一种加快动态绑定的优化技术（方法调用部分详解）</p>
</li>
</ul>
<h3 id="公共子表达式消除"><a href="#公共子表达式消除" class="headerlink" title="公共子表达式消除"></a>公共子表达式消除</h3><p>如果一个表达式 E 之前已经被计算过了，并且从先前的计算到现在 E 中所有变量的值都没有发生过变化，那么 E 这次的出现就称为公共子表达式。对于这种表达式，无需再重新进行计算，只需要直接使用前面的计算结果即可。</p>
<h3 id="数组边界检查消除"><a href="#数组边界检查消除" class="headerlink" title="数组边界检查消除"></a>数组边界检查消除</h3><p>对于虚拟机执行子系统来说，每次数组元素的读写都带有一次隐含的上下文检查以避免访问越界。如果数组的访问发生在循环之中，并且使用循环变量来访问数据，即循环变量的取值永远在 [0，list.length) 之间，那么此时就可以消除整个循环的数据边界检查，从而避免多次无用的判断。</p>
<h1 id="⑦性能监控-amp-调优"><a href="#⑦性能监控-amp-调优" class="headerlink" title="⑦性能监控&amp;调优"></a>⑦性能监控&amp;调优</h1><h2 id="❶监控-amp-诊断工具"><a href="#❶监控-amp-诊断工具" class="headerlink" title="❶监控&amp;诊断工具"></a>❶监控&amp;诊断工具</h2><h3 id="命令行工具"><a href="#命令行工具" class="headerlink" title="命令行工具"></a>命令行工具</h3><blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://tobebetterjavaer.com/jvm/problem-tools.html#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4">Java问题诊断和排查工具</a></p>
</blockquote>
<p><img src="/../images/Java-JVM/problem-tools-01.png"></p>
<ul>
<li><p>jps：查看正在运行的Java进程</p>
</li>
<li><p>jstat：查看JVM统计信息</p>
</li>
<li><p>jinfo：实时查看和修改JVM配置参数</p>
</li>
<li><p>jmap：导出内存映像文件&amp;内存使用情况</p>
</li>
<li><p>jhat：JDK自带堆分析工具</p>
</li>
<li><p>jstack：打印JVM中线程快照</p>
</li>
<li><p>jcmd：多功能命令行，可以用来实现前面除了jstat之外所有命令的功能</p>
</li>
<li><p>jstatd：远程主机信息收集</p>
</li>
</ul>
<h3 id="GUI工具"><a href="#GUI工具" class="headerlink" title="GUI工具"></a>GUI工具</h3><blockquote>
<p>参考：<a target="_blank" rel="noopener" href="https://www.yuque.com/u21195183/jvm/lv1zot#KYSGY">JVM监控及诊断工具-GUI篇</a></p>
</blockquote>
<h4 id="JConsole"><a href="#JConsole" class="headerlink" title="JConsole"></a>JConsole</h4><p>从Java5开始，在JDK中自带的Java监控和管理控制台。用于对JVM中内存、线程和类等的监控。</p>
<h4 id="Visual-VM"><a href="#Visual-VM" class="headerlink" title="Visual VM"></a>Visual VM</h4><p>多功能的监测工具，可以连续监测，集成了多个JDK命令行工具，用于显示虚拟机进程及进程的配置和环境信息（jps，jinfo），监视应用程序的CPU、GC、堆、方法区及线程的信息（jstat、jstack）等，甚至代替JConsole。</p>
<ul>
<li><p>官网：<a target="_blank" rel="noopener" href="https://visualvm.github.io/">VisualVM: Home</a></p>
</li>
<li><p>教程：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1PJ411n7xZ?p=322&vd_source=fa98a6d1417d05689c64bc1449966321">VisualVM的安装及连接方式</a></p>
</li>
</ul>
<h4 id="JProfiler"><a href="#JProfiler" class="headerlink" title="JProfiler"></a>JProfiler</h4><p>主要功能：</p>
<p>1-方法调用：对方法调用的分析可以帮助您了解应用程序正在做什么，并找到提高其性能的方法</p>
<p>2-内存分配：通过分析堆上对象、引用链和垃圾收集能帮您修复内存泄露问题，优化内存使用</p>
<p>3-线程和锁：JProfiler提供多种针对线程和锁的分析视图助您发现多线程问题</p>
<p>4-高级子系统：许多性能问题都发生在更高的语义级别上。例如，对于JDBC调用，您可能希望找出执行最慢的SQL语句。JProfiler支持对这些子系统进行集成分析</p>
<ul>
<li><p>官网：<a target="_blank" rel="noopener" href="https://www.ej-technologies.com/products/jprofiler/overview.html">Java Profiler - JProfiler (ej-technologies.com)</a></p>
</li>
<li><p>教程：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1PJ411n7xZ?p=340&vd_source=fa98a6d1417d05689c64bc1449966321">JProfiler的使用概述</a></p>
</li>
</ul>
<h4 id="Arthas"><a href="#Arthas" class="headerlink" title="Arthas"></a>Arthas</h4><p>Arthas是Alibaba开源的Java诊断工具</p>
<h4 id="HSDB"><a href="#HSDB" class="headerlink" title="HSDB"></a>HSDB</h4><p>JDK自带的工具，用于查看JVM运行时的状态</p>
<pre class="line-numbers language-bash"><code class="language-bash">java -cp /Library/Java/JavaVirtualMachines/jdk1.8.0_351.jdk/Contents/Home/lib/sa-jdi.jar sun.jvm.hotspot.HSDB
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="❷JVM运行时参数"><a href="#❷JVM运行时参数" class="headerlink" title="❷JVM运行时参数"></a>❷JVM运行时参数</h2><p>JVM参数⼤致可以分为三类：</p>
<ol>
<li><p>标注指令： -开头，所有的JVM实现都必须实现这些参数的功能，而且向后兼容。可以⽤ java -help 打印出来。</p>
</li>
<li><p>⾮标准指令： -X开头，默认jvm实现这些参数的功能，但是并不保证所有jvm实现都满足，且不保证向后兼容。可以⽤ java -X 打印出来。</p>
</li>
<li><p>非稳定参数： -XX 开头，此类参数各个jvm实现会有所不同，将来可能会随时取消，需要慎重使用；</p>
<pre class="line-numbers language-java"><code class="language-java">java <span class="token operator">-</span>XX<span class="token operator">:</span><span class="token operator">+</span>PrintCommandLineFlags  <span class="token comment" spellcheck="true">// 查看当前JVM的不稳定指令。</span>

java <span class="token operator">-</span>XX<span class="token operator">:</span><span class="token operator">+</span>PrintFlagsInitial     <span class="token comment" spellcheck="true">// 查看所有不稳定指令的默认值。</span>

java <span class="token operator">-</span>XX<span class="token operator">:</span><span class="token operator">+</span>PrintFlagsFinal       <span class="token comment" spellcheck="true">// 查看所有不稳定指令最终⽣效的实际值。</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<ul>
<li><p>设置堆内存指令：<code>-Xmx Size</code></p>
</li>
<li><p>设置栈内存大小：<code>-Xss size</code>   </p>
</li>
<li><p><code>-XX:StringTableSize=个数</code> StringTable桶个数</p>
</li>
<li><p><code>-XX:MaxTenuringThreshold</code>：定义年龄的阈值，默认是 15</p>
</li>
<li><p><code>-XX:PretenureSizeThreshold</code>：大于此值的对象直接在老年代分配</p>
</li>
<li><p><code>-XX:MaxMetaspaceSize=size</code>	元空间大小设置	</p>
</li>
<li><p><code>-XX:MaxTenuringThreshold</code> 调大对象进入老年代的年龄，让对象在新生代多存活一段时间</p>
</li>
</ul>
<ul>
<li><p><code>-XX:UseTLAB</code>：设置是否开启 TLAB 空间</p>
</li>
<li><p><code>-XX:TLABWasteTargetPercent</code>：设置 TLAB 空间所占用 Eden 空间的百分比大小，默认情况下 TLAB 空间的内存非常小，仅占有整个 Eden 空间的1%</p>
</li>
<li><p><code>-XX:TLABRefillWasteFraction</code>：指当 TLAB 空间不足，请求分配的对象内存大小超过此阈值时不会进行 TLAB 分配，直接进行堆内存分配，否则还是会优先进行 TLAB 分配</p>
</li>
<li><p><code>-XX:+EliminateAllocations</code>：开启标量替换</p>
</li>
<li><p><code>-XX:+PrintEliminateAllocations</code>：查看标量替换情况</p>
</li>
</ul>
<ul>
<li>-XX:PremSize：设置永久代的初始大小</li>
<li>-XX:MaxPermSize: 设置永久代的最大值</li>
</ul>
<p><em>含义参数</em></p>
<p><em>堆初始大小-Xms</em></p>
<p><em>堆最大大小-Xmx 或 -XX:MaxHeapSize&#x3D;size</em></p>
<p><em>新生代大小-Xmn 或 (-XX:NewSize&#x3D;size + -XX:MaxNewSize&#x3D;size )</em></p>
<p><em>幸存区比例（动态） -XX:InitialSurvivorRatio&#x3D;ratio 和 -XX:+UseAdaptiveSizePolicy</em></p>
<p><em>幸存区比例-XX:SurvivorRatio&#x3D;ratio</em></p>
<p><em>晋升阈值-XX:MaxTenuringThreshold&#x3D;threshold</em></p>
<p><em>晋升详情-XX:+PrintTenuringDistribution</em></p>
<p><em>GC详情-XX:+PrintGCDetails -verbose:gc</em></p>
<p><em>FullGC 前 MinorGC -XX:+ScavengeBeforeFullGC</em></p>
<h2 id="❸GC日志"><a href="#❸GC日志" class="headerlink" title="❸GC日志"></a>❸GC日志</h2><h1 id="📚参考资料"><a href="#📚参考资料" class="headerlink" title="📚参考资料"></a>📚参考资料</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43715214/article/details/126694782">Java虚拟机（JVM）面试专题 上</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_50280576/article/details/113742011">黑马JVM 学习笔记</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.yuque.com/u21195183/jvm/qpoa81">尚硅谷JVM学习笔记</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_32265569/article/details/107575286">黑马JVM学习笔记</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/Seazean/JavaNote">Seazean&#x2F;JavaNote: </a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://wangwren.com/2019/11/JVM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/#JVM%E7%9A%84%E8%BF%90%E8%A1%8C%E5%8E%9F%E7%90%86">JVM的运行原理</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/12544c0ad5c1">三色标记法与读写屏障 - 简书 (jianshu.com)</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/doocs/jvm">Java 虚拟机底层原理知识总结</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://tobebetterjavaer.com/jvm/zongjie.html#%E5%85%AB%E3%80%81%E4%BB%A3%E7%A0%81%E4%BC%98%E5%8C%96">JVM 核心知识点总结</a></p>
</li>
</ul>
<h1 id="❤️Sponsor"><a href="#❤️Sponsor" class="headerlink" title="❤️Sponsor"></a>❤️Sponsor</h1><p>您的支持是我不断前进的动力，如果您感觉本文对您有所帮助的话，可以考虑打赏一下本文，用以维持本博客的运营费用，拒绝白嫖，从你我做起！🥰🥰🥰</p>
<table>
  <tbody>
     <tr>
         <td style="text-align:center;">支付宝</td>
         <td style="text-align:center;">微信</td>
     </tr>
   <tr>
    <td style="text-align:center;" ><img width="200" src="https://jwt1399.top/medias/reward/alipay.png"></td>    
      <td style="text-align:center;"><img width="200" src="https://jwt1399.top/medias/reward/sponor_wechat.png"></td>     
  </tr>
</tbody></table>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jwt1399.top" rel="external nofollow noreferrer">简简</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://jwt1399.top/posts/14485.html">https://jwt1399.top/posts/14485.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://jwt1399.top" target="_blank">简简</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/JVM/">
                                    <span class="chip bg-color">JVM</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,linkedin,facebook,twitter,google,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">打</a>
	<a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>
    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        /*max-width: 100%;*/
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
    .v[data-class=v] .vinput {
     padding: 0px 0px;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论<center>填上邮箱会收到评论回复提醒哦!!!</center></span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/valine/1.4.18/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'Awf92dhT3VWqTfENqbCDoqbA-gzGzoHsz',
        appKey: '9uN7ODvigK9GAp8CYBz0fOrX',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'true' === 'true',
        avatar: '',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '[填上邮箱，会给你发送评论提醒]，ヾﾉ≧∀≦)o 请畅所欲言~',
        enableQQ: true,
        boolean: true,
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/3092.html">
                    <div class="card-image">
                        
                        <img src="https://img.jwt1399.top/img/202212062044543.jpg" class="responsive-img" alt="Java-JUC">
                        
                        <span class="card-title">Java-JUC</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            JUC是java.util.concurrent包的简称，在Java5添加，目的就是为了更好的支持高并发任务。让开发者进行多线程编程时减少竞争条件和死锁的问题！
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-12-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/JavaSE/" class="post-category">
                                    JavaSE
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/JUC/">
                        <span class="chip bg-color">JUC</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/50902.html">
                    <div class="card-image">
                        
                        <img src="https://img.jwt1399.top/img/202211072341037.awebp" class="responsive-img" alt="Java-设计模式">
                        
                        <span class="card-title">Java-设计模式</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            ⓪设计模式基础❶设计模式分类
创建型模式

用于描述对象实例化（创建对象）的模式，即用于解耦对象的实例化过程
GoF（四人组）书中提供了单例、原型、工厂方法、抽象工厂、建造者等 5 种创建型模式。

结构型模式

用于描述如何把类或对象结合
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-11-07
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/JavaSE/" class="post-category">
                                    JavaSE
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">
                        <span class="chip bg-color">设计模式</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('100')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 简言之<br />'
            + '文章作者: 简简<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

    
<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->

<style type="text/css">
code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }
</style>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('2'),
            headingSelector: 'h1, h2, h3, h4, h5, h6'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5, h6').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


    <footer class="page-footer bg-color">
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2019</span>
            <a href="https://jwt1399.top" target="_blank"><b>简简</b>&nbsp;|&nbsp;Sponsored by</a>
            <!-- <span>|&nbsp;为 💗💞🩷 发电</span> -->
            <!-- |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> -->
            <!-- |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;| -->

			
            <a target="_blank" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"><img no-lazy src="https://img.jwt1399.top/img/20200824181422.png" style="width: 47px; vertical-align: middle;" ></a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;Word:&nbsp;<span
                class="white-color">1146.1k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;PV:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;UV:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>

            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2019";
                    var startMonth = "7";
                    var startDate = "2";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            <a href="https://search.google.com/search-console?resource_id=http%3A%2F%2Fjwt1399.top%2F" target="_blank"
                rel="nofollow noopener">谷歌统计</a>&nbsp;|
            
            <span id="icp"><img no-lazy src="/medias/icp.png" style="vertical-align: text-bottom;" />
                <a href="http://www.beian.miit.gov.cn/" target="_blank">蜀ICP备19020450号</a>
            </span>
            |
            
            <a href="https://tongji.baidu.com/web/10000159136/overview/index?siteId=14519996" target="_blank"
                rel="nofollow noopener">百度统计</a>

        </div>
        <div class="col s12 m4 l4 social-link social-statis">

    <a href="https://jwt1399.top/baidusitemap.xml" class="tooltipped" target="_blank" data-tooltip="访问我的sitemap" data-position="top" data-delay="50">
        <i class="fas fa-sitemap"></i>
    </a>


    <a href="https://pl.jwt1399.top" class="tooltipped" target="_blank" data-tooltip="valine评论: https://pl.jwt1399.top" data-position="top" data-delay="50">
        <i class="fab fa-optin-monster"></i>
    </a>


    <a href="mailto:1019084218@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope"></i>
    </a>













    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1019084218" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1019084218" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>


    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>
<!-- Algolia搜索 -->
<!-- <script type="text/javascript">
    // 初始化Algolia搜索客户端
    const searchClient = algoliasearch('E9ZV23QUNX', '091fe3a39a7bcb639aebaab3ed078165');
    const index = searchClient.initIndex('hexo_search');

    // 搜索函数
    const searchFunc = function(search_id, content_id) {
        const $input = document.getElementById(search_id);
        const $resultContent = document.getElementById(content_id);
        $input.addEventListener('input', function() {
            const query = this.value.trim();
            $resultContent.innerHTML = "";

            if (query.length > 0) {
                index.search(query).then(({ hits }) => {
                    let str = '<ul class="search-result-list">';
                    hits.forEach(hit => {
                        str += `<li>
                            <a href="${hit.permalink}" class="search-result-title">${hit.title}</a>
                        </li>`;
                    });
                    str += '</ul>';
                    $resultContent.innerHTML = str;
                }).catch(err => {
                    console.error(err);
                });
            }
        });
    };

    // 调用搜索函数
    searchFunc('searchInput', 'searchResult');

     // 初始化 Materialize CSS 的 modal
     document.addEventListener('DOMContentLoaded', function() {
        M.Modal.init(document.querySelectorAll('.modal'));
    });
</script> -->

<!-- <script type="text/javascript">
    docsearch({
    appId: "P70KOYK3UD",
    apiKey: "e555715ec4df8ee633f8644bf8f2326a",
    indexName: "jwt1399",
    container: "#docsearch",
    debug: false 
    });
    </script> -->

<!-- 老版搜索 -->
<script src="/js/search_old.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.json", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.staticfile.org/aos/3.0.0-beta.6/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>
	<!--valine_人机验证-->
	<button id="TencentCaptcha"data-appid="2046265119"data-cbfn="callback"type="button" hidden></button>
	
    <!-- Global site tag (gtag.js) - Google Analytics -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-160042502-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'UA-160042502-1');
</script>


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?0e306ce3426983ae6367d094d39f1190";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

        
</body>

</html>
